<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoKreGaM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK Imports for HTML -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (will be provided by Canvas runtime or default)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app;
        let db;
        let auth;
        let currentUserId = null; // To store the current user's ID
        let currentUserData = {}; // To store the current user's profile data

        // Global functions for Firebase (to be accessible from the main script)
        window.firebaseApp = null;
        window.firestoreDb = null;
        window.firebaseAuth = null;
        window.getCurrentUserId = () => currentUserId;
        window.saveUserDataToFirestore = async (data) => {
            if (!currentUserId || !db) {
                console.warn("User not authenticated or Firestore not initialized. Cannot save data.");
                return;
            }
            // Path for private user data: /artifacts/{appId}/users/{userId}/profile/data
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                await setDoc(userDocRef, data, { merge: true }); // Use merge: true to update existing fields
                console.log("User data saved successfully to Firestore!");
                currentUserData = { ...currentUserData, ...data }; // Update local cache
            } catch (e) {
                console.error("Error saving user data to Firestore: ", e);
            }
        };

        window.loadUserDataFromFirestore = async () => {
            if (!currentUserId || !db) {
                console.warn("User not authenticated or Firestore not initialized. Cannot load data.");
                return null;
            }
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("User data loaded from Firestore:", data);
                    currentUserData = data; // Cache loaded data
                    return data;
                } else {
                    console.log("No user data found for this user. Initializing default.");
                    const defaultData = { xp: 0, level: 1, friends: [], gold: 0, avatar: 'https://placehold.co/80x80/cccccc/000000?text=👤' };
                    await window.saveUserDataToFirestore(defaultData); // Save default data
                    currentUserData = defaultData;
                    return defaultData;
                }
            } catch (e) {
                console.error("Error loading user data from Firestore: ", e);
                return null;
            }
        };

        window.addPostToFirestore = async (postData) => {
            if (!currentUserId || !db) {
                console.warn("User not authenticated or Firestore not initialized. Cannot add post.");
                return false;
            }
            // Path for public posts: /artifacts/{appId}/public/posts
            const postsCollectionRef = collection(db, `artifacts/${appId}/public/posts`);
            try {
                await addDoc(postsCollectionRef, {
                    ...postData,
                    userId: currentUserId,
                    timestamp: new Date()
                });
                console.log("Post added successfully to Firestore!");
                return true;
            } catch (e) {
                console.error("Error adding post to Firestore: ", e);
                return false;
            }
        };

        window.getPostsFromFirestore = (callback) => {
            if (!db) {
                console.warn("Firestore not initialized. Cannot get posts.");
                return () => {}; // Return a dummy unsubscribe function
            }
            const postsCollectionRef = collection(db, `artifacts/${appId}/public/posts`);
            const q = query(postsCollectionRef); // No orderBy to avoid index issues

            // Listen for real-time updates
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort posts by timestamp in JS after fetching
                posts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                callback(posts);
            }, (error) => {
                console.error("Error getting posts from Firestore: ", error);
            });
            return unsubscribe; // Return unsubscribe function
        };

        // Initialize Firebase and set up authentication
        async function initializeFirebaseAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                window.firebaseApp = app;
                window.firestoreDb = db;
                window.firebaseAuth = auth;

                // Sign in anonymously or with custom token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Auth state changed. User ID:", currentUserId);
                        // Load user data once authenticated
                        const userData = await window.loadUserDataFromFirestore();
                        if (userData) {
                            // Update UI with loaded data
                            if (window.updateProfileUI) { // Check if main script is loaded
                                window.updateProfileUI(userData);
                            }
                            // Also ensure posts and friends are loaded/listened to
                            if (window.loadAllPosts) window.loadAllPosts();
                            if (window.loadFriendsList) window.loadFriendsList();
                        }
                    } else {
                        currentUserId = null;
                        console.log("User logged out or not authenticated.");
                        // Clear user data from UI and show login
                        if (window.showSection) window.showSection(document.getElementById('loginSection'));
                        if (window.clearProfileUI) window.clearProfileUI();
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                // Display an error message to the user if auth fails
                const loginError = document.getElementById('loginError');
                if (loginError) loginError.textContent = 'Error connecting to service. Please try again later.';
                if (window.showSection) window.showSection(document.getElementById('loginSection'));
            }
        }

        // Call initializeFirebaseAndAuth when the window loads
        window.addEventListener('load', initializeFirebaseAndAuth);
    </script>
    <style>
        /* Global Styles */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as per instructions */
            margin: 0;
            padding: 0;
            background-color: #f7fafc; /* Light background */
            color: #2d3748; /* Dark text */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Styles */
        header {
            background-color: #2d3748; /* Dark blue-gray */
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* Deeper shadow */
            flex-wrap: wrap;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            position: sticky; /* Make header sticky */
            top: 0;
            z-index: 100; /* Ensure it's above other content */
        }

        header h1 {
            margin: 0;
            font-size: 2em; /* Larger title */
            color: #63b3ed; /* Light blue */
            font-weight: 800; /* Extra bold */
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-controls button,
        .header-controls select {
            padding: 10px 18px; /* More padding */
            border: none;
            border-radius: 8px; /* More rounded */
            cursor: pointer;
            background-color: #4a5568; /* Slightly lighter dark */
            color: white;
            font-weight: 600; /* Semi-bold */
            transition: background-color 0.3s ease-in-out, transform 0.1s ease-in-out;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-controls button:hover,
        .header-controls select:hover {
            background-color: #2c3748; /* Even darker on hover */
            transform: translateY(-1px);
        }

        /* Main Content Area */
        main {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%; /* Ensure main takes full width */
            box-sizing: border-box;
        }

        /* Section Containers */
        section {
            background-color: white;
            padding: 30px; /* More padding */
            border-radius: 16px; /* Very rounded corners */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); /* Stronger, softer shadow */
            width: 100%;
            max-width: 700px; /* Wider default sections */
            box-sizing: border-box;
            margin-bottom: 30px; /* More margin below sections */
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        section.hidden {
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }
        section:not(.hidden) {
            opacity: 1;
            transform: translateY(0);
        }


        h2 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2em;
            font-weight: 700;
        }

        /* Form Styles */
        form {
            display: flex;
            flex-direction: column;
            gap: 18px; /* More space between form elements */
        }

        form label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
            color: #4a5568;
            font-size: 1.1em;
        }

        form input[type="text"],
        form input[type="password"],
        form input[type="email"],
        form input[type="date"],
        form select,
        form textarea {
            width: calc(100% - 24px); /* Adjust for padding and border */
            padding: 12px; /* More padding */
            border: 1px solid #cbd5e0;
            border-radius: 10px; /* Very rounded inputs */
            font-size: 1.1em;
            margin-top: 5px;
            box-sizing: border-box;
            background-color: #edf2f7; /* Light background for inputs */
            color: #2d3748;
        }

        form button {
            padding: 12px 25px; /* More padding */
            background-color: #4299e1; /* Tailwind blue */
            color: white;
            border: none;
            border-radius: 10px; /* Very rounded buttons */
            cursor: pointer;
            font-size: 1.2em; /* Larger font */
            font-weight: 700;
            transition: background-color 0.3s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        form button:hover {
            background-color: #3182ce; /* Darker blue on hover */
            transform: translateY(-2px); /* More pronounced lift */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .error-message {
            color: #e53e3e;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .success-message {
            color: #38a169;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .link-text {
            text-align: center;
            margin-top: 20px;
        }

        .link-text a, .link-text button {
            color: #4299e1;
            text-decoration: none;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            font-size: 1.1em;
            transition: color 0.2s ease-in-out;
            font-weight: 600;
        }

        .link-text a:hover, .link-text button:hover {
            color: #3182ce;
        }

        /* Avatars for Signup */
        #avatarsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px; /* More space */
            margin-bottom: 25px;
            justify-items: center;
        }

        .avatar {
            border: 3px solid transparent; /* Thicker border */
            border-radius: 12px;
            padding: 8px; /* More padding */
            cursor: pointer;
            text-align: center;
            transition: border-color 0.3s ease-in-out, background-color 0.3s ease-in-out, box-shadow 0.2s;
            background-color: #edf2f7;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .avatar img {
            width: 90px; /* Larger avatar images */
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            display: block;
            margin: 0 auto 8px; /* More margin */
            border: 2px solid #cbd5e0; /* Inner border */
        }

        .avatar.selected {
            border-color: #4299e1;
            background-color: #ebf8ff;
            box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.6); /* Stronger blue glow */
            transform: scale(1.05); /* Slight enlarge */
        }

        /* Profile Section Specific Styles */
        #profileSection {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1000px; /* Wider for tabs and content */
        }

        #profileHeader {
            display: flex;
            align-items: center;
            gap: 30px; /* More space */
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
            justify-content: center;
            text-align: center;
        }

        #profileAvatar img {
            width: 120px; /* Larger profile avatar */
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #4299e1; /* Thicker border */
            box-shadow: 0 0 0 6px rgba(66, 153, 225, 0.3);
        }

        #profileInfo {
            flex-grow: 1;
        }

        #profileInfo p {
            margin: 8px 0; /* More margin */
            font-size: 1.2em; /* Larger font */
        }

        #profileInfo p strong {
            color: #4299e1;
        }

        #profileStats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; /* More space */
            margin-top: 15px;
            justify-content: center;
        }

        #profileStats div {
            background-color: #ebf8ff;
            padding: 10px 15px; /* More padding */
            border-radius: 8px;
            font-size: 1em;
            color: #2b6cb0;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* Tabs Navigation */
        #tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* More space between tabs */
            margin-bottom: 25px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
            justify-content: center;
            background-color: #f7fafc; /* Tab background */
            border-radius: 12px 12px 0 0;
            padding-top: 10px;
        }

        #tabs button {
            background-color: #edf2f7;
            color: #555;
            padding: 12px 20px; /* More padding */
            border: 1px solid #cbd5e0;
            border-bottom: none;
            border-radius: 10px 10px 0 0; /* More rounded top corners */
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, border-color 0.3s ease-in-out;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        #tabs button.active {
            background-color: white;
            color: #4299e1;
            border-color: #4299e1;
            border-bottom: 2px solid white;
            position: relative;
            z-index: 1;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* Tab Content Area */
        .tabContent {
            background-color: white;
            padding: 30px; /* More padding */
            border-radius: 0 0 16px 16px; /* Match bottom corners of section */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Ranking Tab */
        #rankingTypeButtons {
            text-align: center;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px; /* More space */
        }

        #rankingTypeButtons button {
            padding: 10px 18px;
            border: 1px solid #4299e1;
            border-radius: 8px;
            background-color: white;
            color: #4299e1;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        #rankingTypeButtons button.active {
            background-color: #4299e1;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #rankingTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #rankingTable th, #rankingTable td {
            border: 1px solid #e2e8f0;
            padding: 12px 15px; /* More padding */
            text-align: left;
            word-break: break-word;
            font-size: 1.05em;
        }

        #rankingTable th {
            background-color: #f0f4f8; /* Lighter gray */
            font-weight: bold;
            color: #4a5568;
            text-transform: uppercase;
        }

        #rankingTable tbody tr:nth-child(even) {
            background-color: #edf2f7;
        }

        #rankingTable tbody tr:hover {
            background-color: #e0f7fa;
            transform: scale(1.01);
            transition: transform 0.1s ease-in-out;
        }

        #rankingTable td button.report-user-btn {
            background-color: #fbd38d; /* Tailwind orange */
            color: #2d3748;
            border: none;
            padding: 6px 12px; /* More padding */
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 12px;
            transition: background-color 0.3s ease-in-out, transform 0.1s ease-in-out;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }
        #rankingTable td button.report-user-btn:hover {
            background-color: #f6ad55;
            transform: translateY(-1px);
        }


        /* Posts tab */
        #writePostSection {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
        }

        #postContent {
            resize: vertical;
            min-height: 100px; /* Taller textarea */
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            background-color: #edf2f7;
            color: #2d3748;
        }

        #publishPostBtn {
            width: auto;
            align-self: flex-end;
            margin-top: 10px;
            background-color: #48bb78; /* Green for publish */
        }
        #publishPostBtn:hover {
            background-color: #38a169;
        }

        .post {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px; /* More padding */
            margin-bottom: 20px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .post-avatar img {
            width: 50px; /* Larger post avatar */
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 2px solid #cbd5e0;
        }

        .post-info {
            flex-grow: 1;
        }

        .post-author {
            font-weight: bold;
            color: #4299e1;
            font-size: 1.1em;
        }

        .post-time {
            font-size: 0.9em;
            color: #718096;
        }

        .post-content {
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #4a5568;
            font-size: 1.05em;
        }

        /* All Chats Section for Guest */
        #allChatsSection {
            text-align: center;
        }

        #chatsContent {
            margin-top: 25px;
            border-top: 1px solid #e2e8f0;
            padding-top: 25px;
            max-height: 500px; /* Taller chat area */
            overflow-y: auto;
            background-color: #edf2f7;
            border-radius: 12px;
            padding: 15px;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
        }

        .chat-container {
            border: 1px solid #cbd5e0;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 18px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chat-header {
            font-weight: bold;
            margin-bottom: 12px;
            color: #2b6cb0;
            border-bottom: 1px dashed #bee3f8;
            padding-bottom: 8px;
            font-size: 1.15em;
        }

        .chat-message {
            margin-bottom: 8px;
            font-size: 1em;
            color: #4a5568;
        }
        .chat-message strong {
            color: #2d3748;
        }

        /* Friends Tab */
        .friends-search {
            display: flex;
            gap: 15px; /* More space */
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .friends-search input {
            flex-grow: 1;
            min-width: 150px;
        }

        .friends-search button {
            flex-shrink: 0;
            width: auto;
            padding: 12px 25px;
        }

        .user-list {
            max-height: 350px; /* Taller list */
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            background-color: #edf2f7;
        }

        .user-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px; /* More padding */
            border-bottom: 1px solid #f0f4f8;
            font-size: 1.1em;
        }

        .user-card:last-child {
            border-bottom: none;
        }

        .user-card span {
            font-weight: bold;
            color: #333;
        }

        .user-card button {
            background-color: #48bb78;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background-color 0.3s ease-in-out;
            width: auto;
        }

        .user-card button:hover:not(:disabled) {
            background-color: #38a169;
        }

        .user-card button:disabled {
            background-color: #cbd5e0;
            cursor: not-allowed;
        }

        .my-friends ul {
            list-style: none;
            padding: 0;
        }

        .my-friends li {
            background-color: #ebf8ff;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #2b6cb0;
            font-weight: bold;
            font-size: 1.1em;
        }
        .my-friends li:last-child {
            margin-bottom: 0;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease-in-out;
        }

        .modal.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interactions when hidden */
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border: 1px solid #a0aec0;
            border-radius: 16px;
            width: 90%;
            max-width: 550px; /* Slightly wider modal */
            position: relative;
            box-shadow: 0 12px 30px rgba(0,0,0,0.3); /* Stronger shadow */
            animation-name: animatetop;
            animation-duration: 0.4s;
            box-sizing: border-box;
        }

        /* Add Animation */
        @-webkit-keyframes animatetop {
            from {top:-300px; opacity:0}
            to {top:0; opacity:1}
        }

        @keyframes animatetop {
            from {top:-300px; opacity:0}
            to {top:0; opacity:1}
        }

        .close-button {
            color: #718096;
            font-size: 32px; /* Larger close button */
            font-weight: bold;
            position: absolute;
            right: 18px; /* More padding */
            top: 15px; /* More padding */
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }

        .close-button:hover,
        .close-button:focus {
            color: #2d3748;
            text-decoration: none;
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 1.8em;
        }

        .modal-content form label {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            font-weight: normal;
            font-size: 1.05em;
        }

        .modal-content form input[type="radio"] {
            margin-right: 5px;
            width: auto;
            transform: scale(1.2); /* Larger radio buttons */
        }

        .modal-content form textarea {
            width: calc(100% - 24px);
            min-height: 100px;
            margin-top: 15px;
            padding: 12px;
            border-radius: 10px;
            background-color: #edf2f7;
            color: #2d3748;
        }

        .modal-content form button {
            width: auto;
            margin-top: 20px;
            align-self: center;
            padding: 12px 30px;
            background-color: #4299e1;
        }
        .modal-content form button:hover {
            background-color: #3182ce;
        }

        /* Game Builder Specific Styles */
        #gameBuilderTab {
            max-width: 1200px; /* Even wider for builder */
            display: flex;
            flex-direction: column;
            gap: 20px; /* Space between sections */
        }

        .builder-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px; /* Space between tool/canvas/inventory */
        }

        .builder-tools {
            display: flex;
            flex-direction: column;
            gap: 12px; /* Space between tools */
            background-color: #edf2f7;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            min-width: 180px;
        }

        .builder-tool-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #cbd5e0;
            transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        }
        .builder-tool-item:hover {
            background-color: #e2e8f0;
            border-color: #a0aec0;
        }
        .builder-tool-item.selected {
            background-color: #bee3f8;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .builder-tool-item img {
            width: 28px; /* Larger icons */
            height: 28px;
        }
        .builder-tool-item span {
            font-weight: bold;
            color: #2d3748;
            font-size: 1.05em;
        }

        .color-picker-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* Space between color boxes */
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }
        .color-box {
            width: 30px; /* Larger color boxes */
            height: 30px;
            border: 2px solid #ccc;
            cursor: pointer;
            border-radius: 6px;
            transition: transform 0.1s, border-color 0.2s, box-shadow 0.2s;
        }
        .color-box.selected {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px #4299e1;
            transform: scale(1.15);
        }

        #gameCanvasContainer {
            border: 2px solid #a0aec0;
            border-radius: 12px;
            background-color: #f7fafc;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            position: relative;
            min-height: 400px; /* Taller canvas area */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        #gameCanvas {
            background-color: #fff;
            display: block;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .builder-inventory {
            background-color: #edf2f7;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            min-width: 220px; /* Wider inventory */
            max-height: 500px; /* Taller inventory */
            overflow-y: auto;
        }
        .inventory-category {
            font-weight: bold;
            color: #2d3748;
            margin-top: 15px;
            margin-bottom: 8px;
            border-bottom: 2px solid #cbd5e0; /* Thicker separator */
            padding-bottom: 5px;
            font-size: 1.1em;
        }
        .inventory-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #cbd5e0;
            transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        }
        .inventory-item:hover {
            background-color: #e2e8f0;
            border-color: #4299e1;
        }
        .inventory-item.selected {
            background-color: #bee3f8;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .inventory-item img {
            width: 24px;
            height: 24px;
        }
        .inventory-item span {
            font-size: 1em;
            color: #4a5568;
        }

        #createNewModelBtn, #selectBlockColorBtn {
            margin-top: 20px;
            width: 100%;
            background-color: #4299e1;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #createNewModelBtn:hover, #selectBlockColorBtn:hover {
            background-color: #3182ce;
            transform: translateY(-1px);
        }

        .builder-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .builder-actions button {
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        #takeScreenshotBtn {
            background-color: #a0aec0; /* Gray */
            color: white;
        }
        #takeScreenshotBtn:hover {
            background-color: #718096;
        }
        #publishGameBtn {
            background-color: #48bb78; /* Green */
            color: white;
        }
        #publishGameBtn:hover {
            background-color: #38a169;
        }
        #backToGamesListBtn {
            background-color: #e53e3e; /* Red */
            color: white;
        }
        #backToGamesListBtn:hover {
            background-color: #c53030;
        }

        /* Game List Styles */
        .game-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Slightly larger cards */
            gap: 25px; /* More space */
            margin-top: 25px;
        }
        .game-card {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s;
        }
        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        .game-card h4 {
            margin-top: 0;
            margin-bottom: 12px;
            color: #2d3748;
            font-size: 1.4em;
            font-weight: 700;
        }
        .game-card p {
            font-size: 1em;
            color: #4a5568;
            margin-bottom: 8px;
        }
        .game-card-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        .game-card-actions button {
            flex: 1;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .game-card-actions .build-game-btn {
            background-color: #63b3ed;
            color: white;
        }
        .game-card-actions .build-game-btn:hover {
            background-color: #4299e1;
            transform: translateY(-1px);
        }
        .game-card-actions .play-game-btn {
            background-color: #48bb78;
            color: white;
        }
        .game-card-actions .play-game-btn:hover {
            background-color: #38a169;
            transform: translateY(-1px);
        }
        .game-card-actions .play-game-btn:disabled {
            background-color: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Play Game Section */
        #playGameSection {
            text-align: center;
            max-width: 900px; /* Wider play area */
        }
        #playGameContent {
            border: 2px solid #a0aec0;
            border-radius: 12px;
            background-color: #f7fafc;
            padding: 30px;
            margin-top: 25px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        #playGameContent p {
            font-size: 1.2em;
            color: #4a5568;
            margin-bottom: 20px;
        }
        #playGameCanvas {
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        #returnToGamesListBtn {
            margin-top: 25px;
            padding: 12px 25px;
            background-color: #4299e1;
            color: white;
            border-radius: 10px;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        #returnToGamesListBtn:hover {
            background-color: #3182ce;
            transform: translateY(-1px);
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
                padding: 15px 10px;
            }
            header h1 {
                font-size: 1.8em;
            }
            .header-controls {
                justify-content: center;
            }
            .header-controls button, .header-controls select {
                padding: 8px 12px;
                font-size: 0.9em;
            }
            main {
                padding: 15px 10px;
            }
            section {
                padding: 20px;
                border-radius: 12px;
            }
            h2 {
                font-size: 1.8em;
                margin-bottom: 15px;
            }
            form input, form select, form textarea, form button {
                padding: 10px;
                font-size: 1em;
            }
            form button {
                padding: 10px 20px;
                font-size: 1.1em;
            }
            .avatar img {
                width: 70px;
                height: 70px;
            }
            #profileHeader {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                padding-bottom: 15px;
            }
            #profileAvatar img {
                width: 90px;
                height: 90px;
            }
            #profileInfo p {
                font-size: 1em;
            }
            #profileStats {
                gap: 10px;
            }
            #profileStats div {
                padding: 6px 10px;
                font-size: 0.85em;
            }
            #tabs {
                flex-direction: column;
                align-items: stretch; /* Stretch buttons to full width */
                gap: 5px;
                padding-bottom: 5px;
            }
            #tabs button {
                width: 100%;
                border-radius: 8px;
                border-bottom: 1px solid #cbd5e0;
                padding: 10px;
            }
            #tabs button.active {
                border-bottom: 1px solid #4299e1;
            }
            .tabContent {
                padding: 20px;
                border-radius: 0 0 12px 12px;
            }
            #rankingTypeButtons {
                gap: 8px;
                margin-bottom: 15px;
            }
            #rankingTypeButtons button {
                padding: 8px 12px;
                font-size: 0.9em;
            }
            #rankingTable th, #rankingTable td {
                padding: 8px 10px;
                font-size: 0.95em;
            }
            #rankingTable td button.report-user-btn {
                margin-left: 5px;
                padding: 4px 8px;
                font-size: 0.75em;
            }
            .post {
                padding: 15px;
                margin-bottom: 15px;
            }
            .post-avatar img {
                width: 40px;
                height: 40px;
                margin-right: 10px;
            }
            .post-author {
                font-size: 1em;
            }
            .chat-container {
                padding: 15px;
                margin-bottom: 15px;
            }
            .chat-header {
                font-size: 1em;
            }
            .chat-message {
                font-size: 0.9em;
            }
            .friends-search {
                flex-direction: column;
                gap: 10px;
            }
            .friends-search input, .friends-search button {
                width: 100%;
                box-sizing: border-box;
            }
            .user-card {
                padding: 10px;
                font-size: 1em;
            }
            .user-card button {
                padding: 6px 10px;
                font-size: 0.85em;
            }
            .my-friends li {
                padding: 8px 10px;
                font-size: 1em;
            }
            .modal-content {
                padding: 20px;
                border-radius: 12px;
            }
            .close-button {
                font-size: 24px;
                right: 10px;
                top: 10px;
            }
            .modal-content h2 {
                font-size: 1.5em;
            }
            .modal-content form label {
                font-size: 0.95em;
            }
            .modal-content form input[type="radio"] {
                transform: scale(1);
            }
            .modal-content form textarea {
                padding: 10px;
            }
            .modal-content form button {
                padding: 10px 20px;
                font-size: 1.1em;
            }

            /* Game Builder Responsive */
            #gameBuilderTab {
                padding: 20px;
            }
            .builder-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            .builder-tools, .builder-inventory {
                min-width: unset;
                width: 100%;
                padding: 10px;
            }
            .builder-tool-item, .inventory-item {
                padding: 8px;
            }
            .builder-tool-item img, .inventory-item img {
                width: 20px;
                height: 20px;
            }
            .color-box {
                width: 25px;
                height: 25px;
            }
            #gameCanvasContainer {
                min-height: 250px;
            }
            .builder-actions {
                flex-direction: column;
                gap: 10px;
            }
            .builder-actions button {
                width: 100%;
                box-sizing: border-box;
            }

            /* Game List Responsive */
            .game-list-container {
                grid-template-columns: 1fr; /* Single column on mobile */
                gap: 15px;
            }
            .game-card {
                padding: 15px;
            }
            .game-card h4 {
                font-size: 1.2em;
            }
            .game-card-actions {
                flex-direction: column;
                gap: 8px;
            }
            .game-card-actions button {
                width: 100%;
                box-sizing: border-box;
            }

            /* Play Game Responsive */
            #playGameContent {
                padding: 20px;
                min-height: 300px;
            }
            #playGameContent p {
                font-size: 1em;
            }
            #playGameCanvas {
                width: 100%;
                height: auto; /* Allow height to adjust */
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>PoKreGaM</h1>
        <div class="header-controls">
            <nav id="navMain">
                <button id="navGames">Games</button>
                <button id="navMarketplace">Marketplace</button>
                <button id="navBuild">Build</button>
                <button id="navNews">News</button>
                <button id="navRanking">Ranking</button>
            </nav>
            <select id="languageSelector">
                <option value="en">English</option>
                <option value="pl">Polski</option>
                <option value="mk">Македонски</option>
                <option value="ru">Русский</option>
                <option value="hu">Magyar</option>
            </select>
            <button id="btnLogin">Login</button>
            <button id="btnSignUp">Sign Up</button>
        </div>
    </header>

    <main>
        <!-- Login Section -->
        <section id="loginSection" class="hidden">
            <h2 id="loginTitle">Login</h2>
            <form id="loginForm">
                <label for="loginUsername">Username:</label>
                <input type="text" id="loginUsername" required autocomplete="username">
                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword" required autocomplete="current-password">
                <button type="submit" id="loginSubmit">Login</button>
                <p id="loginError" class="error-message"></p>
                <p class="link-text"><button type="button" id="forgotPasswordLink">Forgot Password?</button></p>
                <p class="link-text"><button type="button" id="toSignUp">Don't have an account? Sign Up</button></p>
            </form>
        </section>

        <!-- Sign Up Section -->
        <section id="signUpSection" class="hidden">
            <h2 id="signUpTitle">Sign Up</h2>
            <form id="signUpForm">
                <p id="selectCharacter">Select your character:</p>
                <div id="avatarsContainer">
                    <!-- Avatars will be rendered here by JS -->
                </div>
                <label for="signUpUsername">Username:</label>
                <input type="text" id="signUpUsername" required autocomplete="username">
                <label for="signUpEmail">Email (optional):</label>
                <input type="email" id="signUpEmail" autocomplete="email">
                <label for="signUpCountry">Country:</label>
                <select id="signUpCountry" required>
                    <option value="PL">Poland</option>
                    <option value="US">United States</option>
                    <option value="MK">North Macedonia</option>
                    <option value="HU">Hungary</option>
                    <option value="DE">Germany</option>
                </select>
                <label for="signUpPassword">Password:</label>
                <input type="password" id="signUpPassword" required autocomplete="new-password">
                <label for="signUpBirthdate">Birthdate:</label>
                <input type="date" id="signUpBirthdate" required>
                <button type="submit" id="signUpSubmit">Sign Up</button>
                <p id="signUpError" class="error-message"></p>
                <p class="link-text"><button type="button" id="toLogin">Already have an account? Login</button></p>
            </form>
        </section>

        <!-- Forgot Password Section -->
        <section id="forgotPasswordSection" class="hidden">
            <h2 id="forgotPasswordTitle">Forgot Password</h2>
            <p id="forgotPasswordInstructions">Please enter your email. If an account is associated with it, we will send you your account details (username and password) via email.</p>
            <form id="forgotPasswordForm">
                <label for="forgotPasswordEmail">Email:</label>
                <input type="email" id="forgotPasswordEmail" required autocomplete="email">
                <button type="submit" id="sendRecoveryEmail">Send Recovery Email</button>
                <p id="forgotPasswordMessage" class="success-message"></p>
                <p id="forgotPasswordError" class="error-message"></p>
                <p class="link-text"><button type="button" id="backToLoginFromForgot">Back to Login</button></p>
            </form>
        </section>

        <!-- Profile Section -->
        <section id="profileSection" class="hidden">
            <div id="profileHeader">
                <div id="profileAvatar">
                    <img src="" alt="User Avatar">
                </div>
                <div id="profileInfo">
                    <p><strong id="profileUsernameLabel">Username:</strong> <span id="profileUsername"></span></p>
                    <p><strong id="profileCountryLabel">Country:</strong> <span id="profileCountry"></span></p>
                    <p><strong id="profileRankingPlaceLabel">XP Ranking Place:</strong> <span id="profileRankingPlace"></span></p>
                    <div id="profileStats">
                        <div id="profileXPLabel">XP: <span id="profileXP">0</span></div>
                        <div id="profileLevelLabel">Level: <span id="profileLevel">1</span></div>
                        <div id="profileFriendsCountLabel">Friends: <span id="profileFriendsCount">0</span></div>
                        <div id="profileGoldLabel">Gold: <span id="profileGold">0</span></div>
                    </div>
                </div>
            </div>

            <nav id="tabs">
                <button data-tab="gamesTab" class="active" aria-selected="true" id="gamesTabButton">Games</button>
                <button data-tab="marketplaceTab" aria-selected="false" id="marketplaceTabButton">Marketplace</button>
                <button data-tab="buildTab" aria-selected="false" id="buildTabButton">Build</button>
                <button data-tab="newGameTab" aria-selected="false" id="newGameTabButton">New Game</button>
                <button data-tab="newsTab" aria-selected="false" id="newsTabButton">News</button>
                <button data-tab="rankingTab" aria-selected="false" id="rankingTabButton">Ranking</button>
                <button data-tab="postsTab" aria-selected="false" id="postsTabButton">Posts</button>
                <button data-tab="friendsTab" aria-selected="false" id="friendsTabButton">Friends</button>
                <button id="checkThisBtn" class="hidden">Check this</button>
                <button id="btnLogout">Logout</button>
            </nav>

            <div id="tabContents">
                <!-- Games Tab Content -->
                <div id="gamesTab" class="tabContent active">
                    <h3 id="gamesTabTitle">Games</h3>
                    <p id="gamesWelcomeText">Welcome to your games! Start a new adventure or continue an existing one.</p>
                    <button id="buildNewGameBtn" class="primary">Build New Game</button>
                    <h4 id="myGamesListTitle">My Games</h4>
                    <div id="myGamesList" class="game-list-container">
                        <!-- List of user's games will be rendered here -->
                    </div>
                    <h4 id="publishedGamesListTitle">Published Games</h4>
                    <div id="publishedGamesList" class="game-list-container">
                        <!-- List of all published games will be rendered here -->
                    </div>
                </div>

                <div id="marketplaceTab" class="tabContent hidden">
                    <h3 id="marketplaceTabTitle">Marketplace</h3>
                    <p id="marketplaceDescription">Buy and sell items, weapons, and armor here.</p>
                    <p id="marketplaceUnderConstruction"><em>Marketplace is under construction.</em></p>
                </div>

                <div id="buildTab" class="tabContent hidden">
                    <h3 id="buildTabTitle">Build</h3>
                    <p id="buildDescription">Craft new items or build your base.</p>
                    <p id="buildUnderConstruction"><em>Build section is under construction.</em></p>
                </div>

                <div id="newGameTab" class="tabContent hidden">
                    <h3 id="newGameTabTitle">New Game</h3>
                    <p id="newGameDescription">Choose your game type and begin a new journey.</p>
                    <p id="newGameComingSoon"><em>Feature coming soon.</em></p>
                </div>

                <div id="newsTab" class="tabContent hidden">
                    <h3 id="newsTabTitle">News</h3>
                    <p id="newsDescription">Stay updated with the latest game news and community announcements.</p>
                    <p id="noNewsYet">No news articles available at the moment. Check back soon!</p>
                </div>

                <div id="rankingTab" class="tabContent hidden">
                    <h3 id="rankingTabTitle">XP Ranking</h3>
                    <div id="rankingTypeButtons">
                        <button data-ranking-type="overall" class="active" id="overallRankingBtn">Overall Ranking</button>
                        <button data-ranking-type="weekly" id="weeklyRankingBtn">Weekly Ranking</button>
                        <button data-ranking-type="monthly" id="monthlyRankingBtn">Monthly Ranking</button>
                        <button data-ranking-type="yearly" id="yearlyRankingBtn">Yearly Ranking</button>
                        <button data-ranking-type="global" id="globalRankingBtn">Global Ranking (by country)</button>
                    </div>
                    <table id="rankingTable">
                        <thead>
                            <tr>
                                <th>Place</th>
                                <th>Username</th>
                                <th>XP</th>
                                <th>Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Ranking data will be rendered here by JS -->
                        </tbody>
                    </table>
                </div>

                <div id="postsTab" class="tabContent hidden">
                    <h3 id="postsTabTitle">Community Posts</h3>
                    <div id="writePostSection">
                        <label for="postContent" id="writePostLabel">Write your post:</label>
                        <textarea id="postContent" placeholder="What's on your mind?"></textarea>
                        <button id="publishPostBtn">Publish</button>
                        <p id="postMessage" class="success-message"></p>
                    </div>
                    <div id="communityPosts">
                        <!-- Community posts will be rendered here by JS -->
                    </div>
                </div>

                <!-- Friends Tab Content -->
                <div id="friendsTab" class="tabContent hidden">
                    <h3 id="friendsTabTitle">Friends</h3>
                    <div class="friends-search">
                        <input type="text" id="friendSearchInput" placeholder="Wyszukaj użytkownika...">
                        <button id="searchFriendBtn">Szukaj</button>
                    </div>
                    <div id="friendSearchResults" class="user-list">
                        <!-- Wyniki wyszukiwania pojawią się tutaj -->
                    </div>
                    <div class="my-friends">
                        <h3 id="myFriendsListTitle">Moi Przyjaciele</h3>
                        <ul id="myFriendsList">
                            <!-- Lista aktualnych przyjaciół pojawi się tutaj -->
                        </ul>
                    </div>
                </div>

                <!-- Game Builder Tab Content (dodana sekcja) -->
                <div id="gameBuilderTab" class="tabContent hidden">
                    <h3 id="gameBuilderTitle">Build Your Game: <span id="currentBuildingGameName"></span></h3>
                    <div class="builder-controls">
                        <div class="builder-tools">
                            <div class="builder-tool-item selected" data-tool="hammer" id="toolHammer">
                                <img src="https://placehold.co/28x28/cccccc/000000?text=🔨" alt="Hammer">
                                <span id="toolHammerLabel">Hammer (Place Block)</span>
                            </div>
                            <div class="builder-tool-item" data-tool="eraser" id="toolEraser">
                                <img src="https://placehold.co/28x28/cccccc/000000?text=🧽" alt="Eraser">
                                <span id="toolEraserLabel">Eraser (Delete Block)</span>
                            </div>
                            <div class="builder-tool-item" data-tool="bucket" id="toolBucket">
                                <img src="https://placehold.co/28x28/cccccc/000000?text= buckets" alt="Bucket">
                                <span id="toolBucketLabel">Bucket (Color Block)</span>
                            </div>
                            <div class="color-picker-container" id="blockColorPicker">
                                <!-- Colors will be rendered here -->
                            </div>
                        </div>

                        <div id="gameCanvasContainer">
                            <canvas id="gameCanvas"></canvas>
                        </div>

                        <div class="builder-inventory">
                            <div class="inventory-category" id="modelsCategory">Models</div>
                            <div id="inventoryModels">
                                <!-- Models will be rendered here -->
                            </div>
                            <div class="inventory-category" id="weaponsCategory">Weapons</div>
                            <div id="inventoryWeapons">
                                <!-- Weapons will be rendered here -->
                            </div>
                            <div class="inventory-category" id="logicCategory">Logic</div>
                            <div id="inventoryLogic">
                                <!-- Logic items will be rendered here -->
                            </div>
                            <button id="createNewModelBtn">Create New Model</button>
                            <button id="selectBlockColorBtn">Select Block Color</button>
                        </div>
                    </div>
                    <div class="builder-actions">
                        <button id="takeScreenshotBtn">Take Screenshot</button>
                        <button id="publishGameBtn">Publish Game</button>
                        <button id="backToGamesListBtn">Back to Games List</button>
                    </div>
                    <p id="gameBuilderMessage" class="success-message"></p>
                </div>

                <!-- Play Game Section (dodana sekcja) -->
                <div id="playGameSection" class="tabContent hidden">
                    <h3 id="playGameTitle">Play Game: <span id="playingGameName"></span></h3>
                    <div id="playGameContent">
                        <p id="playGameInstructions">This is a simulated game. Imagine playing it now!</p>
                        <canvas id="playGameCanvas"></canvas>
                        <button id="returnToGamesListBtn" class="primary">Return to Games List</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- All Chats Section (for Guest access) -->
        <section id="allChatsSection" class="hidden">
            <h2 id="allChatsTitle">All Private and Game Chats (Guest Access)</h2>
            <p id="allChatsDescription">This content is only visible to 'guest' users logged in with password 'Freeaccount'.</p>
            <div id="chatsContent">
                <!-- Chat messages will be rendered here by JS -->
            </div>
        </section>
    </main>

    <!-- Report User Modal -->
    <div id="reportUserModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="reportUserModalHeader">Zgłoś Użytkownika: <span id="reportUsernameTarget"></span></h2>
            <p id="reportReasonLabel">Wybierz powód zgłoszenia:</p>
            <form id="reportForm">
                <label>
                    <input type="radio" name="reportReason" value="sexualContent"> <span id="sexualContentReason">Seksualna treść</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="hateSpeech"> <span id="hateSpeechReason">Mowa nienawiści / Brzydkie słowa</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="personalData"> <span id="personalDataReason">Udostępnianie danych osobowych</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="maliciousLink"> <span id="maliciousLinkReason">Wysyłanie nieznanych/złośliwych linków</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="threats"> <span id="threatsReason">Grożenie</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="cheating"> <span id="cheatingReason">Cheaty</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="adminImpersonation"> <span id="adminImpersonationReason">Podawanie się za admina</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="passwordSharing"> <span id="passwordSharingReason">Udostępnianie cudzego hasła</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="other"> <span id="otherReason">Inne</span> (opcjonalnie doprecyzuj poniżej)
                </label><br>
                <textarea id="reportComment" placeholder="Dodatkowe uwagi (opcjonalnie)"></textarea><br>
                <button type="submit" id="sendReportBtn">Wyślij Zgłoszenie</button>
                <p id="reportMessage" class="error-message"></p>
            </form>
        </div>
    </div>

    <script>
    // --- Language data ---
    const LANG = {
        en: {
            login: "Login",
            signup: "Sign Up",
            username: "Username",
            password: "Password",
            email: "Email (optional)",
            country: "Country",
            birthdate: "Birthdate",
            selectCharacter: "Select your character:",
            dontHaveAccount: "Don't have an account? Sign Up",
            alreadyHaveAccount: "Already have an account? Login",
            rankingXPPlace: "XP Ranking Place:",
            games: "Games",
            marketplace: "Marketplace",
            build: "Build",
            newGame: "New Game",
            news: "News",
            ranking: "Ranking",
            posts: "Posts",
            startNewGame: "Start New Game", // Changed to Build New Game in HTML
            loginError: "Incorrect username or password.",
            signUpError: "Please fill in all required fields and select a character.",
            logout: "Logout",
            checkThis: "Check this",
            allChatsTitle: "All Private and Game Chats (Guest Access)",
            allChatsDescription: "This content is only visible to 'guest' users logged in with password 'Freeaccount'.",
            forgotPassword: "Forgot Password?",
            forgotPasswordTitle: "Forgot Password",
            forgotPasswordInstructions: "Please enter your email. If an account is associated with it, we will send you your account details (username and password) via email.",
            sendRecoveryEmail: "Send Recovery Email",
            backToLogin: "Back to Login",
            recoveryEmailSent: "If an account exists with this email, your account details (username: {username}, password: {password}) have been sent to your email. (Simulation)",
            recoveryEmailNotFound: "No account found with that email or no email provided for the account. Please check your email or try signing up.",
            postsTabTitle: "Community Posts",
            writePostLabel: "Write your post:",
            publishPostBtn: "Publish",
            postContentPlaceholder: "What's on your mind?",
            postPublished: "Post successfully published!",
            postEmpty: "Post cannot be empty.",
            overallRanking: "Overall Ranking",
            weeklyRanking: "Weekly Ranking",
            monthlyRanking: "Monthly Ranking",
            yearlyRanking: "Yearly Ranking",
            globalRankingCountry: "Global Ranking (by country)",
            rankingTabTitle: "XP Ranking",
            friends: "Friends",
            search: "Search",
            myFriends: "My Friends",
            noSearchResults: "No search results found.",
            addFriend: "Add Friend",
            alreadyFriends: "Already Friends",
            cannotAddSelf: "Cannot add yourself as a friend.",
            friendAdded: "User {username} has been added to your friends list.",
            noFriendsYet: "You don't have any friends yet.",
            reportUser: "Report",
            reportUserModalTitle: "Report User:",
            reportReason: "Select report reason:",
            sexualContent: "Sexual content",
            hateSpeech: "Hate speech / Bad language",
            personalData: "Sharing personal data",
            maliciousLink: "Sending unknown/malicious links",
            threats: "Threats",
            cheating: "Cheating",
            adminImpersonation: "Impersonating an admin",
            passwordSharing: "Sharing someone else's password",
            other: "Other",
            additionalComments: "Additional comments (optional)",
            sendReport: "Send Report",
            reportSuccess: "Report submitted successfully. Thank you!",
            reportNoReason: "Please select a report reason.",
            reportCannotReportSelf: "You cannot report yourself.",
            noPostsYet: "No posts yet. Be the first to share something!",
            noNewsYet: "No news articles available at the moment. Check back soon!",
            gamesWelcomeText: "Welcome to your games! Start a new adventure or continue an existing one.",
            buildNewGame: "Build New Game",
            myGamesListTitle: "My Games",
            publishedGamesListTitle: "Published Games",
            gameBuilderTitle: "Build Your Game:",
            toolHammerLabel: "Hammer (Place Block)",
            toolEraserLabel: "Eraser (Delete Block)",
            toolBucketLabel: "Bucket (Color Block)",
            modelsCategory: "Models",
            weaponsCategory: "Weapons",
            logicCategory: "Logic",
            createNewModel: "Create New Model",
            selectBlockColor: "Select Block Color",
            takeScreenshot: "Take Screenshot",
            publishGame: "Publish Game",
            backToGamesList: "Back to Games List",
            gamePublishedSuccess: "Game '{gameName}' published successfully!",
            gameSaved: "Game '{gameName}' saved.",
            gameNamePrompt: "Enter a name for your new game:",
            selectGameType: "Select game type:",
            baseTemple: "Base Temple",
            parkour: "Parkour",
            island: "Island",
            playGameTitle: "Play Game:",
            playGameInstructions: "This is a simulated game. Imagine playing it now!",
            returnToGamesList: "Return to Games List",
            gameNotPublished: "This game is not yet published. You can't play it until it's published.",
            noGamesYet: "You haven't created any games yet. Start building!",
            noPublishedGames: "No games have been published yet.",
        },
        pl: {
            login: "Zaloguj się",
            signup: "Zarejestruj się",
            username: "Nazwa użytkownika",
            password: "Hasło",
            email: "E-mail (opcjonalnie)",
            country: "Kraj",
            birthdate: "Data urodzenia",
            selectCharacter: "Wybierz swoją postać:",
            dontHaveAccount: "Nie masz konta? Zarejestruj się",
            alreadyHaveAccount: "Masz już konto? Zaloguj się",
            rankingXPPlace: "Miejsce w rankingu XP:",
            games: "Gry",
            marketplace: "Rynek",
            build: "Buduj",
            newGame: "Nowa gra",
            news: "Aktualności",
            ranking: "Ranking",
            posts: "Posty",
            startNewGame: "Rozpocznij nową grę", // Changed to Build New Game in HTML
            loginError: "Nieprawidłowa nazwa użytkownika lub hasło.",
            signUpError: "Proszę wypełnić wszystkie wymagane pola i wybrać postać.",
            logout: "Wyloguj się",
            checkThis: "Sprawdź to",
            allChatsTitle: "Wszystkie prywatne czaty i czaty z gier (Dostęp gościa)",
            allChatsDescription: "Ta zawartość jest widoczna tylko dla użytkowników 'gość' zalogowanych hasłem 'Freeaccount'.",
            forgotPassword: "Zapomniałeś hasła?",
            forgotPasswordTitle: "Zapomniałeś hasła",
            forgotPasswordInstructions: "Proszę podać swój adres e-mail. Jeśli istnieje konto z nim powiązane, wyślemy Ci dane konta (nazwa użytkownika i hasło) e-mailem.",
            sendRecoveryEmail: "Wyślij e-mail odzyskiwania",
            backToLogin: "Wróć do logowania",
            recoveryEmailSent: "Jeśli istnieje konto z tym adresem e-mail, dane Twojego konta (nazwa użytkownika: {username}, hasło: {password}) zostały wysłane na Twój adres e-mail. (Symulacja)",
            recoveryEmailNotFound: "Nie znaleziono konta z tym adresem e-mail lub nie podano adresu e-mail dla konta. Sprawdź swój adres e-mail lub spróbuj się zarejestrować.",
            postsTabTitle: "Posty społeczności",
            writePostLabel: "Napisz swoją wiadomość:",
            publishPostBtn: "Opublikuj",
            postContentPlaceholder: "Co masz na myśli?",
            postPublished: "Post został pomyślnie opublikowany!",
            postEmpty: "Wiadomość nie może być pusta.",
            overallRanking: "Ogólny ranking",
            weeklyRanking: "Ranking tygodniowy",
            monthlyRanking: "Ranking miesięczny",
            yearlyRanking: "Ranking roczny",
            globalRankingCountry: "Globalny ranking (według kraju)",
            rankingTabTitle: "Ranking XP",
            friends: "Znajomi",
            search: "Szukaj",
            myFriends: "Moi Przyjaciele",
            noSearchResults: "Brak wyników wyszukiwania.",
            addFriend: "Dodaj znajomego",
            alreadyFriends: "Jesteście już znajomymi",
            cannotAddSelf: "Nie możesz dodać samego siebie do znajomych.",
            friendAdded: "Użytkownik {username} został dodany do listy znajomych.",
            noFriendsYet: "Nie masz jeszcze znajomych.",
            reportUser: "Zgłoś",
            reportUserModalTitle: "Zgłoś Użytkownika:",
            reportReason: "Wybierz powód zgłoszenia:",
            sexualContent: "Treść seksualna",
            hateSpeech: "Mowa nienawiści / Wulgaryzmy",
            personalData: "Udostępnianie danych osobowych",
            maliciousLink: "Wysyłanie nieznanych/złośliwych linków",
            threats: "Groźby",
            cheating: "Oszustwa",
            adminImpersonation: "Podawanie się za administratora",
            passwordSharing: "Udostępnianie cudzego hasła",
            other: "Inne",
            additionalComments: "Dodatkowe uwagi (opcjonalnie)",
            sendReport: "Wyślij Zgłoszenie",
            reportSuccess: "Zgłoszenie zostało pomyślnie wysłane. Dziękujemy!",
            reportNoReason: "Proszę wybrać powód zgłoszenia.",
            reportCannotReportSelf: "Nie możesz zgłosić samego siebie.",
            noPostsYet: "Brak postów. Bądź pierwszy, który coś udostępni!",
            noNewsYet: "Brak dostępnych artykułów z wiadomościami. Sprawdź ponownie wkrótce!",
            gamesWelcomeText: "Witaj w strefie gier! Rozpocznij nową przygodę lub kontynuuj istniejącą.",
            buildNewGame: "Zbuduj nową grę",
            myGamesListTitle: "Moje Gry",
            publishedGamesListTitle: "Opublikowane Gry",
            gameBuilderTitle: "Buduj swoją grę:",
            toolHammerLabel: "Młotek (Ustaw blok)",
            toolEraserLabel: "Gumka (Usuń blok)",
            toolBucketLabel: "Wiadro (Koloruj blok)",
            modelsCategory: "Modele",
            weaponsCategory: "Bronie",
            logicCategory: "Logika",
            createNewModel: "Stwórz nowy model",
            selectBlockColor: "Wybierz kolor bloku",
            takeScreenshot: "Zrób zrzut ekranu",
            publishGame: "Opublikuj grę",
            backToGamesList: "Wróć do listy gier",
            gamePublishedSuccess: "Gra '{gameName}' została pomyślnie opublikowana!",
            gameSaved: "Gra '{gameName}' zapisana.",
            gameNamePrompt: "Podaj nazwę dla swojej nowej gry:",
            selectGameType: "Wybierz typ gry:",
            baseTemple: "Świątynia Bazowa",
            parkour: "Prakour",
            island: "Wyspa",
            playGameTitle: "Graj w grę:",
            playGameInstructions: "To jest symulowana gra. Wyobraź sobie, że teraz w nią grasz!",
            returnToGamesList: "Wróć do listy gier",
            gameNotPublished: "Ta gra nie jest jeszcze opublikowana. Nie możesz w nią grać, dopóki nie zostanie opublikowana.",
            noGamesYet: "Nie stworzyłeś jeszcze żadnych gier. Zacznij budować!",
            noPublishedGames: "Żadne gry nie zostały jeszcze opublikowane.",
        },
        mk: {
            login: "Најава",
            signup: "Регистрација",
            username: "Корисничко име",
            password: "Лозинка",
            email: "Е-пошта (опционално)",
            country: "Држава",
            birthdate: "Датум на раѓање",
            selectCharacter: "Избери го својот карактер:",
            dontHaveAccount: "Немате сметка? Регистрирајте се",
            alreadyHaveAccount: "Веќе имате сметка? Најавете се",
            rankingXPPlace: "Место на ранг листата по XP:",
            games: "Игри",
            marketplace: "Пазар",
            build: "Изградба",
            newGame: "Нова игра",
            news: "Вести",
            ranking: "Ранг листа",
            posts: "Објави",
            startNewGame: "Започни нова игра", // Changed to Build New Game in HTML
            loginError: "Погрешно корисничко име или лозинка.",
            signUpError: "Ве молиме пополнете ги сите задолжителни полиња и изберете карактер.",
            logout: "Одјави се",
            checkThis: "Провери го ова",
            allChatsTitle: "Сите приватни разговори и разговори од игри (Гостински пристап)",
            allChatsDescription: "Оваа содржина е видлива само за 'гостин' корисници најавени со лозинката 'Freeaccount'.",
            forgotPassword: "Заборавена лозинка?",
            forgotPasswordTitle: "Заборавена лозинка",
            forgotPasswordInstructions: "Ве молиме внесете ја вашата е-пошта. Доколку постои сметка поврзана со неа, ќе ви ги испратиме деталите за вашата сметка (корисничко име и лозинка) по е-пошта.",
            sendRecoveryEmail: "Испрати е-пошта за обнова",
            backToLogin: "Назад на Најава",
            recoveryEmailSent: "Доколку постои сметка со оваа е-пошта, деталите за вашата сметка (корисничко име: {username}, лозинка: {password}) се испратени на вашата е-пошта. (Симулација)",
            recoveryEmailNotFound: "Не е пронајдена сметка со таа е-пошта или не е обезбедена е-попошта за сметката. Ве молиме проверете ја вашата е-пошта или обидете се да се регистрирате.",
            postsTabTitle: "Објави на заедницата",
            writePostLabel: "Напиши ја вашата објава:",
            publishPostBtn: "Објави",
            postContentPlaceholder: "Што ви е на ум?",
            postPublished: "Објавата е успешно објавена!",
            postEmpty: "Објавата не може да биде празна.",
            overallRanking: "Вкупна ранг листа",
            weeklyRanking: "Неделна ранг листа",
            monthlyRanking: "Месечна ранг листа",
            yearlyRanking: "Годишна ранг листа",
            globalRankingCountry: "Глобална ранг листа (по држава)",
            rankingTabTitle: "XP Ранг листа",
            friends: "Пријатели",
            search: "Барај",
            myFriends: "Мои Пријатели",
            noSearchResults: "Нема резултати од пребарувањето.",
            addFriend: "Додај пријател",
            alreadyFriends: "Веќе пријатели",
            cannotAddSelf: "Не можете да се додадете себеси како пријател.",
            friendAdded: "Корисникот {username} е додаден во вашите пријатели.",
            noFriendsYet: "Сè уште немате пријатели.",
            reportUser: "Пријави",
            reportUserModalTitle: "Пријави Корисник:",
            reportReason: "Изберете причина за пријава:",
            sexualContent: "Сексуална содржина",
            hateSpeech: "Говор на омраза / Лош јазик",
            personalData: "Споделување лични податоци",
            maliciousLink: "Испраќање непознати/злонамерни линкови",
            threats: "Закани",
            cheating: "Мамење",
            adminImpersonation: "Претставување како администратор",
            passwordSharing: "Споделување туѓа лозинка",
            other: "Друго",
            additionalComments: "Дополнителни коментари (опционално)",
            sendReport: "Испрати Пријава",
            reportSuccess: "Пријавата е успешно поднесена. Благодариме!",
            reportNoReason: "Ве молиме изберете причина за пријава.",
            reportCannotReportSelf: "Не можете да се пријавите себеси.",
            noPostsYet: "Сè уште нема објави. Бидете првиот што ќе сподели нешто!",
            noNewsYet: "Во моментов нема достапни вести. Проверете наскоро!",
            gamesWelcomeText: "Добредојдовте во вашата зона за игри! Започнете нова авантура или продолжете со постоечка.",
            buildNewGame: "Изгради нова игра",
            myGamesListTitle: "Мои Игри",
            publishedGamesListTitle: "Објавени Игри",
            gameBuilderTitle: "Изгради ја твојата игра:",
            toolHammerLabel: "Чекан (Постави блок)",
            toolEraserLabel: "Гума (Избриши блок)",
            toolBucketLabel: "Кофа (Боја блок)",
            modelsCategory: "Модели",
            weaponsCategory: "Оружја",
            logicCategory: "Логика",
            createNewModel: "Креирај нов модел",
            selectBlockColor: "Избери боја на блок",
            takeScreenshot: "Направи скриншот",
            publishGame: "Објави игра",
            backToGamesList: "Назад кон листата со игри",
            gamePublishedSuccess: "Играта '{gameName}' е успешно објавена!",
            gameSaved: "Играта '{gameName}' е зачувана.",
            gameNamePrompt: "Внесете име за вашата нова игра:",
            selectGameType: "Изберете тип на игра:",
            baseTemple: "Основен Храм",
            parkour: "Паркур",
            island: "Остров",
            playGameTitle: "Играј игра:",
            playGameInstructions: "Ова е симулирана игра. Замислете дека ја играте сега!",
            returnToGamesList: "Врати се на листата со игри",
            gameNotPublished: "Оваа игра сè уште не е објавена. Не можете да ја играте додека не биде објавена.",
            noGamesYet: "Сè уште немате креирано игри. Започнете со градење!",
            noPublishedGames: "Сè уште нема објавени игри.",
        },
        ru: { // Добавлены русские переводы
            login: "Вход",
            signup: "Регистрация",
            username: "Имя пользователя",
            password: "Пароль",
            email: "Электронная почта (необязательно)",
            country: "Страна",
            birthdate: "Дата рождения",
            selectCharacter: "Выберите своего персонажа:",
            dontHaveAccount: "Нет аккаунта? Зарегистрироваться",
            alreadyHaveAccount: "Уже есть аккаунт? Войти",
            rankingXPPlace: "Место в рейтинге XP:",
            games: "Игры",
            marketplace: "Торговая площадка",
            build: "Строить",
            newGame: "Новая игра",
            news: "Новости",
            ranking: "Рейтинг",
            posts: "Сообщения",
            startNewGame: "Начать новую игру",
            loginError: "Неверное имя пользователя или пароль.",
            signUpError: "Пожалуйста, заполните все обязательные поля и выберите персонажа.",
            logout: "Выйти",
            checkThis: "Проверить это",
            allChatsTitle: "Все личные и игровые чаты (гостевой доступ)",
            allChatsDescription: "Этот контент виден только пользователям 'guest', вошедшим с паролем 'Freeaccount'.",
            forgotPassword: "Забыли пароль?",
            forgotPasswordTitle: "Забыли пароль",
            forgotPasswordInstructions: "Пожалуйста, введите свой адрес электронной почты. Если аккаунт связан с ней, мы отправим вам данные аккаунта (имя пользователя и пароль) по электронной почте.",
            sendRecoveryEmail: "Отправить письмо для восстановления",
            backToLogin: "Вернуться ко входу",
            recoveryEmailSent: "Если аккаунт существует с этой электронной почтой, данные вашего аккаунта (имя пользователя: {username}, пароль: {password}) были отправлены на вашу электронную почту. (Симуляция)",
            recoveryEmailNotFound: "Аккаунт с такой электронной почтой не найден или для аккаунта не указана электронная почта. Пожалуйста, проверьте свою электронную почту или попробуйте зарегистрироваться.",
            postsTabTitle: "Сообщения сообщества",
            writePostLabel: "Напишите свое сообщение:",
            publishPostBtn: "Опубликовать",
            postContentPlaceholder: "Что у вас на уме?",
            postPublished: "Сообщение успешно опубликовано!",
            postEmpty: "Сообщение не может быть пустым.",
            overallRanking: "Общий рейтинг",
            weeklyRanking: "Еженедельный рейтинг",
            monthlyRanking: "Ежемесячный рейтинг",
            yearlyRanking: "Ежегодный рейтинг",
            globalRankingCountry: "Глобальный рейтинг (по странам)",
            rankingTabTitle: "Рейтинг XP",
            friends: "Друзья",
            search: "Поиск",
            myFriends: "Мои друзья",
            noSearchResults: "Результатов поиска не найдено.",
            addFriend: "Добавить в друзья",
            alreadyFriends: "Уже друзья",
            cannotAddSelf: "Нельзя добавить себя в друзья.",
            friendAdded: "Пользователь {username} добавлен в ваш список друзей.",
            noFriendsYet: "У вас пока нет друзей.",
            reportUser: "Пожаловаться",
            reportUserModalTitle: "Пожаловаться на пользователя:",
            reportReason: "Выберите причину жалобы:",
            sexualContent: "Сексуальный контент",
            hateSpeech: "Разжигание ненависти / Нецензурные выражения",
            personalData: "Разглашение личных данных",
            maliciousLink: "Отправка неизвестных/вредоносных ссылок",
            threats: "Угрозы",
            cheating: "Читерство",
            adminImpersonation: "Выдача себя за администратора",
            passwordSharing: "Совместное использование чужого пароля",
            other: "Другое",
            additionalComments: "Дополнительные комментарии (необязательно)",
            sendReport: "Отправить жалобу",
            reportSuccess: "Жалоба успешно отправлена. Спасибо!",
            reportNoReason: "Пожалуйста, выберите причину жалобы.",
            reportCannotReportSelf: "Вы не можете пожаловаться на себя.",
            noPostsYet: "Пока нет сообщений. Будьте первым, кто что-то опубликует!",
            noNewsYet: "На данный момент нет новостных статей. Заходите позже!",
            gamesWelcomeText: "Добро пожаловать в ваши игры! Начните новое приключение или продолжите существующее.",
            buildNewGame: "Создать новую игру",
            myGamesListTitle: "Мои игры",
            publishedGamesListTitle: "Опубликованные игры",
            gameBuilderTitle: "Создайте свою игру:",
            toolHammerLabel: "Молоток (Разместить блок)",
            toolEraserLabel: "Ластик (Удалить блок)",
            toolBucketLabel: "Ведро (Раскрасить блок)",
            modelsCategory: "Модели",
            weaponsCategory: "Оружие",
            logicCategory: "Логика",
            createNewModel: "Создать новую модель",
            selectBlockColor: "Выбрать цвет блока",
            takeScreenshot: "Сделать скриншот",
            publishGame: "Опубликовать игру",
            backToGamesList: "Вернуться к списку игр",
            gamePublishedSuccess: "Игра '{gameName}' успешно опубликована!",
            gameSaved: "Игра '{gameName}' сохранена.",
            gameNamePrompt: "Введите название для вашей новой игры:",
            selectGameType: "Выберите тип игры:",
            baseTemple: "Базовый храм",
            parkour: "Паркур",
            island: "Остров",
            playGameTitle: "Играть в игру:",
            playGameInstructions: "Это симулированная игра. Представьте, что вы играете прямо сейчас!",
            returnToGamesList: "Вернуться к списку игр",
            gameNotPublished: "Эта игра еще не опубликована. Вы не можете играть в нее, пока она не будет опубликована.",
            noGamesYet: "Вы еще не создали ни одной игры. Начните строить!",
            noPublishedGames: "Игры пока не опубликованы.",
        },
        hu: { // Ungarische Übersetzungen (vorerst Kopie der englischen)
            login: "Bejelentkezés",
            signup: "Regisztráció",
            username: "Felhasználónév",
            password: "Jelszó",
            email: "E-mail (opcionális)",
            country: "Ország",
            birthdate: "Születési dátum",
            selectCharacter: "Válassza ki karakterét:",
            dontHaveAccount: "Nincs fiókja? Regisztráljon",
            alreadyHaveAccount: "Már van fiókja? Jelentkezzen be",
            rankingXPPlace: "XP rangsor helyezés:",
            games: "Játékok",
            marketplace: "Piactér",
            build: "Építés",
            newGame: "Új játék",
            news: "Hírek",
            ranking: "Rangsor",
            posts: "Bejegyzések",
            startNewGame: "Új játék indítása",
            loginError: "Hibás felhasználónév vagy jelszó.",
            signUpError: "Kérjük, töltse ki az összes kötelező mezőt, és válasszon karaktert.",
            logout: "Kijelentkezés",
            checkThis: "Nézze meg ezt",
            allChatsTitle: "Minden privát és játék chat (Vendég hozzáférés)",
            allChatsDescription: "Ez a tartalom csak a 'guest' felhasználók számára látható, akik 'Freeaccount' jelszóval jelentkeztek be.",
            forgotPassword: "Elfelejtett jelszó?",
            forgotPasswordTitle: "Elfelejtett jelszó",
            forgotPasswordInstructions: "Kérjük, adja meg e-mail címét. Ha van hozzá fiók, elküldjük fiókadatait (felhasználónév és jelszó) e-mailben.",
            sendRecoveryEmail: "Helyreállítási e-mail küldése",
            backToLogin: "Vissza a bejelentkezéshez",
            recoveryEmailSent: "Ha létezik fiók ezzel az e-mail címmel, fiókadatai (felhasználónév: {username}, jelszó: {password}) elküldésre kerültek az e-mail címére. (Szimuláció)",
            recoveryEmailNotFound: "Nincs fiók ezzel az e-mail címmel, vagy nincs e-mail cím megadva a fiókhoz. Kérjük, ellenőrizze e-mail címét, vagy próbálja meg regisztrálni.",
            postsTabTitle: "Közösségi bejegyzések",
            writePostLabel: "Írja meg bejegyzését:",
            publishPostBtn: "Közzététel",
            postContentPlaceholder: "Mi jár a fejében?",
            postPublished: "Bejegyzés sikeresen közzétéve!",
            postEmpty: "A bejegyzés nem lehet üres.",
            overallRanking: "Összesített rangsor",
            weeklyRanking: "Heti rangsor",
            monthlyRanking: "Havi rangsor",
            yearlyRanking: "Éves rangsor",
            globalRankingCountry: "Globális rangsor (ország szerint)",
            rankingTabTitle: "XP rangsor",
            friends: "Barátok",
            search: "Keresés",
            myFriends: "Barátaim",
            noSearchResults: "Nincs találat.",
            addFriend: "Barát hozzáadása",
            alreadyFriends: "Már barátok",
            cannotAddSelf: "Nem adhatja hozzá magát barátként.",
            friendAdded: "{username} felhasználó hozzá lett adva a barátlistájához.",
            noFriendsYet: "Még nincsenek barátai.",
            reportUser: "Jelentés",
            reportUserModalTitle: "Felhasználó jelentése:",
            reportReason: "Válassza ki a jelentés okát:",
            sexualContent: "Szexuális tartalom",
            hateSpeech: "Gyűlöletbeszéd / Csúnya nyelv",
            personalData: "Személyes adatok megosztása",
            maliciousLink: "Ismeretlen/rosszindulatú linkek küldése",
            threats: "Fenyegetések",
            cheating: "Csalás",
            adminImpersonation: "Admin megszemélyesítése",
            passwordSharing: "Más jelszavának megosztása",
            other: "Egyéb",
            additionalComments: "További megjegyzések (opcionális)",
            sendReport: "Jelentés küldése",
            reportSuccess: "Jelentés sikeresen elküldve. Köszönjük!",
            reportNoReason: "Kérjük, válassza ki a jelentés okát.",
            reportCannotReportSelf: "Nem jelentheti magát.",
            noPostsYet: "Még nincsenek bejegyzések. Legyen Ön az első, aki megoszt valamit!",
            noNewsYet: "Jelenleg nincsenek hírek. Nézzen vissza később!",
            gamesWelcomeText: "Üdvözöljük a játékai között! Kezdjen új kalandot, vagy folytasson egy meglévőt.",
            buildNewGame: "Új játék építése",
            myGamesListTitle: "Játékaim",
            publishedGamesListTitle: "Közzétett játékok",
            gameBuilderTitle: "Építse meg játékát:",
            toolHammerLabel: "Kalapács (Blokk elhelyezése)",
            toolEraserLabel: "Radír (Blokk törlése)",
            toolBucketLabel: "Vödör (Blokk színezése)",
            modelsCategory: "Modellek",
            weaponsCategory: "Fegyverek",
            logicCategory: "Logika",
            createNewModel: "Új modell létrehozása",
            selectBlockColor: "Blokk színének kiválasztása",
            takeScreenshot: "Képernyőfelvétel készítése",
            publishGame: "Játék közzététele",
            backToGamesList: "Vissza a játéklistához",
            gamePublishedSuccess: "A(z) '{gameName}' játék sikeresen közzétéve!",
            gameSaved: "A(z) '{gameName}' játék mentve.",
            gameNamePrompt: "Adjon nevet új játékának:",
            selectGameType: "Válassza ki a játék típusát:",
            baseTemple: "Alap templom",
            parkour: "Parkour",
            island: "Sziget",
            playGameTitle: "Játék indítása:",
            playGameInstructions: "Ez egy szimulált játék. Képzelje el, hogy most játszik!",
            returnToGamesList: "Vissza a játéklistához",
            gameNotPublished: "Ez a játék még nincs közzétéve. Nem játszhatja, amíg nem lesz közzétéve.",
            noGamesYet: "Még nem hozott létre játékokat. Kezdjen építeni!",
            noPublishedGames: "Még nincsenek közzétett játékok.",
        }
    };

    // --- Global Utility Functions ---
    const $ = id => document.getElementById(id); // Shorthand for getElementById
    const show = element => element && element.classList.remove("hidden");
    const hide = element => element && element.classList.add("hidden");
    const sanitize = text => String(text).replace(/[<>]/g, ''); // Basic sanitization

    let currentLang = localStorage.getItem('pokregamLang') || 'en'; // Load language from localStorage
    let currentUser = null; // Stores logged-in user data (username, avatar, etc.)
    let users = JSON.parse(localStorage.getItem('pokregamUsers')) || []; // Stores all registered users
    let posts = JSON.parse(localStorage.getItem('pokregamPosts')) || []; // Stores all community posts
    let games = JSON.parse(localStorage.getItem('pokregamGames')) || []; // Stores all games created by users

    // --- User Data Management (Simulated Persistence with Firestore Concept) ---
    // These functions now interact with the global window.saveUserDataToFirestore, etc.
    // which are defined in the Firebase SDK import script.

    async function saveUserToLocalStorage(user) {
        // In a real app, this would be handled by backend/Firestore
        // For simulation, we update the local 'users' array and save to localStorage
        const existingUserIndex = users.findIndex(u => u.username === user.username);
        if (existingUserIndex !== -1) {
            users[existingUserIndex] = { ...users[existingUserIndex], ...user }; // Merge updates
        } else {
            users.push(user);
        }
        localStorage.setItem('pokregamUsers', JSON.stringify(users));
        console.log("User saved/updated in local storage (simulated):", user);

        // Also save to Firestore if authenticated
        if (window.getCurrentUserId()) {
            await window.saveUserDataToFirestore(user);
        }
    }

    async function loadUserFromLocalStorage(username) {
        // In a real app, this would fetch from backend/Firestore
        // For simulation, we load from local 'users' array
        return users.find(u => u.username === username);
    }

    async function updateProfileUI(userData) {
        if (!userData) {
            console.warn("No user data provided to updateProfileUI.");
            return;
        }
        // Use data from Firestore if available, otherwise fallback to local/default
        const dataToDisplay = userData || currentUser;

        if (dataToDisplay) {
            $('profileUsername').textContent = sanitize(dataToDisplay.username || 'N/A');
            $('profileCountry').textContent = sanitize(dataToDisplay.country || 'N/A');
            $('profileXP').textContent = dataToDisplay.xp !== undefined ? dataToDisplay.xp : 0;
            $('profileLevel').textContent = dataToDisplay.level !== undefined ? dataToDisplay.level : 1;
            $('profileFriendsCount').textContent = dataToDisplay.friends ? dataToDisplay.friends.length : 0;
            $('profileGold').textContent = dataToDisplay.gold !== undefined ? dataToDisplay.gold : 0;
            $('profileAvatar').querySelector('img').src = dataToDisplay.avatar || 'https://placehold.co/80x80/cccccc/000000?text=👤';

            // Update ranking place (simulated for now)
            updateRanking();
            loadFriendsList(); // Reload friends list
            loadMyGames(); // Reload user's games
            loadPublishedGames(); // Reload all published games
        } else {
            clearProfileUI();
        }
    }

    function clearProfileUI() {
        $('profileUsername').textContent = '';
        $('profileCountry').textContent = '';
        $('profileXP').textContent = '0';
        $('profileLevel').textContent = '1';
        $('profileFriendsCount').textContent = '0';
        $('profileGold').textContent = '0';
        $('profileAvatar').querySelector('img').src = 'https://placehold.co/80x80/cccccc/000000?text=👤';
        $('profileRankingPlace').textContent = '';
        $('myFriendsList').innerHTML = '';
        $('myGamesList').innerHTML = '';
        $('publishedGamesList').innerHTML = '';
    }

    // --- UI Translation Function ---
    function translateUI(lang) {
        currentLang = lang;
        localStorage.setItem('pokregamLang', lang); // Save selected language
        const t = LANG[lang];

        // Header
        $('navGames').textContent = t.games;
        $('navMarketplace').textContent = t.marketplace;
        $('navBuild').textContent = t.build;
        $('navNews').textContent = t.news;
        $('navRanking').textContent = t.ranking;
        $('btnLogin').textContent = t.login;
        $('btnSignUp').textContent = t.signup;
        $('btnLogout').textContent = t.logout;
        $('checkThisBtn').textContent = t.checkThis;

        // Login Section
        $('loginTitle').textContent = t.login;
        $('loginForm').querySelector('label[for="loginUsername"]').textContent = t.username + ":";
        $('loginForm').querySelector('label[for="loginPassword"]').textContent = t.password + ":";
        $('loginSubmit').textContent = t.login;
        $('loginError').textContent = ""; // Clear error on language change
        $('toSignUp').textContent = t.dontHaveAccount;
        $('forgotPasswordLink').textContent = t.forgotPassword;

        // Sign Up Section
        $('signUpTitle').textContent = t.signup;
        $('selectCharacter').textContent = t.selectCharacter;
        $('signUpForm').querySelector('label[for="signUpUsername"]').textContent = t.username + ":";
        $('signUpForm').querySelector('label[for="signUpEmail"]').textContent = t.email + ":";
        $('signUpForm').querySelector('label[for="signUpCountry"]').textContent = t.country + ":";
        $('signUpForm').querySelector('label[for="signUpPassword"]').textContent = t.password + ":";
        $('signUpForm').querySelector('label[for="signUpBirthdate"]').textContent = t.birthdate + ":";
        $('signUpSubmit').textContent = t.signup;
        $('signUpError').textContent = ""; // Clear error on language change
        $('toLogin').textContent = t.alreadyHaveAccount;

        // Forgot Password Section
        $('forgotPasswordTitle').textContent = t.forgotPasswordTitle;
        $('forgotPasswordInstructions').textContent = t.forgotPasswordInstructions;
        $('forgotPasswordForm').querySelector('label[for="forgotPasswordEmail"]').textContent = t.email + ":";
        $('sendRecoveryEmail').textContent = t.sendRecoveryEmail;
        $('backToLoginFromForgot').textContent = t.backToLogin;
        $('forgotPasswordMessage').textContent = ""; // Clear message
        $('forgotPasswordError').textContent = ""; // Clear error

        // Profile Section
        $('profileUsernameLabel').textContent = t.username + ": ";
        $('profileCountryLabel').textContent = t.country + ": ";
        $('profileRankingPlaceLabel').textContent = t.rankingXPPlace + " ";
        $('profileXPLabel').childNodes[0].nodeValue = "XP: "; // Keep span content
        $('profileLevelLabel').childNodes[0].nodeValue = "Level: ";
        $('profileFriendsCountLabel').childNodes[0].nodeValue = "Friends: ";
        $('profileGoldLabel').childNodes[0].nodeValue = "Gold: ";

        // Profile Tabs
        $('gamesTabButton').textContent = t.games;
        $('marketplaceTabButton').textContent = t.marketplace;
        $('buildTabButton').textContent = t.build;
        $('newGameTabButton').textContent = t.newGame;
        $('newsTabButton').textContent = t.news;
        $('rankingTabButton').textContent = t.ranking;
        $('postsTabButton').textContent = t.posts;
        $('friendsTabButton').textContent = t.friends;

        // Games Tab
        $('gamesTabTitle').textContent = t.games;
        $('gamesWelcomeText').textContent = t.gamesWelcomeText;
        $('buildNewGameBtn').textContent = t.buildNewGame;
        $('myGamesListTitle').textContent = t.myGamesListTitle;
        $('publishedGamesListTitle').textContent = t.publishedGamesListTitle;

        // Marketplace Tab
        $('marketplaceTabTitle').textContent = t.marketplace;
        $('marketplaceDescription').textContent = t.marketplaceDescription;
        $('marketplaceUnderConstruction').textContent = t.marketplaceUnderConstruction;

        // Build Tab
        $('buildTabTitle').textContent = t.build;
        $('buildDescription').textContent = t.buildDescription;
        $('buildUnderConstruction').textContent = t.buildUnderConstruction;

        // New Game Tab
        $('newGameTabTitle').textContent = t.newGame;
        $('newGameDescription').textContent = t.newGameDescription;
        $('newGameComingSoon').textContent = t.newGameComingSoon;

        // News Tab
        $('newsTabTitle').textContent = t.news;
        $('newsDescription').textContent = t.newsDescription;
        $('noNewsYet').textContent = t.noNewsYet;

        // Ranking Tab
        $('rankingTabTitle').textContent = t.rankingTabTitle;
        $('overallRankingBtn').textContent = t.overallRanking;
        $('weeklyRankingBtn').textContent = t.weeklyRanking;
        $('monthlyRankingBtn').textContent = t.monthlyRanking;
        $('yearlyRankingBtn').textContent = t.yearlyRanking;
        $('globalRankingBtn').textContent = t.globalRankingCountry;
        // Update table headers
        const rankingTableHeaders = $('rankingTable').querySelectorAll('th');
        if (rankingTableHeaders.length >= 4) {
            rankingTableHeaders[0].textContent = t.rankingTablePlace || "Place";
            rankingTableHeaders[1].textContent = t.rankingTableUsername || "Username";
            rankingTableHeaders[2].textContent = t.rankingTableXP || "XP";
            rankingTableHeaders[3].textContent = t.rankingTableLevel || "Level";
        }


        // Posts Tab
        $('postsTabTitle').textContent = t.postsTabTitle;
        $('writePostLabel').textContent = t.writePostLabel;
        $('postContent').placeholder = t.postContentPlaceholder;
        $('publishPostBtn').textContent = t.publishPostBtn;
        $('postMessage').textContent = ""; // Clear message

        // Friends Tab
        $('friendsTabTitle').textContent = t.friends;
        $('friendSearchInput').placeholder = t.friendSearchInputPlaceholder;
        $('searchFriendBtn').textContent = t.search;
        $('myFriendsListTitle').textContent = t.myFriends;

        // Game Builder Tab
        $('gameBuilderTitle').textContent = t.gameBuilderTitle;
        $('toolHammerLabel').textContent = t.toolHammerLabel;
        $('toolEraserLabel').textContent = t.toolEraserLabel;
        $('toolBucketLabel').textContent = t.toolBucketLabel;
        $('modelsCategory').textContent = t.modelsCategory;
        $('weaponsCategory').textContent = t.weaponsCategory;
        $('logicCategory').textContent = t.logicCategory;
        $('createNewModelBtn').textContent = t.createNewModel;
        $('selectBlockColorBtn').textContent = t.selectBlockColor;
        $('takeScreenshotBtn').textContent = t.takeScreenshot;
        $('publishGameBtn').textContent = t.publishGame;
        $('backToGamesListBtn').textContent = t.backToGamesList;
        $('gameBuilderMessage').textContent = ""; // Clear message

        // Play Game Tab
        $('playGameTitle').textContent = t.playGameTitle;
        $('playGameInstructions').textContent = t.playGameInstructions;
        $('returnToGamesListBtn').textContent = t.returnToGamesList;

        // All Chats Section (Guest)
        $('allChatsTitle').textContent = t.allChatsTitle;
        $('allChatsDescription').textContent = t.allChatsDescription;

        // Report User Modal
        $('reportUserModalHeader').childNodes[0].nodeValue = t.reportUserModalTitle;
        $('reportReasonLabel').textContent = t.reportReason;
        $('sexualContentReason').textContent = t.sexualContent;
        $('hateSpeechReason').textContent = t.hateSpeech;
        $('personalDataReason').textContent = t.personalData;
        $('maliciousLinkReason').textContent = t.maliciousLink;
        $('threatsReason').textContent = t.threats;
        $('cheatingReason').textContent = t.cheating;
        $('adminImpersonationReason').textContent = t.adminImpersonation;
        $('passwordSharingReason').textContent = t.passwordSharing;
        $('otherReason').textContent = t.other;
        $('reportComment').placeholder = t.additionalComments;
        $('sendReportBtn').textContent = t.sendReport;
        $('reportMessage').textContent = ""; // Clear message
    }

    // --- Avatars Data ---
    const avatars = [
        { id: "avatar1", name: "Smily Boy", src: "https://placehold.co/80x80/cccccc/000000?text=😀" },
        { id: "avatar2", name: "Warrior Girl", src: "https://placehold.co/80x80/cccccc/000000?text=👩‍🎤" },
        { id: "avatar3", name: "Zebra", src: "https://placehold.co/80x80/cccccc/000000?text=🦓" },
        { id: "avatar4", name: "King Of Water", src: "https://placehold.co/80x80/cccccc/000000?text=👑" },
        { id: "avatar5", name: "Robot", src: "https://placehold.co/80x80/cccccc/000000?text=🤖" },
        { id: "avatar6", name: "Cat", src: "https://placehold.co/80x80/cccccc/000000?text=🐱" },
        { id: "avatar7", name: "Dog", src: "https://placehold.co/80x80/cccccc/000000?text=🐶" },
        { id: "avatar8", name: "Alien", src: "https://placehold.co/80x80/cccccc/000000?text=👽" },
        { id: "avatar9", name: "Ninja", src: "https://placehold.co/80x80/cccccc/000000?text=🥷" },
        { id: "avatar10", name: "Wizard", src: "https://placehold.co/80x80/cccccc/000000?text=🧙" }
    ];

    // --- Simulated Chat Data (for Guest Access) ---
    const allChats = [
        {
            type: "private",
            participants: ["UserA", "UserB"],
            messages: [
                { sender: "UserA", text: "Hey, spotkałeś się z tą nową misją?", time: "10:05" },
                { sender: "UserB", text: "Tak, jest super trudna! Potrzebuję pomocy.", time: "10:07" },
                { sender: "UserA", text: "Jasne, mogę pomóc wieczorem.", time: "10:08" }
            ]
        },
        {
            type: "game",
            game: "Dragon Slayer",
            messages: [
                { sender: "Player1", text: "Ktoś na raidzie o 20:00?", time: "11:15" },
                { sender: "Player2", text: "Ja będę!", time: "11:16" },
                { sender: "Player1", text: "Ok, zbieramy ekipę!", time: "11:17" }
            ]
        },
        {
            type: "private",
            participants: ["GraczX", "GraczY"],
            messages: [
                { sender: "GraczX", text: "Widziałeś ten nowy item?", time: "12:01" },
                { sender: "GraczY", text: "O tak, jest niesamowity! Ale drogi...", time: "12:03" }
            ]
        },
        {
            type: "game",
            game: "PoKreGaM Football",
            messages: [
                { sender: "Fanatik", text: "GOOOOOOL!!!", time: "13:30" },
                { sender: "Rywal", text: "Foul! To był faul!", time: "13:31" },
                { sender: "Fanatik", text: "Sędzia puścił, gramy dalej!", time: "13:32" }
            ]
        },
        {
            type: "private",
            participants: ["Admin", "SupportUser"],
            messages: [
                { sender: "Admin", text: "Problem z serwerem rozwiązany.", time: "14:00" },
                { sender: "SupportUser", text: "Dzięki za szybką naprawę!", time: "14:01" }
            ]
        }
    ];

    // --- Core UI Logic ---
    function hideAllSections() {
        document.querySelectorAll('section').forEach(section => hide(section));
    }

    function showSection(sectionElement) {
        hideAllSections();
        show(sectionElement);
    }

    // --- Authentication Logic ---
    async function handleLogin(event) {
        event.preventDefault();
        const username = $('loginUsername').value;
        const password = $('loginPassword').value;
        const loginError = $('loginError');

        // Simulate login (in a real app, this would be backend call)
        const user = users.find(u => u.username === username && u.password === password);

        if (user) {
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Save to local storage for session
            loginError.textContent = '';
            // If authenticated via Firebase, load data from Firestore
            if (window.getCurrentUserId()) {
                const firestoreUserData = await window.loadUserDataFromFirestore();
                if (firestoreUserData) {
                    currentUser = { ...currentUser, ...firestoreUserData }; // Merge data
                }
            }
            updateProfileUI(currentUser);
            showSection($('profileSection'));
        } else {
            loginError.textContent = LANG[currentLang].loginError;
        }
    }

    async function handleSignUp(event) {
        event.preventDefault();
        const username = $('signUpUsername').value;
        const email = $('signUpEmail').value;
        const country = $('signUpCountry').value;
        const password = $('signUpPassword').value;
        const birthdate = $('signUpBirthdate').value;
        const signUpError = $('signUpError');
        const selectedAvatarElement = document.querySelector('.avatar.selected');
        const avatarSrc = selectedAvatarElement ? selectedAvatarElement.querySelector('img').src : null;

        if (!username || !password || !birthdate || !selectedAvatarElement) {
            signUpError.textContent = LANG[currentLang].signUpError;
            return;
        }

        if (users.some(u => u.username === username)) {
            signUpError.textContent = "Username already taken."; // Add to LANG
            return;
        }

        const newUser = {
            username: sanitize(username),
            email: sanitize(email),
            country: sanitize(country),
            password: password, // In real app, hash password!
            birthdate: birthdate,
            avatar: avatarSrc,
            xp: 0,
            level: 1,
            friends: [],
            gold: 0,
            games: [] // Games created by this user
        };

        await saveUserToLocalStorage(newUser); // Save to local storage and Firestore (if auth)
        currentUser = newUser; // Set as current user
        updateProfileUI(currentUser);
        showSection($('profileSection'));
    }

    function handleLogout() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        // In a real app, you'd also sign out from Firebase Auth
        if (window.firebaseAuth) {
            window.firebaseAuth.signOut().then(() => {
                console.log("Signed out from Firebase.");
            }).catch((error) => {
                console.error("Error signing out from Firebase:", error);
            });
        }
        clearProfileUI();
        showSection($('loginSection'));
    }

    async function handleForgotPassword(event) {
        event.preventDefault();
        const email = $('forgotPasswordEmail').value;
        const user = users.find(u => u.email === email);
        const forgotPasswordMessage = $('forgotPasswordMessage');
        const forgotPasswordError = $('forgotPasswordError');

        if (user) {
            // Simulate sending email with credentials
            forgotPasswordMessage.textContent = LANG[currentLang].recoveryEmailSent
                .replace('{username}', user.username)
                .replace('{password}', user.password); // In real app, never send password!
            forgotPasswordError.textContent = '';
        } else {
            forgotPasswordError.textContent = LANG[currentLang].recoveryEmailNotFound;
            forgotPasswordMessage.textContent = '';
        }
    }

    // --- Profile UI Update ---
    // This function is called by Firebase init and login/signup
    // It is defined globally in the Firebase script, but re-defined here for clarity
    // and to ensure all UI elements are handled.
    window.updateProfileUI = function(userData) {
        if (!userData) {
            console.warn("No user data provided to updateProfileUI.");
            return;
        }
        currentUser = { ...currentUser, ...userData }; // Ensure currentUser is up-to-date
        $('profileUsername').textContent = sanitize(currentUser.username || 'N/A');
        $('profileCountry').textContent = sanitize(currentUser.country || 'N/A');
        $('profileXP').textContent = currentUser.xp !== undefined ? currentUser.xp : 0;
        $('profileLevel').textContent = currentUser.level !== undefined ? currentUser.level : 1;
        $('profileFriendsCount').textContent = currentUser.friends ? currentUser.friends.length : 0;
        $('profileGold').textContent = currentUser.gold !== undefined ? currentUser.gold : 0;
        $('profileAvatar').querySelector('img').src = currentUser.avatar || 'https://placehold.co/80x80/cccccc/000000?text=👤';

        updateRanking();
        loadFriendsList();
        loadMyGames();
        loadPublishedGames();
    };


    // --- Tab Switching Logic ---
    function switchTab(tabId) {
        document.querySelectorAll('.tabContent').forEach(tab => hide(tab));
        document.querySelectorAll('#tabs button').forEach(button => button.classList.remove('active'));

        show($(tabId));
        $(`${tabId}Button`).classList.add('active');

        // Specific actions for tabs
        if (tabId === 'rankingTab') {
            updateRanking();
        } else if (tabId === 'postsTab') {
            loadAllPosts();
        } else if (tabId === 'friendsTab') {
            loadFriendsList();
        } else if (tabId === 'gamesTab') {
            loadMyGames();
            loadPublishedGames();
        }
    }

    // --- Avatars Rendering ---
    function renderAvatars() {
        const avatarsContainer = $('avatarsContainer');
        avatarsContainer.innerHTML = '';
        avatars.forEach(avatar => {
            const div = document.createElement('div');
            div.classList.add('avatar');
            div.dataset.id = avatar.id;
            div.innerHTML = `<img src="${avatar.src}" alt="${avatar.name}"><span>${avatar.name}</span>`;
            div.addEventListener('click', () => {
                document.querySelectorAll('.avatar').forEach(a => a.classList.remove('selected'));
                div.classList.add('selected');
            });
            avatarsContainer.appendChild(div);
        });
    }

    // --- Ranking Logic ---
    function updateRanking(type = 'overall') {
        let sortedUsers = [];
        if (type === 'overall') {
            sortedUsers = [...users].sort((a, b) => b.xp - a.xp);
        } else if (type === 'global') {
            // Simulate global ranking by country (e.g., sum XP per country)
            const countryXp = {};
            users.forEach(user => {
                countryXp[user.country] = (countryXp[user.country] || 0) + user.xp;
            });
            sortedUsers = Object.entries(countryXp)
                .map(([country, xp]) => ({ username: country, xp: xp, level: 'N/A' })) // Country as username
                .sort((a, b) => b.xp - a.xp);
        } else {
            // For weekly/monthly/yearly, we'd need timestamps on XP gain,
            // which is not implemented in this simplified version.
            // So for now, they will just show overall.
            sortedUsers = [...users].sort((a, b) => b.xp - a.xp);
        }

        const rankingTableBody = $('rankingTable').querySelector('tbody');
        rankingTableBody.innerHTML = '';

        sortedUsers.forEach((user, index) => {
            const row = rankingTableBody.insertRow();
            const placeCell = row.insertCell();
            const usernameCell = row.insertCell();
            const xpCell = row.insertCell();
            const levelCell = row.insertCell();
            const actionsCell = row.insertCell(); // For report button

            placeCell.textContent = index + 1;
            usernameCell.textContent = sanitize(user.username);
            xpCell.textContent = user.xp;
            levelCell.textContent = user.level;

            if (currentUser && currentUser.username !== user.username) {
                const reportButton = document.createElement('button');
                reportButton.classList.add('report-user-btn');
                reportButton.textContent = LANG[currentLang].reportUser;
                reportButton.addEventListener('click', () => openReportModal(user.username));
                actionsCell.appendChild(reportButton);
            }
        });

        // Update current user's ranking place on profile
        if (currentUser) {
            const userRank = sortedUsers.findIndex(u => u.username === currentUser.username);
            if (userRank !== -1) {
                $('profileRankingPlace').textContent = userRank + 1;
            } else {
                $('profileRankingPlace').textContent = LANG[currentLang].notRanked || 'N/A'; // If user not in ranking (e.g., 0 XP)
            }
        }
    }

    // --- Posts Logic ---
    let unsubscribePosts = null; // To store the unsubscribe function for Firestore listener

    function loadAllPosts() {
        const communityPostsDiv = $('communityPosts');
        communityPostsDiv.innerHTML = ''; // Clear existing posts

        // If already subscribed, unsubscribe first to avoid duplicates
        if (unsubscribePosts) {
            unsubscribePosts();
        }

        // Use Firestore listener for real-time updates
        unsubscribePosts = window.getPostsFromFirestore((fetchedPosts) => {
            communityPostsDiv.innerHTML = ''; // Clear again to re-render all
            if (fetchedPosts.length === 0) {
                communityPostsDiv.innerHTML = `<p>${LANG[currentLang].noPostsYet}</p>`;
                return;
            }
            fetchedPosts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.classList.add('post');

                const postHeader = document.createElement('div');
                postHeader.classList.add('post-header');

                const postAvatar = document.createElement('div');
                postAvatar.classList.add('post-avatar');
                const postAuthorData = users.find(u => u.username === post.authorUsername) || { avatar: 'https://placehold.co/40x40/cccccc/000000?text=👤' };
                postAvatar.innerHTML = `<img src="${postAuthorData.avatar}" alt="${sanitize(post.authorUsername)}">`;

                const postInfo = document.createElement('div');
                postInfo.classList.add('post-info');
                postInfo.innerHTML = `
                    <div class="post-author">${sanitize(post.authorUsername)}</div>
                    <div class="post-time">${new Date(post.timestamp?.toDate ? post.timestamp.toDate() : post.timestamp).toLocaleString()}</div>
                `;

                postHeader.appendChild(postAvatar);
                postHeader.appendChild(postInfo);

                const postContent = document.createElement('div');
                postContent.classList.add('post-content');
                postContent.textContent = sanitize(post.content);

                postElement.appendChild(postHeader);
                postElement.appendChild(postContent);
                communityPostsDiv.appendChild(postElement);
            });
        });
    }


    async function publishPost() {
        const postContent = $('postContent');
        const postMessage = $('postMessage');
        const content = postContent.value.trim();

        if (!currentUser) {
            postMessage.textContent = "You must be logged in to post."; // Add to LANG
            postMessage.classList.remove('success-message');
            postMessage.classList.add('error-message');
            return;
        }

        if (content === "") {
            postMessage.textContent = LANG[currentLang].postEmpty;
            postMessage.classList.remove('success-message');
            postMessage.classList.add('error-message');
            return;
        }

        const success = await window.addPostToFirestore({
            authorUsername: currentUser.username,
            content: content
        });

        if (success) {
            postMessage.textContent = LANG[currentLang].postPublished;
            postMessage.classList.remove('error-message');
            postMessage.classList.add('success-message');
            postContent.value = ''; // Clear textarea
            // Posts will automatically reload due to onSnapshot listener
        } else {
            postMessage.textContent = "Failed to publish post."; // Add to LANG
            postMessage.classList.remove('success-message');
            postMessage.classList.add('error-message');
        }
    }

    // --- Friends Logic ---
    function loadFriendsList() {
        const myFriendsList = $('myFriendsList');
        myFriendsList.innerHTML = '';
        if (currentUser && currentUser.friends && currentUser.friends.length > 0) {
            currentUser.friends.forEach(friendUsername => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${sanitize(friendUsername)}</span><button data-username="${sanitize(friendUsername)}" class="remove-friend-btn">X</button>`; // Add remove button
                li.querySelector('.remove-friend-btn').addEventListener('click', handleRemoveFriend);
                myFriendsList.appendChild(li);
            });
        } else {
            myFriendsList.innerHTML = `<p>${LANG[currentLang].noFriendsYet}</p>`;
        }
    }

    function handleFriendSearch() {
        const searchInput = $('friendSearchInput').value.toLowerCase();
        const searchResultsDiv = $('friendSearchResults');
        searchResultsDiv.innerHTML = '';

        if (searchInput.length < 2) { // Require at least 2 characters for search
            searchResultsDiv.innerHTML = '';
            return;
        }

        const filteredUsers = users.filter(user =>
            user.username.toLowerCase().includes(searchInput) && user.username !== (currentUser ? currentUser.username : '')
        );

        if (filteredUsers.length === 0) {
            searchResultsDiv.innerHTML = `<p>${LANG[currentLang].noSearchResults}</p>`;
            return;
        }

        filteredUsers.forEach(user => {
            const userCard = document.createElement('div');
            userCard.classList.add('user-card');
            userCard.innerHTML = `<span>${sanitize(user.username)}</span>`;

            const addButton = document.createElement('button');
            addButton.textContent = LANG[currentLang].addFriend;
            addButton.dataset.username = user.username;

            if (currentUser && currentUser.friends && currentUser.friends.includes(user.username)) {
                addButton.textContent = LANG[currentLang].alreadyFriends;
                addButton.disabled = true;
            } else if (currentUser && currentUser.username === user.username) {
                addButton.textContent = LANG[currentLang].cannotAddSelf;
                addButton.disabled = true;
            } else {
                addButton.addEventListener('click', handleAddFriend);
            }
            userCard.appendChild(addButton);
            searchResultsDiv.appendChild(userCard);
        });
    }

    async function handleAddFriend(event) {
        if (!currentUser) {
            alert("You must be logged in to add friends."); // Use custom modal in real app
            return;
        }
        const friendUsername = event.target.dataset.username;
        if (currentUser.username === friendUsername) {
            alert(LANG[currentLang].cannotAddSelf); // Use custom modal
            return;
        }
        if (!currentUser.friends.includes(friendUsername)) {
            currentUser.friends.push(friendUsername);
            await saveUserToLocalStorage(currentUser); // Save updated friends list
            loadFriendsList(); // Refresh UI
            alert(LANG[currentLang].friendAdded.replace('{username}', friendUsername)); // Use custom modal
            handleFriendSearch(); // Refresh search results
        }
    }

    async function handleRemoveFriend(event) {
        if (!currentUser) {
            alert("You must be logged in to remove friends.");
            return;
        }
        const friendUsername = event.target.dataset.username;
        currentUser.friends = currentUser.friends.filter(f => f !== friendUsername);
        await saveUserToLocalStorage(currentUser);
        loadFriendsList();
        alert(`Friend ${friendUsername} removed.`); // Add to LANG
    }


    // --- Game Management Logic ---
    let currentBuildingGame = null; // Stores the game being built

    function loadMyGames() {
        const myGamesListDiv = $('myGamesList');
        myGamesListDiv.innerHTML = '';
        if (!currentUser || !currentUser.games || currentUser.games.length === 0) {
            myGamesListDiv.innerHTML = `<p>${LANG[currentLang].noGamesYet}</p>`;
            return;
        }
        currentUser.games.forEach(game => {
            const gameCard = document.createElement('div');
            gameCard.classList.add('game-card');
            gameCard.innerHTML = `
                <h4>${sanitize(game.name)}</h4>
                <p>Type: ${sanitize(game.type)}</p>
                <p>Published: ${game.isPublished ? 'Yes' : 'No'}</p>
                <div class="game-card-actions">
                    <button class="build-game-btn" data-game-id="${game.id}">${LANG[currentLang].build}</button>
                    <button class="play-game-btn" data-game-id="${game.id}" ${!game.isPublished ? 'disabled' : ''}>${LANG[currentLang].games}</button>
                </div>
            `;
            gameCard.querySelector('.build-game-btn').addEventListener('click', () => startBuildingGame(game.id));
            gameCard.querySelector('.play-game-btn').addEventListener('click', () => playGame(game.id));
            myGamesListDiv.appendChild(gameCard);
        });
    }

    function loadPublishedGames() {
        const publishedGamesListDiv = $('publishedGamesList');
        publishedGamesListDiv.innerHTML = '';
        const published = games.filter(game => game.isPublished);

        if (published.length === 0) {
            publishedGamesListDiv.innerHTML = `<p>${LANG[currentLang].noPublishedGames}</p>`;
            return;
        }

        published.forEach(game => {
            const gameCard = document.createElement('div');
            gameCard.classList.add('game-card');
            gameCard.innerHTML = `
                <h4>${sanitize(game.name)}</h4>
                <p>Type: ${sanitize(game.type)}</p>
                <p>Creator: ${sanitize(game.creatorUsername || 'Unknown')}</p>
                <div class="game-card-actions">
                    <button class="play-game-btn" data-game-id="${game.id}">${LANG[currentLang].games}</button>
                </div>
            `;
            gameCard.querySelector('.play-game-btn').addEventListener('click', () => playGame(game.id));
            publishedGamesListDiv.appendChild(gameCard);
        });
    }

    async function buildNewGame() {
        if (!currentUser) {
            alert("You must be logged in to build a new game.");
            return;
        }

        const gameName = prompt(LANG[currentLang].gameNamePrompt);
        if (!gameName || gameName.trim() === '') {
            return;
        }

        const gameType = prompt(`${LANG[currentLang].selectGameType}\n${LANG[currentLang].baseTemple}, ${LANG[currentLang].parkour}, ${LANG[currentLang].island}`);
        if (!gameType || gameType.trim() === '') {
            return;
        }

        const newGameId = `game-${Date.now()}`;
        const newGame = {
            id: newGameId,
            name: sanitize(gameName),
            type: sanitize(gameType),
            creatorId: window.getCurrentUserId(), // Link to Firebase User ID
            creatorUsername: currentUser.username,
            isPublished: false,
            data: {} // Actual game world data (e.g., block positions, models)
        };

        // Add to current user's games list
        if (!currentUser.games) {
            currentUser.games = [];
        }
        currentUser.games.push(newGame);
        await saveUserToLocalStorage(currentUser); // Save updated user with new game

        // Add to global games list (simulated)
        games.push(newGame);
        localStorage.setItem('pokregamGames', JSON.stringify(games));

        startBuildingGame(newGameId);
    }

    function startBuildingGame(gameId) {
        currentBuildingGame = games.find(g => g.id === gameId);
        if (currentBuildingGame) {
            $('currentBuildingGameName').textContent = sanitize(currentBuildingGame.name);
            switchTab('gameBuilderTab');
            // Initialize game builder canvas (placeholder)
            const canvas = $('gameCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 600; // Example size
            canvas.height = 400;
            ctx.fillStyle = '#ADD8E6'; // Light blue background
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#333';
            ctx.font = '20px Arial';
            ctx.fillText(`Building: ${currentBuildingGame.name}`, 50, 200);
            $('gameBuilderMessage').textContent = ''; // Clear message
        } else {
            alert("Game not found for building.");
        }
    }

    async function publishCurrentGame() {
        if (!currentBuildingGame) {
            alert("No game selected for publishing.");
            return;
        }

        currentBuildingGame.isPublished = true;
        // Update the game in the global list and user's list
        const gameIndex = games.findIndex(g => g.id === currentBuildingGame.id);
        if (gameIndex !== -1) {
            games[gameIndex] = currentBuildingGame;
            localStorage.setItem('pokregamGames', JSON.stringify(games));
        }

        const userGameIndex = currentUser.games.findIndex(g => g.id === currentBuildingGame.id);
        if (userGameIndex !== -1) {
            currentUser.games[userGameIndex] = currentBuildingGame;
            await saveUserToLocalStorage(currentUser); // Save updated user with published game
        }

        $('gameBuilderMessage').textContent = LANG[currentLang].gamePublishedSuccess.replace('{gameName}', currentBuildingGame.name);
        $('gameBuilderMessage').classList.remove('error-message');
        $('gameBuilderMessage').classList.add('success-message');

        // Refresh games list in games tab
        loadMyGames();
        loadPublishedGames();
    }

    function playGame(gameId) {
        const gameToPlay = games.find(g => g.id === gameId);
        if (!gameToPlay) {
            alert("Game not found.");
            return;
        }
        if (!gameToPlay.isPublished && gameToPlay.creatorId !== window.getCurrentUserId()) {
             alert(LANG[currentLang].gameNotPublished);
             return;
        }

        $('playingGameName').textContent = sanitize(gameToPlay.name);
        switchTab('playGameSection');
        // Simulate game play on canvas
        const canvas = $('playGameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 600; // Example size
        canvas.height = 400;
        ctx.fillStyle = '#ADD8E6'; // Light blue background
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#333';
        ctx.font = '24px Arial';
        ctx.fillText(`Playing: ${gameToPlay.name}`, 50, 150);
        ctx.font = '16px Arial';
        ctx.fillText(`Type: ${gameToPlay.type}`, 50, 180);
        ctx.fillText(`Creator: ${gameToPlay.creatorUsername}`, 50, 200);
    }

    // --- Report User Modal Logic ---
    let reportTargetUsername = '';

    function openReportModal(username) {
        reportTargetUsername = username;
        $('reportUsernameTarget').textContent = sanitize(username);
        $('reportMessage').textContent = ''; // Clear previous messages
        document.querySelectorAll('input[name="reportReason"]').forEach(radio => radio.checked = false);
        $('reportComment').value = '';
        show($('reportUserModal'));
    }

    function closeReportModal() {
        hide($('reportUserModal'));
        reportTargetUsername = '';
    }

    async function handleReportSubmit(event) {
        event.preventDefault();
        const selectedReason = document.querySelector('input[name="reportReason"]:checked');
        const reportComment = $('reportComment').value.trim();
        const reportMessage = $('reportMessage');

        if (!selectedReason) {
            reportMessage.textContent = LANG[currentLang].reportNoReason;
            reportMessage.classList.remove('success-message');
            reportMessage.classList.add('error-message');
            return;
        }

        if (!currentUser || currentUser.username === reportTargetUsername) {
            reportMessage.textContent = LANG[currentLang].reportCannotReportSelf;
            reportMessage.classList.remove('success-message');
            reportMessage.classList.add('error-message');
            return;
        }

        // Simulate sending report (in a real app, this would be a backend call)
        console.log(`Report from ${currentUser.username} about ${reportTargetUsername}:`);
        console.log(`Reason: ${selectedReason.value}`);
        console.log(`Comment: ${reportComment}`);

        // In a real app, you'd send this data to Firestore or another database
        // e.g., collection(db, `artifacts/${appId}/public/reports`).addDoc(...)

        reportMessage.textContent = LANG[currentLang].reportSuccess;
        reportMessage.classList.remove('error-message');
        reportMessage.classList.add('success-message');

        // Optionally close modal after a short delay
        setTimeout(closeReportModal, 2000);
    }

    // --- Initial Setup and Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        // Render avatars on signup page
        renderAvatars();

        // Load language from localStorage or default to 'en'
        const savedLang = localStorage.getItem('pokregamLang');
        if (savedLang) {
            currentLang = savedLang;
            $('languageSelector').value = savedLang;
        }
        translateUI(currentLang);

        // Check for logged-in user in localStorage
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            // Firebase auth will load data from Firestore if successful
            // updateProfileUI(currentUser); // This will be called by Firebase onAuthStateChanged
            showSection($('profileSection'));
        } else {
            showSection($('loginSection'));
        }

        // --- Event Listeners ---
        // Header Navigation
        $('navGames').addEventListener('click', () => {
            if (currentUser) switchTab('gamesTab'); else showSection($('loginSection'));
        });
        $('navMarketplace').addEventListener('click', () => {
            if (currentUser) switchTab('marketplaceTab'); else showSection($('loginSection'));
        });
        $('navBuild').addEventListener('click', () => {
            if (currentUser) switchTab('buildTab'); else showSection($('loginSection'));
        });
        $('navNews').addEventListener('click', () => {
            if (currentUser) switchTab('newsTab'); else showSection($('loginSection'));
        });
        $('navRanking').addEventListener('click', () => {
            if (currentUser) switchTab('rankingTab'); else showSection($('loginSection'));
        });
        $('btnLogin').addEventListener('click', () => showSection($('loginSection')));
        $('btnSignUp').addEventListener('click', () => showSection($('signUpSection')));

        // Language Selector
        $('languageSelector').addEventListener('change', (e) => translateUI(e.target.value));

        // Login/Signup/Forgot Password Forms
        $('loginForm').addEventListener('submit', handleLogin);
        $('signUpForm').addEventListener('submit', handleSignUp);
        $('forgotPasswordForm').addEventListener('submit', handleForgotPassword);

        $('toSignUp').addEventListener('click', () => showSection($('signUpSection')));
        $('toLogin').addEventListener('click', () => showSection($('loginSection')));
        $('forgotPasswordLink').addEventListener('click', () => showSection($('forgotPasswordSection')));
        $('backToLoginFromForgot').addEventListener('click', () => showSection($('loginSection')));

        // Profile Tabs
        document.querySelectorAll('#tabs button[data-tab]').forEach(button => {
            button.addEventListener('click', () => switchTab(button.dataset.tab));
        });
        $('btnLogout').addEventListener('click', handleLogout);

        // Ranking Type Buttons
        document.querySelectorAll('#rankingTypeButtons button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('#rankingTypeButtons button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                updateRanking(button.dataset.rankingType);
            });
        });

        // Posts
        $('publishPostBtn').addEventListener('click', publishPost);

        // Friends
        $('searchFriendBtn').addEventListener('click', handleFriendSearch);
        $('friendSearchInput').addEventListener('input', handleFriendSearch); // Live search

        // Report Modal
        $('reportUserModal').querySelector('.close-button').addEventListener('click', closeReportModal);
        $('reportForm').addEventListener('submit', handleReportSubmit);

        // Games Tab buttons
        $('buildNewGameBtn').addEventListener('click', buildNewGame);

        // Game Builder actions
        $('takeScreenshotBtn').addEventListener('click', () => alert("Screenshot taken! (Simulated)")); // Add to LANG
        $('publishGameBtn').addEventListener('click', publishCurrentGame);
        $('backToGamesListBtn').addEventListener('click', () => switchTab('gamesTab'));

        // Play Game return button
        $('returnToGamesListBtn').addEventListener('click', () => switchTab('gamesTab'));

        // Guest access to chats
        if (currentUser && currentUser.username === 'guest' && currentUser.password === 'Freeaccount') {
            showSection($('allChatsSection'));
            renderAllChats();
        } else {
            hide($('allChatsSection'));
        }
    });

    // --- Guest Chat Rendering ---
    function renderAllChats() {
        const chatsContent = $('chatsContent');
        chatsContent.innerHTML = '';
        allChats.forEach(chat => {
            const chatContainer = document.createElement('div');
            chatContainer.classList.add('chat-container');

            const chatHeader = document.createElement('div');
            chatHeader.classList.add('chat-header');
            if (chat.type === 'private') {
                chatHeader.textContent = `Private Chat: ${sanitize(chat.participants.join(', '))}`;
            } else if (chat.type === 'game') {
                chatHeader.textContent = `Game Chat: ${sanitize(chat.game)}`;
            }
            chatContainer.appendChild(chatHeader);

            chat.messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message');
                messageElement.innerHTML = `<strong>${sanitize(message.sender)}:</strong> ${sanitize(message.text)} <span style="color:#777; font-size:0.8em;">(${message.time})</span>`;
                chatContainer.appendChild(messageElement);
            });
            chatsContent.appendChild(chatContainer);
        });
    }

    </script>
</body>
</html>
