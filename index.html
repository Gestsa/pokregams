<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoKreGaM</title>
    <link rel="stylesheet" href="style.css"> <style>
        /* Minimal styles for new elements */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f0f0; color: #333; }
        header { background-color: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        header nav button { background: none; border: none; color: white; padding: 10px 15px; cursor: pointer; font-size: 1em; }
        header nav button:hover { background-color: #555; }
        main { padding: 20px; }
        section { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background-color: #0056b3; }
        .error-message { color: red; margin-top: 10px; }
        .success-message { color: green; margin-top: 10px; }
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .profile-avatar img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #007bff; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tabs button { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 1em; border-radius: 4px 4px 0 0; }
        .tabs button.active { background-color: #007bff; color: white; }
        .tabContent { padding-top: 20px; border-top: 1px solid #eee; }
        .ranking-table th, .ranking-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .ranking-table th { background-color: #f2f2f2; }
        .ranking-type-buttons button { margin-right: 5px; }
        .post { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: #f9f9f9; }
        .post-header { display: flex; align-items: center; margin-bottom: 10px; }
        .post-avatar img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .post-author { font-weight: bold; }
        .post-time { font-size: 0.8em; color: #777; }
        .post-content { white-space: pre-wrap; }
        .chat-container { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; background-color: #fcfcfc; }
        .chat-header { font-weight: bold; margin-bottom: 5px; color: #007bff; }
        .chat-message { margin-bottom: 3px; font-size: 0.9em; }

        /* Game Builder Specific Styles */
        #gameBuilderSection { display: flex; flex-direction: column; height: 80vh; }
        #builderHeader { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ddd; }
        #builderHeader button { margin-left: 10px; }
        #builderTools { display: flex; gap: 10px; padding: 10px; border-right: 1px solid #ddd; flex-direction: column; align-items: flex-start; }
        #builderTools button { padding: 8px 12px; }
        #gameEditor { display: flex; flex: 1; overflow: hidden; }
        #gameCanvasContainer { flex: 1; background-color: #222; position: relative; overflow: hidden; border-radius: 8px; }
        #gameCanvasPlaceholder { color: white; text-align: center; padding: 50px; } /* Placeholder for actual canvas */
        #builderPalette { width: 250px; padding: 10px; border-left: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; }
        #blockColorPicker { width: 100%; height: 30px; margin-top: 5px; border: 1px solid #ddd; }
        .palette-section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .palette-section:last-child { border-bottom: none; }
        .palette-item { display: flex; align-items: center; gap: 5px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; padding: 3px; border-radius: 4px; }
        .palette-item:hover { border-color: #007bff; background-color: #f0f8ff; }
        .palette-item.selected { background-color: #e0f0ff; border-color: #0056b3; }
        .palette-item img { width: 30px; height: 30px; object-fit: contain; }
        .color-preview { width: 20px; height: 20px; border: 1px solid #ccc; display: inline-block; vertical-align: middle; margin-right: 5px; }

        #createModelForm input { width: calc(100% - 22px); }
        #createModelForm button { width: 100%; margin-top: 10px; }

        #gamesListContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .game-card { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; text-align: center; padding-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .game-card img { width: 100%; height: 120px; object-fit: cover; border-bottom: 1px solid #eee; }
        .game-card h3 { margin: 10px 0 5px; font-size: 1.2em; }
        .game-card p { font-size: 0.9em; color: #555; margin-bottom: 10px; }
        .game-card button { margin: 5px; padding: 8px 15px; }
    </style>
</head>
<body>
    <header>
        <div class="logo">PoKreGaM</div>
        <nav>
            <button id="navGames" data-lang-key="games">Gry</button>
            <button id="navMarketplace" data-lang-key="marketplace">Rynek</button>
            <button id="navBuild" data-lang-key="build">Buduj</button>
            <button id="navNews" data-lang-key="news">Aktualności</button>
            <button id="navRanking" data-lang-key="ranking">Ranking</button>
            <button id="btnLogout" data-lang-key="logout">Wyloguj</button>
            <select id="languageSelector">
                <option value="en">English</option>
                <option value="pl">Polski</option>
            </select>
        </nav>
    </header>

    <main>
        <section id="loginSection" class="active">
            <h2 data-lang-key="loginTitle">Zaloguj się</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername" data-lang-key="username">Nazwa użytkownika:</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword" data-lang-key="password">Hasło:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" data-lang-key="loginButton">Zaloguj się</button>
                <p id="loginError" class="error-message"></p>
                <p><a href="#" id="forgotPasswordLink" data-lang-key="forgotPassword">Zapomniałem hasła</a></p>
                <p data-lang-key="noAccount">Nie masz konta? <a href="#" id="toSignUp" data-lang-key="signUpLink">Zarejestruj się!</a></p>
            </form>
        </section>

        <section id="signUpSection" class="hidden">
            <h2 data-lang-key="signUpTitle">Zarejestruj się</h2>
            <form id="signUpForm">
                <div class="form-group">
                    <label for="signUpUsername" data-lang-key="username">Nazwa użytkownika:</label>
                    <input type="text" id="signUpUsername" required>
                </div>
                <div class="form-group">
                    <label for="signUpEmail" data-lang-key="email">Email (opcjonalnie, do odzyskiwania hasła):</label>
                    <input type="email" id="signUpEmail">
                </div>
                <div class="form-group">
                    <label for="signUpCountry" data-lang-key="country">Kraj:</label>
                    <select id="signUpCountry" required>
                        <option value="">Wybierz kraj</option>
                        <option value="PL">Polska</option>
                        <option value="US">Stany Zjednoczone</option>
                        <option value="GB">Wielka Brytania</option>
                        <option value="DE">Niemcy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="signUpPassword" data-lang-key="password">Hasło:</label>
                    <input type="password" id="signUpPassword" required>
                </div>
                <div class="form-group">
                    <label for="signUpBirthdate" data-lang-key="birthdate">Data urodzenia:</label>
                    <input type="date" id="signUpBirthdate" required>
                </div>
                <div class="form-group">
                    <label data-lang-key="chooseAvatar">Wybierz awatar:</label>
                    <div id="avatarsContainer" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        </div>
                </div>
                <button type="submit" data-lang-key="signUpButton">Zarejestruj się</button>
                <p id="signUpError" class="error-message"></p>
                <p data-lang-key="haveAccount">Masz już konto? <a href="#" id="toLogin" data-lang-key="loginLink">Zaloguj się!</a></p>
            </form>
        </section>

        <section id="forgotPasswordSection" class="hidden">
            <h2 data-lang-key="forgotPasswordTitle">Odzyskiwanie hasła</h2>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="forgotPasswordEmail" data-lang-key="email">Podaj swój email:</label>
                    <input type="email" id="forgotPasswordEmail" required>
                </div>
                <button type="submit" data-lang-key="sendRecovery">Wyślij hasło</button>
                <p id="forgotPasswordMessage" class="success-message"></p>
                <p id="forgotPasswordError" class="error-message"></p>
                <p><a href="#" id="backToLoginFromForgot" data-lang-key="backToLogin">Powrót do logowania</a></p>
            </form>
        </section>

        <section id="profileSection" class="hidden">
            <div class="profile-header">
                <div id="profileAvatar" class="profile-avatar"><img src="" alt="User avatar"></div>
                <div>
                    <h2 id="profileUsername"></h2>
                    <p data-lang-key="country">Kraj: <span id="profileCountry"></span></p>
                    <p data-lang-key="totalXP">Całkowite XP: <span id="profileXP"></span></p>
                    <p data-lang-key="level">Poziom: <span id="profileLevel"></span></p>
                    <p data-lang-key="rankingPlace">Miejsce w rankingu (Ogólny): <span id="profileRankingPlace"></span></p>
                    <p data-lang-key="friends">Znajomi: <span id="profileFriendsCount"></span></p>
                    <p data-lang-key="gold">Złoto: <span id="profileGold"></span></p>
                </div>
            </div>

            <div class="tabs" id="tabs">
                <button class="tab-button active" data-tab="gamesTab" data-lang-key="games">Gry</button>
                <button class="tab-button" data-tab="marketplaceTab" data-lang-key="marketplace">Rynek</button>
                <button class="tab-button" data-tab="buildTab" data-lang-key="build">Buduj</button>
                <button class="tab-button" data-tab="newsTab" data-lang-key="news">Aktualności</button>
                <button class="tab-button" data-tab="rankingTab" data-lang-key="ranking">Ranking</button>
                <button class="tab-button" data-tab="postsTab" data-lang-key="communityPosts">Posty społeczności</button>
                <button id="checkThisBtn" class="tab-button hidden" data-lang-key="checkThis">Sprawdź to!</button>
            </div>

            <section id="gamesTab" class="tabContent active">
                <h3 data-lang-key="myGames">Moje Gry</h3>
                <button id="startGameBtn" data-lang-key="startNewGame">Wszystkie Gry</button>
                <div id="userGamesList" style="margin-top: 20px;">
                    </div>
            </section>

            <section id="marketplaceTab" class="tabContent hidden">
                <h3 data-lang-key="marketplaceTitle">Rynek</h3>
                <p data-lang-key="marketplaceContent">Tutaj możesz kupować i sprzedawać przedmioty.</p>
                </section>

            <section id="buildTab" class="tabContent hidden">
                <h3 data-lang-key="buildTitle">Buduj Gry</h3>
                <p data-lang-key="buildContent">Twórz własne światy i gry!</p>
                <button id="createNewGameBtn" data-lang-key="buildNewGame">Stwórz Nową Grę</button>
                <div id="createdGamesList" style="margin-top: 20px;">
                    </div>
            </section>

            <section id="newsTab" class="tabContent hidden">
                <h3 data-lang-key="newsTitle">Aktualności</h3>
                <p data-lang-key="newsContent">Bądź na bieżąco z najnowszymi wydarzeniami!</p>
                </section>

            <section id="rankingTab" class="tabContent hidden">
                <h3 data-lang-key="rankingTitle">Rankingi</h3>
                <div id="rankingTypeButtons" class="ranking-type-buttons" style="margin-bottom: 15px;">
                    <button data-ranking-type="overall" class="active" data-lang-key="overallRanking">Ogólny</button>
                    <button data-ranking-type="weekly" data-lang-key="weeklyRanking">Tygodniowy</button>
                    <button data-ranking-type="monthly" data-lang-key="monthlyRanking">Miesięczny</button>
                    <button data-ranking-type="yearly" data-lang-key="yearlyRanking">Roczny</button>
                    <button data-ranking-type="global" data-lang-key="globalRanking">Globalny (wg kraju)</button>
                </div>
                <table id="rankingTable" class="ranking-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th data-lang-key="place">Miejsce</th>
                            <th data-lang-key="username">Nazwa użytkownika</th>
                            <th data-lang-key="xp">XP</th>
                            <th data-lang-key="level">Poziom</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>

            <section id="postsTab" class="tabContent hidden">
                <h3 data-lang-key="communityPosts">Posty Społeczności</h3>
                <div class="form-group">
                    <label for="postContent" data-lang-key="writePost">Napisz coś...</label>
                    <textarea id="postContent" rows="4" placeholder="Podziel się swoimi przemyśleniami..."></textarea>
                </div>
                <button id="publishPostBtn" data-lang-key="publishPost">Opublikuj Post</button>
                <p id="postMessage" class="success-message"></p>
                <div id="communityPosts" style="margin-top: 20px;">
                    </div>
            </section>
        </section>

        <section id="allChatsSection" class="hidden">
            <h2 data-lang-key="allChatsTitle">Wszystkie Czaty</h2>
            <div id="chatsContent">
                </div>
            <button id="backToProfileFromChats" data-lang-key="backToProfile">Powrót do Profilu</button>
        </section>

        <section id="gameBuilderSection" class="hidden">
            <div id="builderHeader">
                <h2 id="builderGameName">Nowa Gra</h2>
                <div>
                    <button id="saveGameBtn" data-lang-key="saveGame">Zapisz</button>
                    <button id="publishGameBtn" data-lang-key="publishGame">Opublikuj Grę</button>
                    <button id="takeScreenshotBtn" data-lang-key="takeScreenshot">Zrób Zdjęcie</button>
                    <button id="exitBuilderBtn" data-lang-key="exitBuilder">Wyjdź</button>
                </div>
            </div>
            <div id="gameEditor">
                <div id="builderTools">
                    <button id="toolHammer" class="builder-tool active" data-tool="hammer">
                        <img src="https://www.flaticon.com/svg/static/icons/svg/188/188941.svg" alt="Młotek" width="24" height="24">
                        <span data-lang-key="toolHammer">Stawiaj Bloki</span>
                    </button>
                    <button id="toolEraser" class="builder-tool" data-tool="eraser">
                        <img src="https://www.flaticon.com/svg/static/icons/svg/1373/1373024.svg" alt="Gumka" width="24" height="24">
                        <span data-lang-key="toolEraser">Usuń Bloki</span>
                    </button>
                    <button id="toolBucket" class="builder-tool" data-tool="bucket">
                        <img src="https://www.flaticon.com/svg/static/icons/svg/253/253018.svg" alt="Wiadro" width="24" height="24">
                        <span data-lang-key="toolBucket">Koloruj Blok</span>
                    </button>
                </div>
                <div id="gameCanvasContainer">
                    <p id="gameCanvasPlaceholder" data-lang-key="gameEditorPlaceholder">
                        Tutaj będzie widok edytora gry. Pomyśl o tym jak o płaszczyźnie 3D, na której możesz stawiać bloki.
                    </p>
                    </div>
                <div id="builderPalette">
                    <div class="palette-section">
                        <h4 data-lang-key="paletteInventory">Ekwipunek</h4>
                        <div id="paletteModels" style="margin-bottom: 10px;">
                            <h5>Modele</h5>
                            <div id="purchasedModelsList">
                                <div class="palette-item" data-item-type="model" data-item-id="model_tree">
                                    <img src="https://www.flaticon.com/svg/static/icons/svg/1050/1050805.svg" alt="Drzewo" width="20" height="20">
                                    <span>Drzewo (symulacja)</span>
                                </div>
                            </div>
                        </div>
                        <div id="paletteWeapons" style="margin-bottom: 10px;">
                            <h5>Bronie</h5>
                            <div id="purchasedWeaponsList">
                                <div class="palette-item" data-item-type="weapon" data-item-id="weapon_sword">
                                    <img src="https://www.flaticon.com/svg/static/icons/svg/148/148782.svg" alt="Miecz" width="20" height="20">
                                    <span>Miecz (symulacja)</span>
                                </div>
                            </div>
                        </div>
                        <div id="paletteLogics">
                            <h5>Logiki</h5>
                            <div id="purchasedLogicsList">
                                <div class="palette-item" data-item-type="logic" data-item-id="logic_trigger">
                                    <img src="https://www.flaticon.com/svg/static/icons/svg/166/166348.svg" alt="Przycisk" width="20" height="20">
                                    <span>Przycisk (symulacja)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="palette-section">
                        <h4 data-lang-key="createNewModel">Stwórz Nowy Model</h4>
                        <form id="createModelForm">
                            <input type="text" id="newModelName" placeholder="Nazwa modelu" required>
                            <input type="text" id="newModelIcon" placeholder="URL ikony (np. z flaticon.com/svg/static/icons/svg/...)" required>
                            <button type="submit" data-lang-key="createModel">Utwórz Model</button>
                        </form>
                    </div>

                    <div class="palette-section">
                        <h4 data-lang-key="blockProperties">Właściwości Bloku</h4>
                        <label for="blockColorPicker" data-lang-key="chooseBlockColor">Wybierz kolor bloku:</label>
                        <input type="color" id="blockColorPicker" value="#007bff">
                        <div id="selectedColorPreview" class="color-preview" style="background-color: #007bff;"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="allGamesSection" class="hidden">
            <h2 data-lang-key="allGamesTitle">Wszystkie Gry</h2>
            <div id="gamesListContainer">
                </div>
            <button id="backToProfileFromAllGames" data-lang-key="backToProfile">Powrót do Profilu</button>
        </section>

    </main>

    <script>
        // Helper function for DOM selection
        const $ = id => document.getElementById(id);
        const hide = el => el.classList.add('hidden');
        const show = el => el.classList.remove('hidden');
        const sanitize = text => {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        };

        // Global variables (should be loaded from a config or API in a real app)
        const avatars = [
            { id: 'avatar1', name: 'Warrior', src: 'https://www.flaticon.com/svg/static/icons/svg/2922/2922506.svg' },
            { id: 'avatar2', name: 'Mage', src: 'https://www.flaticon.com/svg/static/icons/svg/2922/2922513.svg' },
            { id: 'avatar3', name: 'Archer', src: 'https://www.flaticon.com/svg/static/icons/svg/2922/2922500.svg' },
            { id: 'avatar4', name: 'Rogue', src: 'https://www.flaticon.com/svg/static/icons/svg/2922/2922507.svg' },
        ];

        const defaultUserProperties = {
            xp: 0,
            xpWeekly: 0,
            xpMonthly: 0,
            xpYearly: 0,
            gold: 100,
            friends: [],
            lastWeeklyReset: new Date(0).toISOString(),
            lastMonthlyReset: new Date(0).toISOString(),
            lastYearlyReset: new Date(0).toISOString(),
            createdGames: [], // New: Array to store IDs of games created by this user
            purchasedModels: [], // New: Models purchased by the user
            purchasedWeapons: [], // New: Weapons purchased by the user
            purchasedLogics: [], // New: Logics purchased by the user
        };

        let currentLang = 'en'; // Default language

        // Translations (expanded)
        const LANG = {
            en: {
                loginTitle: 'Login',
                username: 'Username:',
                password: 'Password:',
                loginButton: 'Login',
                loginError: 'Invalid username or password.',
                forgotPassword: 'Forgot password?',
                noAccount: 'Don\'t have an account?',
                signUpLink: 'Sign Up!',
                signUpTitle: 'Sign Up',
                email: 'Email (optional, for password recovery):',
                country: 'Country:',
                birthdate: 'Birthdate:',
                chooseAvatar: 'Choose your avatar:',
                signUpButton: 'Sign Up',
                signUpError: 'Please fill in all required fields and select an avatar.',
                haveAccount: 'Already have an account?',
                loginLink: 'Login!',
                forgotPasswordTitle: 'Password Recovery',
                sendRecovery: 'Send Password',
                recoveryEmailSent: 'Your username is: {username}, and your password is: {password}. Please check your email (simulated).',
                recoveryEmailNotFound: 'No account found with that email.',
                backToLogin: 'Back to Login',
                logout: 'Logout',
                games: 'Games',
                marketplace: 'Marketplace',
                build: 'Build',
                news: 'News',
                ranking: 'Ranking',
                communityPosts: 'Community Posts',
                checkThis: 'Check this!',
                totalXP: 'Total XP:',
                level: 'Level:',
                rankingPlace: 'Ranking Place:',
                friends: 'Friends:',
                gold: 'Gold:',
                myGames: 'My Games',
                startNewGame: 'All Games', // Changed from "Start New Game" to "All Games"
                buildNewGame: 'Build New Game',
                marketplaceTitle: 'Marketplace',
                marketplaceContent: 'Here you can buy and sell items.',
                buildTitle: 'Build Games',
                buildContent: 'Create your own worlds and games!',
                newsTitle: 'News',
                newsContent: 'Stay up to date with the latest events!',
                rankingTitle: 'Rankings',
                overallRanking: 'Overall',
                weeklyRanking: 'Weekly',
                monthlyRanking: 'Monthly',
                yearlyRanking: 'Yearly',
                globalRanking: 'Global (by country)',
                place: 'Place',
                xp: 'XP',
                writePost: 'Write something...',
                publishPost: 'Publish Post',
                postEmpty: 'Post content cannot be empty.',
                postPublished: 'Post published successfully!',
                allChatsTitle: 'All Chats',
                backToProfile: 'Back to Profile',
                gameEditorPlaceholder: 'This is where the game editor view would be. Think of it as a 3D plane where you can place blocks.',
                toolHammer: 'Place Blocks',
                toolEraser: 'Erase Blocks',
                toolBucket: 'Color Block',
                paletteInventory: 'Inventory',
                createNewModel: 'Create New Model',
                createModel: 'Create Model',
                blockProperties: 'Block Properties',
                chooseBlockColor: 'Choose block color:',
                saveGame: 'Save Game',
                publishGame: 'Publish Game',
                takeScreenshot: 'Take Screenshot',
                exitBuilder: 'Exit Builder',
                baseTemplate: 'Base Template',
                parkourTemplate: 'Parkour',
                islandTemplate: 'Island',
                selectGameTemplate: 'Select a game template:',
                gameName: 'Game Name:',
                startGame: 'Start Game',
                editGame: 'Edit Game',
                allGamesTitle: 'All Games',
                noGamesYet: 'No games available. Be the first to create one!'

            },
            pl: {
                loginTitle: 'Zaloguj się',
                username: 'Nazwa użytkownika:',
                password: 'Hasło:',
                loginButton: 'Zaloguj się',
                loginError: 'Nieprawidłowa nazwa użytkownika lub hasło.',
                forgotPassword: 'Zapomniałem hasła?',
                noAccount: 'Nie masz konta?',
                signUpLink: 'Zarejestruj się!',
                signUpTitle: 'Zarejestruj się',
                email: 'Email (opcjonalnie, do odzyskiwania hasła):',
                country: 'Kraj:',
                birthdate: 'Data urodzenia:',
                chooseAvatar: 'Wybierz awatar:',
                signUpButton: 'Zarejestruj się',
                signUpError: 'Proszę wypełnić wszystkie wymagane pola i wybrać awatar.',
                haveAccount: 'Masz już konto?',
                loginLink: 'Zaloguj się!',
                forgotPasswordTitle: 'Odzyskiwanie hasła',
                sendRecovery: 'Wyślij hasło',
                recoveryEmailSent: 'Twoja nazwa użytkownika to: {username}, a Twoje hasło to: {password}. Sprawdź swoją skrzynkę e-mail (symulacja).',
                recoveryEmailNotFound: 'Nie znaleziono konta z podanym adresem e-mail.',
                backToLogin: 'Powrót do logowania',
                logout: 'Wyloguj',
                games: 'Gry',
                marketplace: 'Rynek',
                build: 'Buduj',
                news: 'Aktualności',
                ranking: 'Ranking',
                communityPosts: 'Posty społeczności',
                checkThis: 'Sprawdź to!',
                totalXP: 'Całkowite XP:',
                level: 'Poziom:',
                rankingPlace: 'Miejsce w rankingu:',
                friends: 'Znajomi:',
                gold: 'Złoto:',
                myGames: 'Moje Gry',
                startNewGame: 'Wszystkie Gry', // Zmieniono z "Rozpocznij Nową Grę" na "Wszystkie Gry"
                buildNewGame: 'Stwórz Nową Grę',
                marketplaceTitle: 'Rynek',
                marketplaceContent: 'Tutaj możesz kupować i sprzedawać przedmioty.',
                buildTitle: 'Buduj Gry',
                buildContent: 'Twórz własne światy i gry!',
                newsTitle: 'Aktualności',
                newsContent: 'Bądź na bieżąco z najnowszymi wydarzeniami!',
                rankingTitle: 'Rankingi',
                overallRanking: 'Ogólny',
                weeklyRanking: 'Tygodniowy',
                monthlyRanking: 'Miesięczny',
                yearlyRanking: 'Roczny',
                globalRanking: 'Globalny (wg kraju)',
                place: 'Miejsce',
                xp: 'XP',
                writePost: 'Napisz coś...',
                publishPost: 'Opublikuj Post',
                postEmpty: 'Treść postu nie może być pusta.',
                postPublished: 'Post opublikowany pomyślnie!',
                allChatsTitle: 'Wszystkie Czaty',
                backToProfile: 'Powrót do Profilu',
                gameEditorPlaceholder: 'Tutaj będzie widok edytora gry. Pomyśl o tym jak o płaszczyźnie 3D, na której możesz stawiać bloki.',
                toolHammer: 'Stawiaj Bloki',
                toolEraser: 'Usuń Bloki',
                toolBucket: 'Koloruj Blok',
                paletteInventory: 'Ekwipunek',
                createNewModel: 'Stwórz Nowy Model',
                createModel: 'Utwórz Model',
                blockProperties: 'Właściwości Bloku',
                chooseBlockColor: 'Wybierz kolor bloku:',
                saveGame: 'Zapisz Grę',
                publishGame: 'Opublikuj Grę',
                takeScreenshot: 'Zrób Zdjęcie',
                exitBuilder: 'Wyjdź z Budowania',
                baseTemplate: 'Szablon Bazowy',
                parkourTemplate: 'Parkour',
                islandTemplate: 'Wyspa',
                selectGameTemplate: 'Wybierz szablon gry:',
                gameName: 'Nazwa Gry:',
                startGame: 'Rozpocznij Grę',
                editGame: 'Edytuj Grę',
                allGamesTitle: 'Wszystkie Gry',
                noGamesYet: 'Brak dostępnych gier. Bądź pierwszym, który stworzy!'
            }
        };

        function translateUI(lang) {
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.dataset.langKey;
                if (LANG[lang] && LANG[lang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.placeholder = LANG[lang][key];
                    } else if (element.tagName === 'OPTION') {
                        element.textContent = LANG[lang][key];
                    } else {
                        element.textContent = LANG[lang][key];
                    }
                }
            });
            // Update profile section if it's active
            const currentUser = getCurrentUser();
            if ($('profileSection').classList.contains('active') && currentUser) {
                renderProfile(currentUser);
            }
             if ($('gameBuilderSection').classList.contains('active')) {
                // Update specific elements in builder that don't use data-lang-key easily
                // For example, the h2 for game name will be set dynamically
             }
        }


        // --- LocalStorage user handling ---
        function getUsers() {
            let users = JSON.parse(localStorage.getItem('PoKreGaM_users') || '[]');
            let updatedUsers = false;

            // Ensure legacy users have reset tracking dates (excluding lastDailyReset)
            users = users.map(user => {
                const newUser = { ...user }; // Create a copy to modify

                if (newUser.lastWeeklyReset === undefined) {
                    Object.assign(newUser, {
                        lastWeeklyReset: new Date(0).toISOString(),
                        lastMonthlyReset: new Date(0).toISOString(),
                        lastYearlyReset: new Date(0).toISOString(),
                    });
                    updatedUsers = true;
                }
                // If xpDaily exists from previous version, remove it
                if (newUser.xpDaily !== undefined) {
                    delete newUser.xpDaily;
                    updatedUsers = true;
                }
                if (newUser.lastDailyReset !== undefined) {
                    delete newUser.lastDailyReset;
                    updatedUsers = true;
                }
                // Ensure new default properties for existing users
                for (const prop in defaultUserProperties) {
                    if (newUser[prop] === undefined) {
                        // Special handling for objects/arrays to avoid shallow copy issues
                        if (Array.isArray(defaultUserProperties[prop])) {
                            newUser[prop] = [...defaultUserProperties[prop]];
                        } else if (typeof defaultUserProperties[prop] === 'object' && defaultUserProperties[prop] !== null) {
                            newUser[prop] = { ...defaultUserProperties[prop] };
                        } else {
                            newUser[prop] = defaultUserProperties[prop];
                        }
                        updatedUsers = true;
                    }
                }
                return newUser;
            });

            // Ensure "guest" account exists for demonstration and has all new fields
            if (!users.some(u => u.username === 'guest')) {
                users.push({
                    username: 'guest',
                    password: 'Freeaccount',
                    ...defaultUserProperties,
                });
                updatedUsers = true;
            }

            // Add a sample user with email for recovery demo and ranking demo
            if (!users.some(u => u.username === 'testuser')) {
                users.push({
                    username: 'testuser',
                    email: 'test@example.com',
                    country: 'US',
                    password: 'testpassword',
                    birthdate: '1990-05-15',
                    avatarId: 'avatar2',
                    avatarName: 'Mage',
                    xp: 150,
                    xpWeekly: 50,
                    xpMonthly: 100,
                    xpYearly: 150,
                    gold: 50,
                    friends: [],
                    lastWeeklyReset: getKiritimatiDate().toISOString(), // Set current date to avoid immediate reset
                    lastMonthlyReset: getKiritimatiDate().toISOString(),
                    lastYearlyReset: getKiritimatiDate().toISOString(),
                    createdGames: ['game-123', 'game-456'], // Sample created games
                    purchasedModels: ['model_tree'],
                    purchasedWeapons: ['weapon_sword'],
                    purchasedLogics: ['logic_trigger'],
                });
                updatedUsers = true;
            }
            if (!users.some(u => u.username === 'playerPL')) {
                users.push({
                    username: 'playerPL',
                    email: 'playerPL@example.com',
                    country: 'PL',
                    password: 'password',
                    birthdate: '1995-01-01',
                    avatarId: 'avatar3',
                    avatarName: 'Archer',
                    xp: 200,
                    xpWeekly: 70,
                    xpMonthly: 120,
                    xpYearly: 200,
                    gold: 70,
                    friends: [],
                    lastWeeklyReset: getKiritimatiDate().toISOString(),
                    lastMonthlyReset: getKiritimatiDate().toISOString(),
                    lastYearlyReset: getKiritimatiDate().toISOString(),
                    createdGames: [],
                    purchasedModels: [],
                    purchasedWeapons: [],
                    purchasedLogics: [],
                });
                updatedUsers = true;
            }

            if (updatedUsers) {
                localStorage.setItem('PoKreGaM_users', JSON.stringify(users));
            }
            return users;
        }

        function saveUsers(users) {
            localStorage.setItem('PoKreGaM_users', JSON.stringify(users));
        }

        function getCurrentUser() {
            const username = localStorage.getItem('PoKreGaM_currentUser');
            if (!username) return null;
            const users = getUsers();
            return users.find(u => u.username === username) || null;
        }

        function setCurrentUser(username) {
            if (username) localStorage.setItem('PoKreGaM_currentUser', username);
            else localStorage.removeItem('PoKreGaM_currentUser');
        }

        // --- LocalStorage posts handling ---
        function getPosts() {
            return JSON.parse(localStorage.getItem('PoKreGaM_posts') || '[]');
        }

        function savePosts(posts) {
            localStorage.setItem('PoKreGaM_posts', JSON.stringify(posts));
        }

        // --- LocalStorage games handling (NEW) ---
        function getGames() {
            // Games include created, saved, and published games
            return JSON.parse(localStorage.getItem('PoKreGaM_games') || '[]');
        }

        function saveGames(games) {
            localStorage.setItem('PoKreGaM_games', JSON.stringify(games));
        }

        // --- Utilities ---
        function calculateLevel(xp) {
            return Math.floor(Math.sqrt(xp / 10)) + 1;
        }

        // --- Kiritimati Time (UTC+14) Helpers ---
        function getKiritimatiDate() {
            const now = new Date();
            const utcNow = new Date(now.getTime() + now.getTimezoneOffset() * 60000); // Convert local time to UTC
            const kiritimatiTime = new Date(utcNow.getTime() + (14 * 3600 * 1000)); // Add 14 hours for UTC+14
            return kiritimatiTime;
        }

        function getKiritimatiDateComponents(dateObj) {
            const year = dateObj.getUTCFullYear();
            const month = dateObj.getUTCMonth(); // 0-11
            const day = dateObj.getUTCDate();
            const dayOfWeek = dateObj.getUTCDay(); // 0=Sunday, 6=Saturday

            // Calculate start of week (Monday in UTC+14)
            const startOfWeek = new Date(dateObj);
            const dayOffset = startOfWeek.getUTCDay(); // 0 (Sunday) to 6 (Saturday)
            const daysToMonday = (dayOffset === 0) ? 6 : dayOffset - 1; // Days to subtract to get to Monday
            startOfWeek.setUTCDate(startOfWeek.getUTCDate() - daysToMonday);
            startOfWeek.setUTCHours(0, 0, 0, 0); // Normalize to start of Monday

            return {
                year: year,
                month: month,
                day: day,
                startOfWeekISO: startOfWeek.toISOString().split('T')[0] // YYYY-MM-DD of Monday
            };
        }

        // --- Ranking Reset Logic (UPDATED) ---
        function handleRankingResets() {
            let resetDates = JSON.parse(localStorage.getItem('PoKreGaM_lastResetDates') || '{}');
            const users = getUsers();
            let changed = false;

            const kiritimatiNow = getKiritimatiDate();
            const currentComponents = getKiritimatiDateComponents(kiritimatiNow);

            const nowISO = kiritimatiNow.toISOString();

            // Initialize resetDates if they don't exist or are older than epoch (excluding daily)
            if (!resetDates.weekly || new Date(resetDates.weekly).getTime() === new Date(0).getTime()) {
                resetDates.weekly = nowISO;
                changed = true;
            }
            if (!resetDates.monthly || new Date(resetDates.monthly).getTime() === new Date(0).getTime()) {
                resetDates.monthly = nowISO;
                changed = true;
            }
            if (!resetDates.yearly || new Date(resetDates.yearly).getTime() === new Date(0).getTime()) {
                resetDates.yearly = nowISO;
                changed = true;
            }

            // --- No Daily Reset anymore ---

            // Weekly Reset
            const lastWeeklyResetDate = new Date(resetDates.weekly);
            const lastWeeklyComponents = getKiritimatiDateComponents(lastWeeklyResetDate);
            if (lastWeeklyComponents.startOfWeekISO !== currentComponents.startOfWeekISO) {
                users.forEach(user => user.xpWeekly = 0);
                resetDates.weekly = nowISO;
                changed = true;
            }

            // Monthly Reset
            const lastMonthlyResetDate = new Date(resetDates.monthly);
            const lastMonthlyComponents = getKiritimatiDateComponents(lastMonthlyResetDate);
            if (lastMonthlyComponents.year !== currentComponents.year ||
                lastMonthlyComponents.month !== currentComponents.month) {
                users.forEach(user => user.xpMonthly = 0);
                resetDates.monthly = nowISO;
                changed = true;
            }

            // Yearly Reset
            const lastYearlyResetDate = new Date(resetDates.yearly);
            const lastYearlyComponents = getKiritimatiDateComponents(lastYearlyResetDate);
            if (lastYearlyComponents.year !== currentComponents.year) {
                users.forEach(user => user.xpYearly = 0);
                resetDates.yearly = nowISO;
                changed = true;
            }

            // Clean up old 'daily' reset entry if it exists
            if (resetDates.daily !== undefined) {
                delete resetDates.daily;
                changed = true;
            }


            if (changed) {
                saveUsers(users); // Save users with reset XP
                localStorage.setItem('PoKreGaM_lastResetDates', JSON.stringify(resetDates));
                console.log('Ranking resets applied.');
            }
        }


        // --- Render profile ---
        function renderProfile(user) {
            if (!user) return;
            $('profileAvatar').querySelector('img').src = avatars.find(a => a.id === user.avatarId)?.src || '';
            $('profileAvatar').querySelector('img').alt = user.avatarName || 'User avatar';
            $('profileUsername').textContent = user.username;
            $('profileCountry').textContent = user.country;
            $('profileXP').textContent = user.xp;
            $('profileFriendsCount').textContent = user.friends?.length || 0;
            $('profileGold').textContent = user.gold;
            $('profileLevel').textContent = calculateLevel(user.xp);
            // Ranking place calculation (uses overall XP for profile header)
            const users = getUsers().sort((a, b) => b.xp - a.xp);
            const place = users.findIndex(u => u.username === user.username) + 1;
            $('profileRankingPlace').textContent = place;

            // Show/hide "Check this" button for guest
            if (user.username === 'guest') {
                show($('checkThisBtn'));
            } else {
                hide($('checkThisBtn'));
            }
        }

        // --- Render ranking table (updated to accept type) ---
        function renderRankingTable(rankingType = 'overall') { // Default to overall
            const tbody = $('rankingTable').querySelector('tbody');
            let users = getUsers();
            const currentUser = getCurrentUser();

            // Filter for global (by country) ranking
            if (rankingType === 'global' && currentUser) {
                users = users.filter(user => user.country === currentUser.country);
            }

            // Determine which XP field to use for sorting
            let xpField = 'xp'; // Default to overall XP
            if (rankingType === 'weekly') xpField = 'xpWeekly';
            else if (rankingType === 'monthly') xpField = 'xpMonthly';
            else if (rankingType === 'yearly') xpField = 'xpYearly';
            // If rankingType is 'overall' or 'global', it already points to 'xp'

            // Sort users by the selected XP field
            users.sort((a, b) => b[xpField] - a[xpField]);

            tbody.innerHTML = '';
            users.forEach((u, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i+1}</td><td>${sanitize(u.username)}</td><td>${u[xpField]}</td><td>${calculateLevel(u[xpField])}</td>`;
                tbody.appendChild(tr);
            });
        }

        // --- Render posts ---
        function renderPosts() {
            const communityPostsDiv = $('communityPosts');
            communityPostsDiv.innerHTML = ''; // Clear previous posts
            const posts = getPosts().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort newest first

            if (posts.length === 0) {
                communityPostsDiv.innerHTML = `<p style="text-align: center; color: #888;">${LANG[currentLang].noPostsYet || 'No posts yet. Be the first to share something!'}</p>`;
                return;
            }

            posts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.classList.add('post');

                const user = getUsers().find(u => u.username === post.username);
                const avatarSrc = user ? avatars.find(a => a.id === user.avatarId)?.src : '';
                const avatarAlt = user ? user.avatarName : 'Unknown';

                postDiv.innerHTML = `
                    <div class="post-header">
                        <div class="post-avatar">
                            <img src="${avatarSrc}" alt="${avatarAlt}">
                        </div>
                        <div class="post-info">
                            <div class="post-author">${sanitize(post.username)}</div>
                            <div class="post-time">${new Date(post.timestamp).toLocaleString(currentLang)}</div>
                        </div>
                    </div>
                    <div class="post-content">${sanitize(post.content)}</div>
                `;
                communityPostsDiv.appendChild(postDiv);
            });
        }

        // --- Render avatars for signup ---
        function renderAvatars() {
            const avatarsContainer = $('avatarsContainer');
            avatarsContainer.innerHTML = '';
            avatars.forEach(avatar => {
                const div = document.createElement('div');
                div.classList.add('avatar');
                div.dataset.avatarId = avatar.id;
                div.setAttribute('tabindex', '0'); // Make it focusable
                div.setAttribute('role', 'button'); // Indicate it's interactive
                div.setAttribute('aria-label', `Select ${avatar.name} avatar`);
                div.innerHTML = `<img src="${avatar.src}" alt="${avatar.name}" width="50" height="50">`;
                avatarsContainer.appendChild(div);
            });
        }

        // --- Clear inputs ---
        function clearInputs(form) {
            form.querySelectorAll('input').forEach(i => i.value = '');
            form.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            form.querySelectorAll('textarea').forEach(t => t.value = '');
        }

        // --- Show/hide sections ---
        function showSection(sectionElement) {
            // Hide all main sections
            ['loginSection', 'signUpSection', 'profileSection', 'allChatsSection', 'forgotPasswordSection', 'gameBuilderSection', 'allGamesSection'].forEach(id => {
                hide($(id));
            });
            // Show the requested section
            show(sectionElement);
        }

        // --- Render all chats for guest ---
        function renderAllChats() {
            const chatsContent = $('chatsContent');
            chatsContent.innerHTML = ''; // Clear previous content

            allChats.forEach(chat => {
                const chatContainer = document.createElement('div');
                chatContainer.classList.add('chat-container');

                let headerText = '';
                if (chat.type === 'private') {
                    headerText = `Private Chat (${chat.participants.join(' & ')})`;
                } else if (chat.type === 'game') {
                    headerText = `Game Chat: ${chat.game}`;
                }

                const chatHeader = document.createElement('div');
                chatHeader.classList.add('chat-header');
                chatHeader.textContent = headerText;
                chatContainer.appendChild(chatHeader);

                chat.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('chat-message');
                    messageDiv.innerHTML = `[${msg.time}] <strong>${sanitize(msg.sender)}:</strong> ${sanitize(msg.text)}`;
                    chatContainer.appendChild(messageDiv);
                });
                chatsContent.appendChild(chatContainer);
            });
        }

        // Dummy chat data for guest user
        const allChats = [
            {
                type: 'game',
                game: 'Adventure Quest',
                messages: [
                    { sender: 'GameMaster', text: 'Welcome to Adventure Quest!', time: '10:00' },
                    { sender: 'guest', text: 'Hey everyone!', time: '10:01' },
                    { sender: 'PlayerX', text: 'Anyone for a dungeon run?', time: '10:05' },
                ]
            },
            {
                type: 'private',
                participants: ['guest', 'BotFriend'],
                messages: [
                    { sender: 'BotFriend', text: 'Hi guest! How are you?', time: '11:15' },
                    { sender: 'guest', text: 'I\'m doing great, thanks!', time: '11:16' },
                ]
            }
        ];


        // --- Selected avatar for signup ---
        let selectedAvatarId = null;

        // --- Game Builder State (NEW) ---
        let currentGame = null; // Currently loaded game in the builder
        let currentTool = 'hammer'; // Default tool: hammer
        let currentBlockColor = '#007bff'; // Default block color
        let currentPaletteItem = null; // Currently selected item from palette (model, weapon, logic)

        const gameTemplates = {
            'base': {
                id: 'base-template',
                name: 'Base Template',
                description: 'A flat, empty world to start from scratch.',
                thumbnail: 'https://via.placeholder.com/150/EEEEEE/808080?text=Base',
                initialMap: [], // Simplified: represents an empty map
            },
            'parkour': {
                id: 'parkour-template',
                name: 'Parkour',
                description: 'A template with some basic platforms for parkour.',
                thumbnail: 'https://via.placeholder.com/150/FFD700/FFFFFF?text=Parkour',
                initialMap: [{ x: 0, y: 0, z: 0, color: 'red' }, { x: 1, y: 1, z: 0, color: 'blue' }], // Simplified map
            },
            'island': {
                id: 'island-template',
                name: 'Island',
                description: 'A small island surrounded by water.',
                thumbnail: 'https://via.placeholder.com/150/87CEEB/FFFFFF?text=Island',
                initialMap: [{ x: 0, y: 0, z: 0, color: 'green' }], // Simplified map
            }
        };

        // --- Render created games for 'Build' tab (NEW) ---
        function renderCreatedGames() {
            const currentUser = getCurrentUser();
            const createdGamesListDiv = $('createdGamesList');
            createdGamesListDiv.innerHTML = '';

            if (!currentUser || currentUser.createdGames.length === 0) {
                createdGamesListDiv.innerHTML = `<p style="text-align: center; color: #888;">${LANG[currentLang].noCreatedGamesYet || 'You haven\'t created any games yet.'}</p>`;
                return;
            }

            const allGames = getGames();
            const userCreatedGames = allGames.filter(game => currentUser.createdGames.includes(game.id));

            userCreatedGames.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.classList.add('game-card');
                gameCard.innerHTML = `
                    <img src="${game.thumbnail || 'https://via.placeholder.com/150/CCCCCC/555555?text=Game'}" alt="${sanitize(game.name)} Thumbnail">
                    <h3>${sanitize(game.name)}</h3>
                    <p>Status: ${game.published ? 'Opublikowana' : 'Szkic'}</p>
                    <button data-game-id="${game.id}" class="edit-game-btn" data-lang-key="editGame">Edytuj</button>
                `;
                createdGamesListDiv.appendChild(gameCard);
            });

            // Add event listeners for edit buttons
            createdGamesListDiv.querySelectorAll('.edit-game-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const gameId = e.target.dataset.gameId;
                    loadGameIntoBuilder(gameId);
                });
            });
        }

        // --- Render all published games for 'All Games' section (NEW) ---
        function renderAllPublishedGames() {
            const gamesListContainer = $('gamesListContainer');
            gamesListContainer.innerHTML = '';

            const allGames = getGames();
            const publishedGames = allGames.filter(game => game.published);

            if (publishedGames.length === 0) {
                gamesListContainer.innerHTML = `<p style="text-align: center; color: #888;">${LANG[currentLang].noGamesYet}</p>`;
                return;
            }

            publishedGames.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.classList.add('game-card');
                gameCard.innerHTML = `
                    <img src="${game.thumbnail || 'https://via.placeholder.com/150/CCCCCC/555555?text=Game'}" alt="${sanitize(game.name)} Thumbnail">
                    <h3>${sanitize(game.name)}</h3>
                    <p>Autor: ${sanitize(game.creator)}</p>
                    <button data-game-id="${game.id}" class="play-game-btn" data-lang-key="startGame">Graj</button>
                `;
                gamesListContainer.appendChild(gameCard);
            });

            // Add event listeners for play buttons
            gamesListContainer.querySelectorAll('.play-game-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const gameId = e.target.dataset.gameId;
                    alert(`Symulacja: Rozpoczynanie gry "${getGames().find(g => g.id === gameId)?.name}". Fajnej zabawy!`);
                    // Here you would typically navigate to a separate game play screen
                });
            });
        }


        // --- Load Game into Builder (NEW) ---
        function loadGameIntoBuilder(gameId) {
            const allGames = getGames();
            currentGame = allGames.find(g => g.id === gameId);

            if (!currentGame) {
                alert('Gra nie została znaleziona!');
                return;
            }

            $('builderGameName').textContent = sanitize(currentGame.name);
            showSection($('gameBuilderSection'));
            // TODO: In a real app, load the game's actual map data and assets into the canvas/editor.
            // For this simulation, we just update the UI state.
            updateBuilderPalette(); // Update palette with user's purchased items
        }

        // --- Update Builder Palette (NEW) ---
        function updateBuilderPalette() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;

            const purchasedModelsList = $('purchasedModelsList');
            const purchasedWeaponsList = $('purchasedWeaponsList');
            const purchasedLogicsList = $('purchasedLogicsList');

            // Clear previous lists
            purchasedModelsList.innerHTML = '';
            purchasedWeaponsList.innerHTML = '';
            purchasedLogicsList.innerHTML = '';

            // Add purchased models
            currentUser.purchasedModels.forEach(modelId => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('palette-item');
                itemDiv.dataset.itemType = 'model';
                itemDiv.dataset.itemId = modelId;
                // In a real app, you'd fetch model details (name, icon) from a central "models" array
                itemDiv.innerHTML = `<img src="https://via.placeholder.com/20?text=${modelId.charAt(0).toUpperCase()}" alt="${modelId}"><span>${modelId.replace('model_', '')}</span>`;
                purchasedModelsList.appendChild(itemDiv);
            });

            // Add purchased weapons
            currentUser.purchasedWeapons.forEach(weaponId => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('palette-item');
                itemDiv.dataset.itemType = 'weapon';
                itemDiv.dataset.itemId = weaponId;
                itemDiv.innerHTML = `<img src="https://via.placeholder.com/20?text=${weaponId.charAt(0).toUpperCase()}" alt="${weaponId}"><span>${weaponId.replace('weapon_', '')}</span>`;
                purchasedWeaponsList.appendChild(itemDiv);
            });

            // Add purchased logics
            currentUser.purchasedLogics.forEach(logicId => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('palette-item');
                itemDiv.dataset.itemType = 'logic';
                itemDiv.dataset.itemId = logicId;
                itemDiv.innerHTML = `<img src="https://via.placeholder.com/20?text=${logicId.charAt(0).toUpperCase()}" alt="${logicId}"><span>${logicId.replace('logic_', '')}</span>`;
                purchasedLogicsList.appendChild(itemDiv);
            });
        }


        // --- Init app ---
        function init() {
            // Ensure user data structure is up-to-date and apply resets
            getUsers(); // This call also updates old user objects
            handleRankingResets(); // Apply any necessary XP resets based on Kiritimati time

            // Fill avatars
            renderAvatars();

            // On avatar click
            $('avatarsContainer').addEventListener('click', e => {
                let target = e.target;
                while (target && !target.classList.contains('avatar')) {
                    target = target.parentElement;
                }
                if (target) {
                    // Remove previous selection
                    document.querySelectorAll('.avatar.selected').forEach(el => el.classList.remove('selected'));
                    target.classList.add('selected');
                    selectedAvatarId = target.dataset.avatarId;
                }
            });
            // Also keyboard select avatar
            $('avatarsContainer').addEventListener('keydown', e => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    e.target.click();
                }
            });

            // Show login form initially or profile if logged in
            const currentUser = getCurrentUser();
            if (currentUser) {
                showSection($('profileSection'));
                renderProfile(currentUser);
                renderRankingTable('overall'); // Render default overall ranking
                renderCreatedGames(); // Render user's created games
            } else {
                showSection($('loginSection'));
            }

            // Language selection
            const langSelector = $('languageSelector');
            currentLang = langSelector.value;
            translateUI(currentLang);
            langSelector.addEventListener('change', () => {
                currentLang = langSelector.value;
                translateUI(currentLang);
            });

            // Navigation tabs for profile section
            $('tabs').addEventListener('click', e => {
                if (e.target.tagName !== 'BUTTON') return;
                const tab = e.target;

                // Handle "Check this" button click (special case)
                if (tab.id === 'checkThisBtn') {
                    const currentUser = getCurrentUser();
                    if (currentUser && currentUser.username === 'guest') {
                        showSection($('allChatsSection'));
                        renderAllChats();
                    }
                    return;
                }

                const allTabs = Array.from($('tabs').querySelectorAll('button'));
                const tabContents = Array.from(document.querySelectorAll('section.tabContent'));
                allTabs.forEach(t => {
                    // Exclude 'Check this' button from tab activation logic
                    if (t.id !== 'checkThisBtn') {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    }
                });
                tabContents.forEach(tc => tc.classList.remove('active'));
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                const targetId = tab.dataset.tab;
                if (targetId) {
                    $(targetId).classList.add('active');
                    if (targetId === 'rankingTab') {
                        handleRankingResets(); // Re-check for resets when entering ranking tab
                        // Default to overall ranking when ranking tab is opened
                        $('rankingTypeButtons').querySelector('[data-ranking-type="overall"]').click(); // UPDATED
                    } else if (targetId === 'postsTab') {
                        renderPosts();
                    } else if (targetId === 'buildTab') {
                        renderCreatedGames(); // Render user's created games when entering build tab
                    }
                }
            });

            // Nav buttons in header (simulate switching main content to profile tabs)
            $('navGames').addEventListener('click', () => {
                const currentUser = getCurrentUser();
                if (currentUser) { // Only show profile section if logged in
                    showSection($('profileSection'));
                    activateTab('gamesTab');
                } else {
                    showSection($('loginSection')); // Redirect to login if not logged in
                }
            });
            $('navMarketplace').addEventListener('click', () => {
                const currentUser = getCurrentUser();
                if (currentUser) {
                    showSection($('profileSection'));
                    activateTab('marketplaceTab');
                } else {
                    showSection($('loginSection'));
                }
            });
            $('navBuild').addEventListener('click', () => {
                const currentUser = getCurrentUser();
                if (currentUser) {
                    showSection($('profileSection'));
                    activateTab('buildTab');
                } else {
                    showSection($('loginSection'));
                }
            });
            $('navNews').addEventListener('click', () => {
                const currentUser = getCurrentUser();
                if (currentUser) {
                    showSection($('profileSection'));
                    activateTab('newsTab');
                } else {
                    showSection($('loginSection'));
                }
            });
            $('navRanking').addEventListener('click', () => {
                const currentUser = getCurrentUser();
                if (currentUser) {
                    showSection($('profileSection'));
                    activateTab('rankingTab');
                } else {
                    showSection($('loginSection'));
                }
            });


            // Activate tab helper
            function activateTab(id) {
                const allTabs = Array.from($('tabs').querySelectorAll('button'));
                const tabContents = Array.from(document.querySelectorAll('section.tabContent'));
                allTabs.forEach(t => {
                    // Exclude 'Check this' button from tab activation logic
                    if (t.id !== 'checkThisBtn') {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    }
                });
                tabContents.forEach(tc => tc.classList.remove('active'));
                const tab = $(`tabs`).querySelector(`button[data-tab="${id}"]`);
                if (tab) {
                    tab.classList.add('active');
                    tab.setAttribute('aria-selected', 'true');
                }
                const content = $(id);
                if (content) content.classList.add('active');

                // Specific renders for tabs that need it
                if (id === 'rankingTab') {
                    handleRankingResets(); // Re-check for resets when activating ranking tab
                    // Simulate click on overall ranking by default
                    $('rankingTypeButtons').querySelector('[data-ranking-type="overall"]').click(); // UPDATED
                } else if (id === 'postsTab') {
                    renderPosts();
                } else if (id === 'buildTab') {
                    renderCreatedGames();
                }
            }

            // Login / SignUp / Forgot Password toggles
            $('toSignUp').addEventListener('click', () => {
                clearInputs($('loginForm'));
                $('loginError').textContent = ''; // Clear error message
                showSection($('signUpSection'));
                selectedAvatarId = null;
                document.querySelectorAll('.avatar.selected').forEach(el => el.classList.remove('selected'));
            });
            $('toLogin').addEventListener('click', () => {
                clearInputs($('signUpForm'));
                $('signUpError').textContent = ''; // Clear error message
                showSection($('loginSection'));
            });
            $('forgotPasswordLink').addEventListener('click', () => {
                clearInputs($('loginForm'));
                $('loginError').textContent = ''; // Clear login error
                $('forgotPasswordMessage').textContent = ''; // Clear recovery message
                $('forgotPasswordError').textContent = ''; // Clear recovery error
                showSection($('forgotPasswordSection'));
            });
            $('backToLoginFromForgot').addEventListener('click', () => {
                clearInputs($('forgotPasswordForm'));
                $('forgotPasswordMessage').textContent = ''; // Clear recovery message
                $('forgotPasswordError').textContent = ''; // Clear recovery error
                showSection($('loginSection'));
            });
            $('backToProfileFromChats').addEventListener('click', () => {
                showSection($('profileSection'));
                activateTab('gamesTab'); // Or whichever default tab you prefer
            });
            $('backToProfileFromAllGames').addEventListener('click', () => {
                showSection($('profileSection'));
                activateTab('gamesTab');
            });


            // Login form submit
            $('loginForm').addEventListener('submit', e => {
                e.preventDefault();
                const username = sanitize($('loginUsername').value.trim());
                const password = $('loginPassword').value;
                const users = getUsers();
                const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());

                if (user && user.password === password) {
                    setCurrentUser(user.username);
                    renderProfile(user);
                    showSection($('profileSection'));
                    $('loginError').textContent = '';
                    clearInputs($('loginForm'));
                    activateTab('gamesTab'); // Activate default tab
                } else {
                    $('loginError').textContent = LANG[currentLang].loginError;
                }
            });

            // Signup form submit
            $('signUpForm').addEventListener('submit', e => {
                e.preventDefault();
                const username = sanitize($('signUpUsername').value.trim());
                const email = sanitize($('signUpEmail').value.trim());
                const country = $('signUpCountry').value;
                const password = $('signUpPassword').value;
                const birthdate = $('signUpBirthdate').value;

                if (!username || !country || !password || !birthdate || !selectedAvatarId) {
                    $('signUpError').textContent = LANG[currentLang].signUpError;
                    return;
                }
                // Check if username exists
                const users = getUsers();
                if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
                    $('signUpError').textContent = 'Username already exists.'; // TODO: Translate this
                    return;
                }
                // Create new user object
                const avatar = avatars.find(a => a.id === selectedAvatarId);
                const newUser = {
                    username,
                    email,
                    country,
                    password,
                    birthdate,
                    avatarId: avatar.id,
                    avatarName: avatar.name,
                    ...defaultUserProperties, // Spread default properties
                    lastWeeklyReset: getKiritimatiDate().toISOString(),
                    lastMonthlyReset: getKiritimatiDate().toISOString(),
                    lastYearlyReset: getKiritimatiDate().toISOString(),
                };
                users.push(newUser);
                saveUsers(users);
                setCurrentUser(username);
                renderProfile(newUser);
                showSection($('profileSection'));
                clearInputs($('signUpForm'));
                selectedAvatarId = null;
                document.querySelectorAll('.avatar.selected').forEach(el => el.classList.remove('selected'));
                $('signUpError').textContent = '';
                activateTab('gamesTab'); // Activate default tab
            });

            // Forgot password form submit
            $('forgotPasswordForm').addEventListener('submit', e => {
                e.preventDefault();
                const email = sanitize($('forgotPasswordEmail').value.trim());
                const users = getUsers();
                const user = users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.email !== '');

                $('forgotPasswordMessage').textContent = '';
                $('forgotPasswordError').textContent = '';

                if (user) {
                    const message = LANG[currentLang].recoveryEmailSent
                        .replace('{username}', user.username)
                        .replace('{password}', user.password);
                    $('forgotPasswordMessage').textContent = message;
                    clearInputs($('forgotPasswordForm'));
                } else {
                    $('forgotPasswordError').textContent = LANG[currentLang].recoveryEmailNotFound;
                }
            });

            // Publish Post button
            $('publishPostBtn').addEventListener('click', () => {
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    alert('You must be logged in to post.'); // TODO: Translate this
                    return;
                }

                const postContent = $('postContent').value.trim();
                if (postContent === '') {
                    $('postMessage').style.color = 'red';
                    $('postMessage').textContent = LANG[currentLang].postEmpty;
                    return;
                }

                const posts = getPosts();
                const newPost = {
                    username: currentUser.username,
                    content: postContent,
                    timestamp: new Date().toISOString(),
                };
                posts.push(newPost);
                savePosts(posts);

                $('postContent').value = '';
                $('postMessage').style.color = 'green';
                $('postMessage').textContent = LANG[currentLang].postPublished;

                renderPosts();

                setTimeout(() => {
                    $('postMessage').textContent = '';
                }, 3000);
            });

            // Ranking type buttons listener (UPDATED)
            $('rankingTypeButtons').addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    const type = e.target.dataset.rankingType;
                    if (type) {
                        // Deactivate all ranking type buttons
                        $('rankingTypeButtons').querySelectorAll('button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        // Activate the clicked button
                        e.target.classList.add('active');
                        // Render the table with the selected type
                        renderRankingTable(type);
                    }
                }
            });


            // Logout
            $('btnLogout').addEventListener('click', () => {
                setCurrentUser(null);
                showSection($('loginSection'));
                hide($('checkThisBtn'));
                // Clear any builder state
                currentGame = null;
            });

            // --- Game Creation / Building Logic (NEW) ---

            // "Wszystkie Gry" button (formerly "Start New Game")
            $('startGameBtn').addEventListener('click', () => {
                const currentUser = getCurrentUser();
                if (currentUser) {
                    showSection($('allGamesSection')); // Show all published games
                    renderAllPublishedGames();
                } else {
                    alert('Please log in to see available games.'); // TODO: Translate
                    showSection($('loginSection'));
                }
            });

            // "Stwórz Nową Grę" button
            $('createNewGameBtn').addEventListener('click', () => {
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    alert('You must be logged in to create a game.'); // TODO: Translate
                    return;
                }

                // Prompt for game name and template
                const gameName = prompt(LANG[currentLang].gameName + ' (e.g., "My Awesome World")');
                if (!gameName || gameName.trim() === '') {
                    alert('Game name cannot be empty.'); // TODO: Translate
                    return;
                }

                let templateType = '';
                while (!['base', 'parkour', 'island'].includes(templateType)) {
                    templateType = prompt(
                        LANG[currentLang].selectGameTemplate + '\n' +
                        `1. ${LANG[currentLang].baseTemplate}\n` +
                        `2. ${LANG[currentLang].parkourTemplate}\n` +
                        `3. ${LANG[currentLang].islandTemplate}`
                    );
                    if (templateType === null) return; // User cancelled
                    templateType = templateType.toLowerCase().replace('1', 'base').replace('2', 'parkour').replace('3', 'island');
                    if (!['base', 'parkour', 'island'].includes(templateType)) {
                        alert('Invalid template choice. Please choose 1, 2, or 3.'); // TODO: Translate
                    }
                }

                const template = gameTemplates[templateType];
                if (!template) {
                    alert('Selected template not found.'); // Should not happen with validation above
                    return;
                }

                const newGameId = `game-${Date.now()}`;
                const newGame = {
                    id: newGameId,
                    name: gameName,
                    creator: currentUser.username,
                    template: templateType,
                    mapData: template.initialMap, // Simplified: actual map data would be complex
                    published: false,
                    thumbnail: template.thumbnail,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                };

                let allGames = getGames();
                allGames.push(newGame);
                saveGames(allGames);

                // Add game ID to user's created games list
                currentUser.createdGames.push(newGameId);
                saveUsers(getUsers().map(u => u.username === currentUser.username ? currentUser : u));

                alert(`Game "${gameName}" created! Now entering the builder.`); // TODO: Translate
                loadGameIntoBuilder(newGameId);
            });

            // Builder tool selection
            $('builderTools').addEventListener('click', e => {
                const target = e.target.closest('.builder-tool');
                if (target) {
                    document.querySelectorAll('.builder-tool').forEach(btn => btn.classList.remove('active'));
                    target.classList.add('active');
                    currentTool = target.dataset.tool;
                    console.log(`Selected tool: ${currentTool}`);
                }
            });

            // Block color picker
            $('blockColorPicker').addEventListener('input', (e) => {
                currentBlockColor = e.target.value;
                $('selectedColorPreview').style.backgroundColor = currentBlockColor;
                console.log(`Selected block color: ${currentBlockColor}`);
            });

            // Palette item selection (models, weapons, logics)
            $('builderPalette').addEventListener('click', e => {
                const target = e.target.closest('.palette-item');
                if (target) {
                    document.querySelectorAll('.palette-item').forEach(item => item.classList.remove('selected'));
                    target.classList.add('selected');
                    currentPaletteItem = {
                        type: target.dataset.itemType,
                        id: target.dataset.itemId
                    };
                    console.log(`Selected palette item: ${currentPaletteItem.type} - ${currentPaletteItem.id}`);
                }
            });

            // Create New Model form submission (simplified)
            $('createModelForm').addEventListener('submit', e => {
                e.preventDefault();
                const modelName = sanitize($('newModelName').value.trim());
                const modelIcon = sanitize($('newModelIcon').value.trim());

                if (!modelName || !modelIcon) {
                    alert('Model name and icon URL cannot be empty.'); // TODO: Translate
                    return;
                }

                const currentUser = getCurrentUser();
                if (!currentUser) return;

                // Simulate adding a new model to user's purchased models
                const newModelId = `custom_model_${Date.now()}`;
                currentUser.purchasedModels.push(newModelId); // Add to user's inventory
                // In a real app, you'd store model details (name, icon) globally or with the model itself
                saveUsers(getUsers().map(u => u.username === currentUser.username ? currentUser : u));

                alert(`Model "${modelName}" created and added to your inventory!`); // TODO: Translate
                clearInputs($('createModelForm'));
                updateBuilderPalette(); // Re-render palette to show new model
            });


            // Save Game button
            $('saveGameBtn').addEventListener('click', () => {
                if (!currentGame) return;

                let allGames = getGames();
                const gameIndex = allGames.findIndex(g => g.id === currentGame.id);
                if (gameIndex !== -1) {
                    // In a real app, you'd save the actual map data from the canvas here
                    // currentGame.mapData = getMapDataFromCanvas();
                    currentGame.lastModified = new Date().toISOString();
                    allGames[gameIndex] = currentGame;
                    saveGames(allGames);
                    alert(`Game "${currentGame.name}" saved!`); // TODO: Translate
                }
            });

            // Publish Game button
            $('publishGameBtn').addEventListener('click', () => {
                if (!currentGame) return;

                let allGames = getGames();
                const gameIndex = allGames.findIndex(g => g.id === currentGame.id);
                if (gameIndex !== -1) {
                    currentGame.published = true; // Mark as published
                    allGames[gameIndex] = currentGame;
                    saveGames(allGames);
                    alert(`Game "${currentGame.name}" published! It's now available for others to play.`); // TODO: Translate
                }
            });

            // Take Screenshot button (simulated)
            $('takeScreenshotBtn').addEventListener('click', () => {
                if (!currentGame) return;
                alert(`Simulating screenshot of "${currentGame.name}". In a real app, this would capture the canvas content.`); // TODO: Translate
                // In a real app, you'd use canvas.toDataURL() or a similar method
            });

            // Exit Builder button
            $('exitBuilderBtn').addEventListener('click', () => {
                currentGame = null; // Clear current game in builder
                showSection($('profileSection'));
                activateTab('buildTab'); // Go back to build tab
            });

            // Initial render of created games if user is logged in
            if(getCurrentUser()) {
                renderCreatedGames();
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
