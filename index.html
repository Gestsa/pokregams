<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoKreGaM</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap; /* Allow controls to wrap */
        }

        .header-controls button,
        .header-controls select {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #555;
            color: white;
            transition: background-color 0.2s;
            white-space: nowrap; /* Prevent text wrapping inside buttons */
        }

        .header-controls button:hover,
        .header-controls select:hover {
            background-color: #777;
        }

        main {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the top */
        }

        section {
            background-color: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            margin-bottom: 20px; /* Add some margin below sections */
        }

        section.hidden {
            display: none;
        }

        h2 {
            color: #444;
            text-align: center;
            margin-bottom: 20px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        form label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        form input[type="text"],
        form input[type="password"],
        form input[type="email"],
        form input[type="date"],
        form select,
        form textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            margin-top: 5px;
            box-sizing: border-box; /* Include padding and border in width */
        }

        form button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.2s;
        }

        form button:hover {
            background-color: #0056b3;
        }

        .error-message {
            color: #dc3545;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }

        .success-message {
            color: #28a745;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }

        .link-text {
            text-align: center;
            margin-top: 15px;
        }

        .link-text a, .link-text button {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            font-size: 1em;
            transition: color 0.2s;
        }

        .link-text a:hover, .link-text button:hover {
            color: #0056b3;
        }

        #avatarsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            justify-items: center;
        }

        .avatar {
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 5px;
            cursor: pointer;
            text-align: center;
            transition: border-color 0.2s, background-color 0.2s;
        }

        .avatar img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            display: block;
            margin: 0 auto 5px;
        }

        .avatar.selected {
            border-color: #007bff;
            background-color: #e0f0ff;
        }

        /* Profile Section Specific Styles */
        #profileSection {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 900px; /* Wider for tabs */
        }

        #profileHeader {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap; /* Allow wrapping for responsiveness */
            justify-content: center; /* Center items on wrap */
            text-align: center;
        }

        #profileAvatar img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007bff;
        }

        #profileInfo {
            flex-grow: 1;
        }

        #profileInfo p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        #profileInfo p strong {
            color: #007bff;
        }

        #profileInfo span {
            font-weight: normal;
        }

        #profileStats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            justify-content: center; /* Center stats */
        }

        #profileStats div {
            background-color: #e9f5ff;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #0056b3;
            font-weight: bold;
        }

        #tabs {
            display: flex;
            flex-wrap: wrap; /* Allow tabs to wrap */
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
            justify-content: center; /* Center tabs */
        }

        #tabs button {
            background-color: #f0f0f0;
            color: #555;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            white-space: nowrap; /* Prevent text wrapping inside buttons */
        }

        #tabs button.active {
            background-color: white;
            color: #007bff;
            border-color: #007bff;
            border-bottom: 2px solid white; /* Visual trick for active tab */
            position: relative;
            z-index: 1;
        }

        .tabContent {
            background-color: white;
            padding: 20px;
            border-radius: 0 0 8px 8px; /* Match bottom corners with profile section */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Specific tab content styling */
        #rankingTab h3 {
            text-align: center;
            margin-bottom: 15px;
        }

        #rankingTypeButtons {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        #rankingTypeButtons button {
            padding: 8px 15px;
            border: 1px solid #007bff;
            border-radius: 5px;
            background-color: white;
            color: #007bff;
            cursor: pointer;
            transition: all 0.2s;
        }

        #rankingTypeButtons button.active {
            background-color: #007bff;
            color: white;
        }

        #rankingTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #rankingTable th, #rankingTable td {
            border: 1px solid #ddd;
            padding: 10px 12px;
            text-align: left;
            word-break: break-word; /* Ensure text breaks in cells */
        }

        #rankingTable th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #555;
        }

        #rankingTable tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        #rankingTable tbody tr:hover {
            background-color: #e0f7fa;
        }

        #rankingTable td button.report-user-btn {
            background-color: #ffc107;
            color: #333;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
            transition: background-color 0.2s;
            white-space: nowrap; /* Keep button text on one line */
        }
        #rankingTable td button.report-user-btn:hover {
            background-color: #e0a800;
        }


        /* Posts tab */
        #writePostSection {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        #postContent {
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }

        #publishPostBtn {
            width: auto;
            align-self: flex-end;
            margin-top: 5px;
        }

        .post {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fefefe;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .post-avatar img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .post-info {
            flex-grow: 1;
        }

        .post-author {
            font-weight: bold;
            color: #007bff;
        }

        .post-time {
            font-size: 0.8em;
            color: #777;
        }

        .post-content {
            line-height: 1.5;
            white-space: pre-wrap; /* Preserve whitespace and breaks */
            word-wrap: break-word; /* Break long words */
        }

        /* All Chats Section for Guest */
        #allChatsSection {
            text-align: center;
        }

        #chatsContent {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .chat-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .chat-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #0056b3;
            border-bottom: 1px dashed #cce;
            padding-bottom: 5px;
        }

        .chat-message {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #444;
        }

        /* Friends Tab */
        .friends-search {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .friends-search input {
            flex-grow: 1;
            min-width: 100px; /* Ensure input doesn't shrink too much */
        }

        .friends-search button {
            flex-shrink: 0; /* Prevent button from shrinking */
            width: auto;
            padding: 10px 20px;
        }


        .user-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .user-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #f5f5f5;
        }

        .user-card:last-child {
            border-bottom: none;
        }

        .user-card span {
            font-weight: bold;
            color: #333;
        }

        .user-card button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
            width: auto; /* Reset button width */
        }

        .user-card button:hover:not(:disabled) {
            background-color: #218838;
        }

        .user-card button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .my-friends ul {
            list-style: none;
            padding: 0;
        }

        .my-friends li {
            background-color: #e9f5ff;
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .my-friends li:last-child {
            margin-bottom: 0;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation-name: animatetop;
            animation-duration: 0.4s
        }

        /* Add Animation */
        @-webkit-keyframes animatetop {
            from {top:-300px; opacity:0}
            to {top:0; opacity:1}
        }

        @keyframes animatetop {
            from {top:-300px; opacity:0}
            to {top:0; opacity:1}
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 15px;
            top: 10px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            font-size: 1.5em;
        }

        .modal-content form label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-weight: normal;
        }

        .modal-content form input[type="radio"] {
            margin-right: 5px;
            width: auto; /* Override general input width */
        }

        .modal-content form textarea {
            width: calc(100% - 22px); /* Adjust for padding and border */
            min-height: 80px;
            margin-top: 10px;
            box-sizing: border-box; /* Include padding and border in width */
        }

        .modal-content form button {
            width: auto;
            margin-top: 15px;
            align-self: center;
            padding: 10px 25px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 10px;
            }
            header h1 {
                font-size: 1.5em;
            }
            main {
                padding: 10px;
            }
            section {
                padding: 15px;
            }
            #profileHeader {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            #profileStats {
                justify-content: center;
            }
            #tabs {
                flex-direction: column;
                align-items: center;
            }
            #tabs button {
                width: 90%;
                border-radius: 8px;
                border-bottom: 1px solid #ddd;
            }
            #tabs button.active {
                border-bottom: 1px solid #007bff;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>PoKreGaM</h1>
        <div class="header-controls">
            <nav id="navMain">
                <button id="navGames">Games</button>
                <button id="navMarketplace">Marketplace</button>
                <button id="navBuild">Build</button>
                <button id="navNews">News</button>
                <button id="navRanking">Ranking</button>
            </nav>
            <select id="languageSelector">
                <option value="en">English</option>
                <option value="pl">Polski</option>
                <option value="mk">Македонски</option>
            </select>
            <button id="btnLogin">Login</button>
            <button id="btnSignUp">Sign Up</button>
        </div>
    </header>

    <main>
        <section id="loginSection" class="hidden">
            <h2 id="loginTitle">Login</h2>
            <form id="loginForm">
                <label for="loginUsername">Username:</label>
                <input type="text" id="loginUsername" required>

                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword" required>

                <button type="submit" id="loginSubmit">Login</button>
                <p id="loginError" class="error-message"></p>
                <p class="link-text"><button type="button" id="forgotPasswordLink">Forgot Password?</button></p>
                <p class="link-text"><button type="button" id="toSignUp">Don't have an account? Sign Up</button></p>
            </form>
        </section>

        <section id="signUpSection" class="hidden">
            <h2 id="signUpTitle">Sign Up</h2>
            <form id="signUpForm">
                <p id="selectCharacter">Select your character:</p>
                <div id="avatarsContainer">
                    </div>

                <label for="signUpUsername">Username:</label>
                <input type="text" id="signUpUsername" required>

                <label for="signUpEmail">Email (optional):</label>
                <input type="email" id="signUpEmail">

                <label for="signUpCountry">Country:</label>
                <select id="signUpCountry" required>
                    <option value="PL">Poland</option>
                    <option value="US">United States</option>
                    <option value="MK">North Macedonia</option>
                    </select>

                <label for="signUpPassword">Password:</label>
                <input type="password" id="signUpPassword" required>

                <label for="signUpBirthdate">Birthdate:</label>
                <input type="date" id="signUpBirthdate" required>

                <button type="submit" id="signUpSubmit">Sign Up</button>
                <p id="signUpError" class="error-message"></p>
                <p class="link-text"><button type="button" id="toLogin">Already have an account? Login</button></p>
            </form>
        </section>

        <section id="forgotPasswordSection" class="hidden">
            <h2 id="forgotPasswordTitle">Forgot Password</h2>
            <p id="forgotPasswordInstructions">Please enter your email. If an account is associated with it, we will send you your account details (username and password) via email.</p>
            <form id="forgotPasswordForm">
                <label for="forgotPasswordEmail">Email:</label>
                <input type="email" id="forgotPasswordEmail" required>
                <button type="submit" id="sendRecoveryEmail">Send Recovery Email</button>
                <p id="forgotPasswordMessage" class="success-message"></p>
                <p id="forgotPasswordError" class="error-message"></p>
                <p class="link-text"><button type="button" id="backToLoginFromForgot">Back to Login</button></p>
            </form>
        </section>

        <section id="profileSection" class="hidden">
            <div id="profileHeader">
                <div id="profileAvatar">
                    <img src="" alt="User Avatar">
                </div>
                <div id="profileInfo">
                    <p><strong id="profileUsernameLabel">Username:</strong> <span id="profileUsername"></span></p>
                    <p><strong id="profileCountryLabel">Country:</strong> <span id="profileCountry"></span></p>
                    <p><strong id="profileRankingPlaceLabel">XP Ranking Place:</strong> <span id="profileRankingPlace"></span></p>
                    <div id="profileStats">
                        <div id="profileXPLabel">XP: <span id="profileXP">0</span></div>
                        <div id="profileLevelLabel">Level: <span id="profileLevel">1</span></div>
                        <div id="profileFriendsCountLabel">Friends: <span id="profileFriendsCount">0</span></div>
                        <div id="profileGoldLabel">Gold: <span id="profileGold">0</span></div>
                    </div>
                </div>
            </div>

            <nav id="tabs">
                <button data-tab="gamesTab" class="active" aria-selected="true" id="gamesTabButton">Games</button>
                <button data-tab="marketplaceTab" aria-selected="false" id="marketplaceTabButton">Marketplace</button>
                <button data-tab="buildTab" aria-selected="false" id="buildTabButton">Build</button>
                <button data-tab="newGameTab" aria-selected="false" id="newGameTabButton">New Game</button>
                <button data-tab="newsTab" aria-selected="false" id="newsTabButton">News</button>
                <button data-tab="rankingTab" aria-selected="false" id="rankingTabButton">Ranking</button>
                <button data-tab="postsTab" aria-selected="false" id="postsTabButton">Posts</button>
                <button data-tab="friendsTab" aria-selected="false" id="friendsTabButton">Friends</button> <button id="checkThisBtn" class="hidden">Check this</button>
                <button id="btnLogout">Logout</button>
            </nav>

            <div id="tabContents">
                <div id="gamesTab" class="tabContent active">
                    <h3 id="gamesTabTitle">Games</h3>
                    <p id="gamesWelcomeText">Welcome to your games! Start a new adventure or continue an existing one.</p>
                    <button id="startGameBtn">Start New Game</button>
                    </div>

                <div id="marketplaceTab" class="tabContent hidden">
                    <h3 id="marketplaceTabTitle">Marketplace</h3>
                    <p id="marketplaceDescription">Buy and sell items, weapons, and armor here.</p>
                    </div>

                <div id="buildTab" class="tabContent hidden">
                    <h3 id="buildTabTitle">Build</h3>
                    <p id="buildDescription">Craft new items or build your base.</p>
                    </div>

                <div id="newGameTab" class="tabContent hidden">
                    <h3 id="newGameTabTitle">New Game</h3>
                    <p id="newGameDescription">Choose your game type and begin a new journey.</p>
                    </div>

                <div id="newsTab" class="tabContent hidden">
                    <h3 id="newsTabTitle">News</h3>
                    <p id="newsDescription">Stay updated with the latest game news and community announcements.</p>
                    <p>No news articles available at the moment. Check back soon!</p>
                </div>

                <div id="rankingTab" class="tabContent hidden">
                    <h3 id="rankingTabTitle">XP Ranking</h3>
                    <div id="rankingTypeButtons">
                        <button data-ranking-type="overall" class="active" id="overallRankingBtn">Overall Ranking</button>
                        <button data-ranking-type="weekly" id="weeklyRankingBtn">Weekly Ranking</button>
                        <button data-ranking-type="monthly" id="monthlyRankingBtn">Monthly Ranking</button>
                        <button data-ranking-type="yearly" id="yearlyRankingBtn">Yearly Ranking</button>
                        <button data-ranking-type="global" id="globalRankingBtn">Global Ranking (by country)</button>
                    </div>
                    <table id="rankingTable">
                        <thead>
                            <tr>
                                <th>Place</th>
                                <th>Username</th>
                                <th>XP</th>
                                <th>Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>

                <div id="postsTab" class="tabContent hidden">
                    <h3 id="postsTabTitle">Community Posts</h3>
                    <div id="writePostSection">
                        <label for="postContent" id="writePostLabel">Write your post:</label>
                        <textarea id="postContent" placeholder="What's on your mind?"></textarea>
                        <button id="publishPostBtn">Publish</button>
                        <p id="postMessage" class="success-message"></p>
                    </div>
                    <div id="communityPosts">
                        </div>
                </div>

                <div id="friendsTab" class="tabContent hidden">
                    <h3 id="friendsTabTitle">Friends</h3>
                    <div class="friends-search">
                        <input type="text" id="friendSearchInput" placeholder="Wyszukaj użytkownika...">
                        <button id="searchFriendBtn">Szukaj</button>
                    </div>
                    <div id="friendSearchResults" class="user-list">
                        </div>
                    <div class="my-friends">
                        <h3 id="myFriendsListTitle">Moi Przyjaciele</h3>
                        <ul id="myFriendsList">
                            </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="allChatsSection" class="hidden">
            <h2 id="allChatsTitle">All Private and Game Chats (Guest Access)</h2>
            <p id="allChatsDescription">This content is only visible to 'guest' users logged in with password 'Freeaccount'.</p>
            <div id="chatsContent">
                </div>
        </section>
    </main>

    <div id="reportUserModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="reportUserModalHeader">Zgłoś Użytkownika: <span id="reportUsernameTarget"></span></h2>
            <p id="reportReasonLabel">Wybierz powód zgłoszenia:</p>
            <form id="reportForm">
                <label>
                    <input type="radio" name="reportReason" value="sexualContent"> <span id="sexualContentReason">Seksualna treść</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="hateSpeech"> <span id="hateSpeechReason">Mowa nienawiści / Brzydkie słowa</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="personalData"> <span id="personalDataReason">Udostępnianie danych osobowych</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="maliciousLink"> <span id="maliciousLinkReason">Wysyłanie nieznanych/złośliwych linków</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="threats"> <span id="threatsReason">Grożenie</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="cheating"> <span id="cheatingReason">Cheaty</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="adminImpersonation"> <span id="adminImpersonationReason">Podawanie się za admina</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="passwordSharing"> <span id="passwordSharingReason">Udostępnianie cudzego hasła</span>
                </label><br>
                <label>
                    <input type="radio" name="reportReason" value="other"> <span id="otherReason">Inne</span> (opcjonalnie doprecyzuj poniżej)
                </label><br>
                <textarea id="reportComment" placeholder="Dodatkowe uwagi (opcjonalnie)"></textarea><br>
                <button type="submit" id="sendReportBtn">Wyślij Zgłoszenie</button>
                <p id="reportMessage" class="error-message"></p>
            </form>
        </div>
    </div>


    <script>
    // --- Language data ---
    const LANG = {
        en: {
            login: "Login",
            signup: "Sign Up",
            username: "Username",
            password: "Password",
            email: "Email (optional)",
            country: "Country",
            birthdate: "Birthdate",
            selectCharacter: "Select your character:",
            dontHaveAccount: "Don't have an account? Sign Up",
            alreadyHaveAccount: "Already have an account? Login",
            rankingXPPlace: "XP Ranking Place:",
            games: "Games",
            marketplace: "Marketplace",
            build: "Build",
            newGame: "New Game",
            news: "News",
            ranking: "Ranking",
            posts: "Posts",
            startNewGame: "Start New Game",
            loginError: "Incorrect username or password.",
            signUpError: "Please fill in all required fields and select a character.",
            logout: "Logout",
            checkThis: "Check this",
            allChatsTitle: "All Private and Game Chats (Guest Access)",
            allChatsDescription: "This content is only visible to 'guest' users logged in with password 'Freeaccount'.",
            forgotPassword: "Forgot Password?",
            forgotPasswordTitle: "Forgot Password",
            forgotPasswordInstructions: "Please enter your email. If an account is associated with it, we will send you your account details (username and password) via email.",
            sendRecoveryEmail: "Send Recovery Email",
            backToLogin: "Back to Login",
            recoveryEmailSent: "If an account exists with this email, your account details (username: {username}, password: {password}) have been sent to your email. (Simulation)",
            recoveryEmailNotFound: "No account found with that email or no email provided for the account. Please check your email or try signing up.",
            postsTabTitle: "Community Posts",
            writePostLabel: "Write your post:",
            publishPostBtn: "Publish",
            postContentPlaceholder: "What's on your mind?",
            postPublished: "Post successfully published!",
            postEmpty: "Post cannot be empty.",
            overallRanking: "Overall Ranking",
            weeklyRanking: "Weekly Ranking",
            monthlyRanking: "Monthly Ranking",
            yearlyRanking: "Yearly Ranking",
            globalRankingCountry: "Global Ranking (by country)",
            rankingTabTitle: "XP Ranking",
            friends: "Friends",
            search: "Search",
            myFriends: "My Friends",
            noSearchResults: "No search results found.",
            addFriend: "Add Friend",
            alreadyFriends: "Already Friends",
            cannotAddSelf: "Cannot add yourself as a friend.",
            friendAdded: "User {username} has been added to your friends list.",
            noFriendsYet: "You don't have any friends yet.",
            reportUser: "Report",
            reportUserModalTitle: "Report User:",
            reportReason: "Select report reason:",
            sexualContent: "Sexual content",
            hateSpeech: "Hate speech / Bad language",
            personalData: "Sharing personal data",
            maliciousLink: "Sending unknown/malicious links",
            threats: "Threats",
            cheating: "Cheating",
            adminImpersonation: "Impersonating an admin",
            passwordSharing: "Sharing someone else's password",
            other: "Other",
            additionalComments: "Additional comments (optional)",
            sendReport: "Send Report",
            reportSuccess: "Report submitted successfully. Thank you!",
            reportNoReason: "Please select a report reason.",
            reportCannotReportSelf: "You cannot report yourself.",
            noPostsYet: "No posts yet. Be the first to share something!", // NEW
            noNewsYet: "No news articles available at the moment. Check back soon!", // NEW
        },
        pl: {
            login: "Zaloguj się",
            signup: "Zarejestruj się",
            username: "Nazwa użytkownika",
            password: "Hasło",
            email: "E-mail (opcjonalnie)",
            country: "Kraj",
            birthdate: "Data urodzenia",
            selectCharacter: "Wybierz swoją postać:",
            dontHaveAccount: "Nie masz konta? Zarejestruj się",
            alreadyHaveAccount: "Masz już konto? Zaloguj się",
            rankingXPPlace: "Miejsce w rankingu XP:",
            games: "Gry",
            marketplace: "Rynek",
            build: "Buduj",
            newGame: "Nowa gra",
            news: "Aktualności",
            ranking: "Ranking",
            posts: "Posty",
            startNewGame: "Rozpocznij nową grę",
            loginError: "Nieprawidłowa nazwa użytkownika lub hasło.",
            signUpError: "Proszę wypełnić wszystkie wymagane pola i wybrać postać.",
            logout: "Wyloguj się",
            checkThis: "Sprawdź to",
            allChatsTitle: "Wszystkie prywatne czaty i czaty z gier (Dostęp gościa)",
            allChatsDescription: "Ta zawartość jest widoczna tylko dla użytkowników 'gość' zalogowanych hasłem 'Freeaccount'.",
            forgotPassword: "Zapomniałeś hasła?",
            forgotPasswordTitle: "Zapomniałeś hasła",
            forgotPasswordInstructions: "Proszę podać swój adres e-mail. Jeśli istnieje konto z nim powiązane, wyślemy Ci dane konta (nazwa użytkownika i hasło) e-mailem.",
            sendRecoveryEmail: "Wyślij e-mail odzyskiwania",
            backToLogin: "Wróć do logowania",
            recoveryEmailSent: "Jeśli istnieje konto z tym adresem e-mail, dane Twojego konta (nazwa użytkownika: {username}, hasło: {password}) zostały wysłane na Twój adres e-mail. (Symulacja)",
            recoveryEmailNotFound: "Nie znaleziono konta z tym adresem e-mail lub nie podano adresu e-mail dla konta. Sprawdź swój adres e-mail lub spróbuj się zarejestrować.",
            postsTabTitle: "Posty społeczności",
            writePostLabel: "Napisz swoją wiadomość:",
            publishPostBtn: "Opublikuj",
            postContentPlaceholder: "Co masz na myśli?",
            postPublished: "Post został pomyślnie opublikowany!",
            postEmpty: "Wiadomość nie może być pusta.",
            overallRanking: "Ogólny ranking",
            weeklyRanking: "Ranking tygodniowy",
            monthlyRanking: "Ranking miesięczny",
            yearlyRanking: "Ranking roczny",
            globalRankingCountry: "Globalny ranking (według kraju)",
            rankingTabTitle: "Ranking XP",
            friends: "Znajomi",
            search: "Szukaj",
            myFriends: "Moi Przyjaciele",
            noSearchResults: "Brak wyników wyszukiwania.",
            addFriend: "Dodaj znajomego",
            alreadyFriends: "Jesteście już znajomymi",
            cannotAddSelf: "Nie możesz dodać samego siebie do znajomych.",
            friendAdded: "Użytkownik {username} został dodany do listy znajomych.",
            noFriendsYet: "Nie masz jeszcze znajomych.",
            reportUser: "Zgłoś",
            reportUserModalTitle: "Zgłoś Użytkownika:",
            reportReason: "Wybierz powód zgłoszenia:",
            sexualContent: "Treść seksualna",
            hateSpeech: "Mowa nienawiści / Wulgaryzmy",
            personalData: "Udostępnianie danych osobowych",
            maliciousLink: "Wysyłanie nieznanych/złośliwych linków",
            threats: "Groźby",
            cheating: "Oszustwa",
            adminImpersonation: "Podawanie się za administratora",
            passwordSharing: "Udostępnianie cudzego hasła",
            other: "Inne",
            additionalComments: "Dodatkowe uwagi (opcjonalnie)",
            sendReport: "Wyślij Zgłoszenie",
            reportSuccess: "Zgłoszenie zostało pomyślnie wysłane. Dziękujemy!",
            reportNoReason: "Proszę wybrać powód zgłoszenia.",
            reportCannotReportSelf: "Nie możesz zgłosić samego siebie.",
            noPostsYet: "Brak postów. Bądź pierwszy, który coś udostępni!", // NEW
            noNewsYet: "Brak dostępnych artykułów z wiadomościami. Sprawdź ponownie wkrótce!", // NEW
        },
        mk: {
            login: "Најава",
            signup: "Регистрација",
            username: "Корисничко име",
            password: "Лозинка",
            email: "Е-пошта (опционално)",
            country: "Држава",
            birthdate: "Датум на раѓање",
            selectCharacter: "Избери го својот карактер:",
            dontHaveAccount: "Немате сметка? Регистрирајте се",
            alreadyHaveAccount: "Веќе имате сметка? Најавете се",
            rankingXPPlace: "Место на ранг листата по XP:",
            games: "Игри",
            marketplace: "Пазар",
            build: "Изградба",
            newGame: "Нова игра",
            news: "Вести",
            ranking: "Ранг листа",
            posts: "Објави",
            startNewGame: "Започни нова игра",
            loginError: "Погрешно корисничко име или лозинка.",
            signUpError: "Ве молиме пополнете ги сите задолжителни полиња и изберете карактер.",
            logout: "Одјави се",
            checkThis: "Провери го ова",
            allChatsTitle: "Сите приватни разговори и разговори од игри (Гостински пристап)",
            allChatsDescription: "Оваа содржина е видлива само за 'гостин' корисници најавени со лозинката 'Freeaccount'.",
            forgotPassword: "Заборавена лозинка?",
            forgotPasswordTitle: "Заборавена лозинка",
            forgotPasswordInstructions: "Ве молиме внесете ја вашата е-пошта. Доколку постои сметка поврзана со неа, ќе ви ги испратиме деталите за вашата сметка (корисничко име и лозинка) по е-пошта.",
            sendRecoveryEmail: "Испрати е-пошта за обнова",
            backToLogin: "Назад на Најава",
            recoveryEmailSent: "Доколку постои сметка со оваа е-пошта, деталите за вашата сметка (корисничко име: {username}, лозинка: {password}) се испратени на вашата е-пошта. (Симулација)",
            recoveryEmailNotFound: "Не е пронајдена сметка со таа е-пошта или не е обезбедена е-попошта за сметката. Ве молиме проверете ја вашата е-пошта или обидете се да се регистрирате.",
            postsTabTitle: "Објави на заедницата",
            writePostLabel: "Напиши ја вашата објава:",
            publishPostBtn: "Објави",
            postContentPlaceholder: "Што ви е на ум?",
            postPublished: "Објавата е успешно објавена!",
            postEmpty: "Објавата не може да биде празна.",
            overallRanking: "Вкупна ранг листа",
            weeklyRanking: "Неделна ранг листа",
            monthlyRanking: "Месечна ранг листа",
            yearlyRanking: "Годишна ранг листа",
            globalRankingCountry: "Глобална ранг листа (по држава)",
            rankingTabTitle: "XP Ранг листа",
            friends: "Пријатели",
            search: "Барај",
            myFriends: "Мои Пријатели",
            noSearchResults: "Нема резултати од пребарувањето.",
            addFriend: "Додај пријател",
            alreadyFriends: "Веќе пријатели",
            cannotAddSelf: "Не можете да се додадете себеси како пријател.",
            friendAdded: "Корисникот {username} е додаден во вашите пријатели.",
            noFriendsYet: "Сè уште немате пријатели.",
            reportUser: "Пријави",
            reportUserModalTitle: "Пријави Корисник:",
            reportReason: "Изберете причина за пријава:",
            sexualContent: "Сексуална содржина",
            hateSpeech: "Говор на омраза / Лош јазик",
            personalData: "Споделување лични податоци",
            maliciousLink: "Испраќање непознати/злонамерни линкови",
            threats: "Закани",
            cheating: "Мамење",
            adminImpersonation: "Претставување како администратор",
            passwordSharing: "Споделување туѓа лозинка",
            other: "Друго",
            additionalComments: "Дополнителни коментари (опционално)",
            sendReport: "Испрати Пријава",
            reportSuccess: "Пријавата е успешно поднесена. Благодариме!",
            reportNoReason: "Ве молиме изберете причина за пријава.",
            reportCannotReportSelf: "Не можете да се пријавите себеси.",
            noPostsYet: "Сè уште нема објави. Бидете првиот што ќе сподели нешто!", // NEW
            noNewsYet: "Во моментов нема достапни вести. Проверете наскоро!", // NEW
        }
    };

    // --- Avatars for signup ---
    const avatars = [
        {id: 'avatar1', name: 'Smily Boy', src: 'https://i.ibb.co/L8y2w5n/avatar1.jpg'}, // Corrected direct link
        {id: 'avatar2', name: 'Warrior Girl', src: 'https://i.ibb.co/qN9B21V/avatar2.jpg'}, // Corrected direct link
        {id: 'avatar3', name: 'Zebra', src: 'https://i.ibb.co/30B37fQ/avatar3.jpg'}, // Corrected direct link
        {id: 'avatar4', name: 'King Of Water', src: 'https://i.ibb.co/8Y4PqX4/avatar4.jpg'}, // Corrected direct link
    ];

    // --- Simulate Chat Data (for guest access) ---
    const allChats = [
        {
            type: 'private',
            participants: ['UserA', 'UserB'],
            messages: [
                { sender: 'UserA', text: 'Hey, spotkałeś się z tą nową misją?', time: '10:05' },
                { sender: 'UserB', text: 'Tak, jest super trudna! Potrzebuję pomocy.', time: '10:07' },
                { sender: 'UserA', text: 'Jasne, mogę pomóc wieczorem.', time: '10:08' }
            ]
        },
        {
            type: 'game',
            game: 'Dragon Slayer',
            messages: [
                { sender: 'Player1', text: 'Ktoś na raidzie o 20:00?', time: '11:15' },
                { sender: 'Player2', text: 'Ja będę!', time: '11:16' },
                { sender: 'Player1', text: 'Ok, zbieramy ekipę!', time: '11:17' }
            ]
        },
        {
            type: 'private',
            participants: ['GraczX', 'GraczY'],
            messages: [
                { sender: 'GraczX', text: 'Widziałeś ten nowy item?', time: '12:01' },
                { sender: 'GraczY', text: 'O tak, jest niesamowity! Ale drogi...', time: '12:03' }
            ]
        },
        {
            type: 'game',
            game: 'PoKreGaM Football',
            messages: [
                { sender: 'Fanatik', text: 'GOOOOOOL!!!', time: '13:30' },
                { sender: 'Rywal', text: 'Foul! To był faul!', time: '13:31' },
                { sender: 'Fanatik', text: 'Sędzia puścił, gramy dalej!', time: '13:32' }
            ]
        },
        {
            type: 'private',
            participants: ['Admin', 'SupportUser'],
            messages: [
                { sender: 'Admin', text: 'Problem z serwerem rozwiązany.', time: '14:00' },
                { sender: 'SupportUser', text: 'Dzięki za szybką naprawę!', time: '14:01' }
            ]
        }
    ];

    // Users data (simulate DB) in localStorage key 'PoKreGaM_users'
    // Logged in user key 'PoKreGaM_currentUser'
    // Posts data in localStorage key 'PoKreGaM_posts'
    // Ranking reset dates key 'PoKreGaM_lastResetDates'

    // --- Helper functions ---
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');
    const sanitize = (str) => String(str).replace(/[<>]/g, '');

    let currentLang = 'en'; // Default language

    // Translate all visible UI texts based on selected language
    function translateUI(lang) {
        currentLang = lang; // Update currentLang
        const t = LANG[lang];

        // Header buttons
        $('navGames').textContent = t.games;
        $('navMarketplace').textContent = t.marketplace;
        $('navBuild').textContent = t.build;
        $('navNews').textContent = t.news;
        $('navRanking').textContent = t.ranking;

        // Auth buttons
        $('btnLogin').textContent = t.login;
        $('btnSignUp').textContent = t.signup;

        // Login form
        $('loginTitle').textContent = t.login;
        $('loginForm').querySelector('label[for="loginUsername"]').textContent = t.username + ":";
        $('loginForm').querySelector('label[for="loginPassword"]').textContent = t.password + ":";
        $('loginSubmit').textContent = t.login;
        $('loginError').textContent = "";
        $('toSignUp').textContent = t.dontHaveAccount;
        $('forgotPasswordLink').textContent = t.forgotPassword;

        // Signup form
        $('signUpTitle').textContent = t.signup;
        $('selectCharacter').textContent = t.selectCharacter;
        $('signUpForm').querySelector('label[for="signUpUsername"]').textContent = t.username + ":";
        $('signUpForm').querySelector('label[for="signUpEmail"]').textContent = t.email + ":";
        $('signUpForm').querySelector('label[for="signUpCountry"]').textContent = t.country + ":";
        $('signUpForm').querySelector('label[for="signUpPassword"]').textContent = t.password + ":";
        $('signUpForm').querySelector('label[for="signUpBirthdate"]').textContent = t.birthdate + ":";
        $('signUpSubmit').textContent = t.signup;
        $('signUpError').textContent = "";
        $('toLogin').textContent = t.alreadyHaveAccount;

        // Forgot Password form
        $('forgotPasswordTitle').textContent = t.forgotPasswordTitle;
        $('forgotPasswordInstructions').textContent = t.forgotPasswordInstructions;
        $('forgotPasswordForm').querySelector('label[for="forgotPasswordEmail"]').textContent = t.email + ":";
        $('sendRecoveryEmail').textContent = t.sendRecoveryEmail;
        $('backToLoginFromForgot').textContent = t.backToLogin;
        $('forgotPasswordMessage').textContent = "";
        $('forgotPasswordError').textContent = "";

        // Profile section info
        $('profileUsernameLabel').textContent = t.username + ":";
        $('profileCountryLabel').textContent = t.country + ":";
        $('profileRankingPlaceLabel').textContent = t.rankingXPPlace + " ";
        $('profileXPLabel').childNodes[0].nodeValue = "XP: ";
        $('profileLevelLabel').childNodes[0].nodeValue = "Level: ";
        $('profileFriendsCountLabel').childNodes[0].nodeValue = "Friends: ";
        $('profileGoldLabel').childNodes[0].nodeValue = "Gold: ";


        // Profile tabs buttons
        $('gamesTabButton').textContent = t.games;
        $('marketplaceTabButton').textContent = t.marketplace;
        $('buildTabButton').textContent = t.build;
        $('newGameTabButton').textContent = t.newGame;
        $('newsTabButton').textContent = t.news;
        $('rankingTabButton').textContent = t.ranking;
        $('postsTabButton').textContent = t.posts;
        $('friendsTabButton').textContent = t.friends;
        $('btnLogout').textContent = t.logout;
        $('checkThisBtn').textContent = t.checkThis;

        // Tab content titles and descriptions
        $('gamesTabTitle').textContent = t.games;
        $('gamesWelcomeText').textContent = t.gamesWelcomeText || "Welcome to your games! Start a new adventure or continue an existing one.";
        $('startGameBtn').textContent = t.startNewGame;

        $('marketplaceTabTitle').textContent = t.marketplace;
        $('marketplaceDescription').textContent = t.marketplaceDescription || "Buy and sell items, weapons, and armor here.";

        $('buildTabTitle').textContent = t.build;
        $('buildDescription').textContent = t.buildDescription || "Craft new items or build your base.";

        $('newGameTabTitle').textContent = t.newGame;
        $('newGameDescription').textContent = t.newGameDescription || "Choose your game type and begin a new journey.";

        $('newsTabTitle').textContent = t.news;
        $('newsDescription').textContent = t.newsDescription || "Stay updated with the latest game news and community announcements.";
        $('newsTab').querySelector('p:last-child').textContent = t.noNewsYet; // Add this line

        // Ranking tab title and buttons
        $('rankingTabTitle').textContent = t.ranking;
        $('overallRankingBtn').textContent = t.overallRanking;
        $('weeklyRankingBtn').textContent = t.weeklyRanking;
        $('monthlyRankingBtn').textContent = t.monthlyRanking;
        $('yearlyRankingBtn').textContent = t.yearlyRanking;
        $('globalRankingBtn').textContent = t.globalRankingCountry;

        // Ranking table headers
        const rankingHeaders = $('rankingTable').querySelectorAll('th');
        rankingHeaders[0].textContent = "Place";
        rankingHeaders[1].textContent = t.username;
        rankingHeaders[2].textContent = "XP";
        rankingHeaders[3].textContent = "Level";

        // Posts Tab
        $('postsTabTitle').textContent = t.postsTabTitle;
        $('writePostLabel').textContent = t.writePostLabel;
        $('postContent').placeholder = t.postContentPlaceholder;
        $('publishPostBtn').textContent = t.publishPostBtn;
        $('postMessage').textContent = ''; // Clear message

        // All Chats Section
        $('allChatsTitle').textContent = t.allChatsTitle;
        $('allChatsDescription').textContent = t.allChatsDescription;

        // Friends Tab
        $('friendsTabTitle').textContent = t.friends;
        $('friendSearchInput').placeholder = t.search;
        $('searchFriendBtn').textContent = t.search;
        $('myFriendsListTitle').textContent = t.myFriends;

        // Report User Modal
        $('reportUserModalHeader').childNodes[0].nodeValue = t.reportUserModalTitle + " "; // Add space
        $('reportReasonLabel').textContent = t.reportReason;
        $('sexualContentReason').textContent = t.sexualContent;
        $('hateSpeechReason').textContent = t.hateSpeech;
        $('personalDataReason').textContent = t.personalData;
        $('maliciousLinkReason').textContent = t.maliciousLink;
        $('threatsReason').textContent = t.threats;
        $('cheatingReason').textContent = t.cheating;
        $('adminImpersonationReason').textContent = t.adminImpersonation;
        $('passwordSharingReason').textContent = t.passwordSharing;
        $('otherReason').textContent = t.other;
        $('reportComment').placeholder = t.additionalComments;
        $('sendReportBtn').textContent = t.sendReport;

        // Re-render dynamic content that depends on language (like ranking table)
        const currentUser = getCurrentUser();
        if (currentUser && $('profileSection').classList.contains('active')) {
            renderProfile(currentUser);
            const activeRankingButton = $('rankingTypeButtons').querySelector('.active');
            if (activeRankingButton) {
                renderRankingTable(activeRankingButton.dataset.rankingType);
            }
            if ($('postsTab').classList.contains('active')) {
                renderPosts();
            }
            if ($('friendsTab').classList.contains('active')) {
                renderFriendsList(currentUser);
            }
        }
    }

    // --- Avatars for signup ---
    function renderAvatars() {
        const container = $('avatarsContainer');
        container.innerHTML = '';
        avatars.forEach(a => {
            const div = document.createElement('div');
            div.className = 'avatar';
            div.tabIndex = 0;
            div.dataset.avatarId = a.id;
            div.title = a.name;
            div.innerHTML = `<img src="${a.src}" alt="${a.name}"/><br>${a.name}`;
            container.appendChild(div);
        });
    }

    // --- LocalStorage user handling ---
    function getUsers() {
        let users = JSON.parse(localStorage.getItem('PoKreGaM_users') || '[]');
        const defaultXP = { xp: 0, xpWeekly: 0, xpMonthly: 0, xpYearly: 0 };
        const defaultUserProperties = {
            email: '',
            country: 'PL',
            birthdate: '2000-01-01',
            avatarId: 'avatar1',
            avatarName: 'Smily Boy',
            gold: 0,
            friends: [],
            ...defaultXP,
            lastWeeklyReset: new Date(0).toISOString(),
            lastMonthlyReset: new Date(0).toISOString(),
            lastYearlyReset: new Date(0).toISOString(),
            posts: [] // Ensure posts array exists for new users
        };

        let updatedUsers = false;
        users = users.map(user => {
            const newUser = { ...defaultUserProperties, ...user };

            // Initialize missing XP fields and reset dates for existing users
            if (newUser.xpWeekly === undefined) { newUser.xpWeekly = 0; updatedUsers = true; }
            if (newUser.xpMonthly === undefined) { newUser.xpMonthly = 0; updatedUsers = true; }
            if (newUser.xpYearly === undefined) { newUser.xpYearly = 0; updatedUsers = true; }
            if (newUser.lastWeeklyReset === undefined) { newUser.lastWeeklyReset = new Date(0).toISOString(); updatedUsers = true; }
            if (newUser.lastMonthlyReset === undefined) { newUser.lastMonthlyReset = new Date(0).toISOString(); updatedUsers = true; }
            if (newUser.lastYearlyReset === undefined) { newUser.lastYearlyReset = new Date(0).toISOString(); updatedUsers = true; }
            if (newUser.friends === undefined) { newUser.friends = []; updatedUsers = true; }
            if (newUser.posts === undefined) { newUser.posts = []; updatedUsers = true; } // Ensure posts exist

            // Clean up old 'daily' fields if they exist
            if (newUser.xpDaily !== undefined) { delete newUser.xpDaily; updatedUsers = true; }
            if (newUser.lastDailyReset !== undefined) { delete newUser.lastDailyReset; updatedUsers = true; }

            return newUser;
        });


        // Ensure "guest" account exists
        if (!users.some(u => u.username === 'guest')) {
            users.push({
                username: 'guest',
                password: 'Freeaccount',
                ...defaultUserProperties,
                avatarId: 'avatar1',
                avatarName: 'Smily Boy',
                xp: 50, xpWeekly: 10, xpMonthly: 20, xpYearly: 50,
                gold: 5,
                friends: [],
            });
            updatedUsers = true;
        }

        // Add more sample users for ranking and friends demo
        if (!users.some(u => u.username === 'testuser')) {
             users.push({
                username: 'testuser',
                email: 'test@example.com',
                country: 'US',
                password: 'testpassword',
                birthdate: '1990-05-15',
                avatarId: 'avatar2',
                avatarName: 'Warrior Girl',
                xp: 150, xpWeekly: 50, xpMonthly: 100, xpYearly: 150,
                gold: 50,
                friends: [], // Will be added by playerPL if bidirectional
            });
            updatedUsers = true;
        }
        if (!users.some(u => u.username === 'playerPL')) {
            users.push({
                username: 'playerPL',
                email: 'playerPL@example.com',
                country: 'PL',
                password: 'password',
                birthdate: '1995-01-01',
                avatarId: 'avatar3',
                avatarName: 'Zebra',
                xp: 200, xpWeekly: 70, xpMonthly: 120, xpYearly: 200,
                gold: 70,
                friends: ['testuser'], // Example friend, add testuser as friend
            });
            // Ensure testuser also has playerPL as friend if not already
            const testUser = users.find(u => u.username === 'testuser');
            if (testUser && !testUser.friends.includes('playerPL')) {
                testUser.friends.push('playerPL');
                updatedUsers = true;
            }
            updatedUsers = true;
        }
        if (!users.some(u => u.username === 'AnotherUserMK')) {
            users.push({
                username: 'AnotherUserMK',
                email: 'another@mk.com',
                country: 'MK',
                password: 'password123',
                birthdate: '1988-11-22',
                avatarId: 'avatar4',
                avatarName: 'King Of Water',
                xp: 100, xpWeekly: 30, xpMonthly: 60, xpYearly: 100,
                gold: 30,
                friends: [],
            });
            updatedUsers = true;
        }

        if (updatedUsers) {
            localStorage.setItem('PoKreGaM_users', JSON.stringify(users));
        }
        return users;
    }
    function saveUsers(users) {
        localStorage.setItem('PoKreGaM_users', JSON.stringify(users));
    }
    function getCurrentUser() {
        const username = localStorage.getItem('PoKreGaM_currentUser');
        if(!username) return null;
        const users = getUsers();
        return users.find(u => u.username === username) || null;
    }
    function setCurrentUser(username) {
        if(username) localStorage.setItem('PoKreGaM_currentUser', username);
        else localStorage.removeItem('PoKreGaM_currentUser');
    }

    // --- LocalStorage posts handling ---
    function getPosts() {
        // Posts are now stored globally, not per user.
        return JSON.parse(localStorage.getItem('PoKreGaM_posts') || '[]');
    }

    function savePosts(posts) {
        localStorage.setItem('PoKreGaM_posts', JSON.stringify(posts));
    }

    // --- Utilities ---
    function calculateLevel(xp) {
        return Math.floor(Math.sqrt(xp/10)) + 1;
    }

    // --- Kiritimati Time (UTC+14) Helpers ---
    function getKiritimatiDate() {
        const now = new Date();
        const utcNow = new Date(now.getTime() + now.getTimezoneOffset() * 60000); // Convert local time to UTC
        const kiritimatiTime = new Date(utcNow.getTime() + (14 * 3600 * 1000)); // Add 14 hours for UTC+14
        return kiritimatiTime;
    }

    function getKiritimatiDateComponents(dateObj) {
        // Ensure dateObj is a Date object
        if (!(dateObj instanceof Date)) {
            dateObj = new Date(dateObj);
        }

        const year = dateObj.getUTCFullYear();
        const month = dateObj.getUTCMonth(); // 0-11
        const day = dateObj.getUTCDate();
        const dayOfWeek = dateObj.getUTCDay(); // 0=Sunday, 6=Saturday

        // Calculate start of week (Monday in UTC+14)
        const startOfWeek = new Date(dateObj);
        const dayOffset = startOfWeek.getUTCDay(); // 0 (Sunday) to 6 (Saturday)
        const daysToMonday = (dayOffset === 0) ? 6 : dayOffset - 1; // Days to subtract to get to Monday
        startOfWeek.setUTCDate(startOfWeek.getUTCDate() - daysToMonday);
        startOfWeek.setUTCHours(0, 0, 0, 0); // Normalize to start of Monday

        return {
            year: year,
            month: month,
            day: day,
            startOfWeekISO: startOfWeek.toISOString().split('T')[0] // YYYY-MM-DD of Monday
        };
    }

    // --- Ranking Reset Logic ---
    function handleRankingResets() {
        let resetDates = JSON.parse(localStorage.getItem('PoKreGaM_lastResetDates') || '{}');
        let users = getUsers(); // Get current users
        let changed = false;

        const kiritimatiNow = getKiritimatiDate();
        const currentComponents = getKiritimatiDateComponents(kiritimatiNow);

        const nowISO = kiritimatiNow.toISOString();

        // Initialize resetDates if they don't exist or are set to epoch
        if (!resetDates.weekly || new Date(resetDates.weekly).getTime() === new Date(0).getTime()) {
            resetDates.weekly = nowISO;
            changed = true;
        }
        if (!resetDates.monthly || new Date(resetDates.monthly).getTime() === new Date(0).getTime()) {
            resetDates.monthly = nowISO;
            changed = true;
        }
        if (!resetDates.yearly || new Date(resetDates.yearly).getTime() === new Date(0).getTime()) {
            resetDates.yearly = nowISO;
            changed = true;
        }

        // Weekly Reset
        const lastWeeklyResetDate = new Date(resetDates.weekly);
        const lastWeeklyComponents = getKiritimatiDateComponents(lastWeeklyResetDate);
        if (lastWeeklyComponents.startOfWeekISO !== currentComponents.startOfWeekISO) {
            users.forEach(user => user.xpWeekly = 0);
            resetDates.weekly = nowISO;
            changed = true;
            console.log('Weekly XP reset.');
        }

        // Monthly Reset
        const lastMonthlyResetDate = new Date(resetDates.monthly);
        const lastMonthlyComponents = getKiritimatiDateComponents(lastMonthlyResetDate);
        if (lastMonthlyComponents.year !== currentComponents.year ||
            lastMonthlyComponents.month !== currentComponents.month) {
            users.forEach(user => user.xpMonthly = 0);
            resetDates.monthly = nowISO;
            changed = true;
            console.log('Monthly XP reset.');
        }

        // Yearly Reset
        const lastYearlyResetDate = new Date(resetDates.yearly);
        const lastYearlyComponents = getKiritimatiDateComponents(lastYearlyResetDate);
        if (lastYearlyComponents.year !== currentComponents.year) {
            users.forEach(user => user.xpYearly = 0);
            resetDates.yearly = nowISO;
            changed = true;
            console.log('Yearly XP reset.');
        }

        // Clean up old 'daily' reset entry if it exists
        if (resetDates.daily !== undefined) {
            delete resetDates.daily;
            changed = true;
        }

        if (changed) {
            saveUsers(users); // Save users with reset XP
            localStorage.setItem('PoKreGaM_lastResetDates', JSON.stringify(resetDates));
        }
    }


    // --- Render profile ---
    function renderProfile(user) {
        if(!user) return;
        $('profileAvatar').querySelector('img').src = avatars.find(a => a.id === user.avatarId)?.src || '';
        $('profileAvatar').querySelector('img').alt = user.avatarName || 'User avatar';
        $('profileUsername').textContent = sanitize(user.username);
        $('profileCountry').textContent = sanitize(user.country);
        $('profileXP').textContent = user.xp;
        $('profileFriendsCount').textContent = user.friends?.length || 0;
        $('profileGold').textContent = user.gold;
        $('profileLevel').textContent = calculateLevel(user.xp);
        // Ranking place calculation (uses overall XP for profile header)
        const users = getUsers().sort((a,b) => b.xp - a.xp);
        const place = users.findIndex(u => u.username === user.username) + 1;
        $('profileRankingPlace').textContent = place;

        // Show/hide "Check this" button for guest
        if (user.username === 'guest') {
            show($('checkThisBtn'));
        } else {
            hide($('checkThisBtn'));
        }
    }

    // --- Render ranking table ---
    function renderRankingTable(rankingType = 'overall') { // Default to overall
        const tbody = $('rankingTable').querySelector('tbody');
        let users = getUsers();
        const currentUser = getCurrentUser();

        // Filter for global (by country) ranking
        if (rankingType === 'global' && currentUser) {
            users = users.filter(user => user.country === currentUser.country);
        }

        // Determine which XP field to use for sorting
        let xpField = 'xp'; // Default to overall XP
        if (rankingType === 'weekly') xpField = 'xpWeekly';
        else if (rankingType === 'monthly') xpField = 'xpMonthly';
        else if (rankingType === 'yearly') xpField = 'xpYearly';
        // If rankingType is 'overall' or 'global', it already points to 'xp'

        // Sort users by the selected XP field
        users.sort((a, b) => b[xpField] - a[xpField]);

        tbody.innerHTML = '';
        users.forEach((u, i) => {
            const tr = document.createElement('tr');
            // Add "Report" button if the user is not the current user
            const reportButtonHtml = (currentUser && u.username !== currentUser.username) ?
                `<button class="report-user-btn" data-username="${sanitize(u.username)}">${LANG[currentLang].reportUser}</button>` : '';

            tr.innerHTML = `
                <td>${i+1}</td>
                <td>${sanitize(u.username)} ${reportButtonHtml}</td>
                <td>${u[xpField]}</td>
                <td>${calculateLevel(u[xpField])}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Render posts ---
    function renderPosts() {
        const communityPostsDiv = $('communityPosts');
        communityPostsDiv.innerHTML = ''; // Clear previous posts
        const posts = getPosts().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort newest first

        if (posts.length === 0) {
            communityPostsDiv.innerHTML = `<p style="text-align: center; color: #888;">${LANG[currentLang].noPostsYet}</p>`;
            return;
        }

        posts.forEach(post => {
            const postDiv = document.createElement('div');
            postDiv.classList.add('post');

            const user = getUsers().find(u => u.username === post.username);
            const avatarSrc = user ? avatars.find(a => a.id === user.avatarId)?.src : '';
            const avatarAlt = user ? user.avatarName : 'Unknown';

            postDiv.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar">
                        <img src="${avatarSrc}" alt="${avatarAlt}">
                    </div>
                    <div class="post-info">
                        <div class="post-author">${sanitize(post.username)}</div>
                        <div class="post-time">${new Date(post.timestamp).toLocaleString(currentLang)}</div>
                    </div>
                </div>
                <div class="post-content">${sanitize(post.content)}</div>
            `;
            communityPostsDiv.appendChild(postDiv);
        });
    }


    // --- Clear inputs ---
    function clearInputs(form) {
        form.querySelectorAll('input').forEach(i => i.value = '');
        form.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
        form.querySelectorAll('textarea').forEach(t => t.value = '');
    }

    // --- Show/hide sections ---
    function showSection(sectionElement) {
        // Hide all main sections
        ['loginSection', 'signUpSection', 'profileSection', 'allChatsSection', 'forgotPasswordSection'].forEach(id => {
            hide($(id));
        });
        // Show the requested section
        show(sectionElement);
    }

    // --- Render all chats for guest ---
    function renderAllChats() {
        const chatsContent = $('chatsContent');
        chatsContent.innerHTML = ''; // Clear previous content

        allChats.forEach(chat => {
            const chatContainer = document.createElement('div');
            chatContainer.classList.add('chat-container');

            let headerText = '';
            if (chat.type === 'private') {
                headerText = `Private Chat (${chat.participants.map(p => sanitize(p)).join(' & ')})`;
            } else if (chat.type === 'game') {
                headerText = `Game Chat: ${sanitize(chat.game)}`;
            }

            const chatHeader = document.createElement('div');
            chatHeader.classList.add('chat-header');
            chatHeader.textContent = headerText;
            chatContainer.appendChild(chatHeader);

            chat.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message');
                messageDiv.innerHTML = `[${msg.time}] <strong>${sanitize(msg.sender)}:</strong> ${sanitize(msg.text)}`;
                chatContainer.appendChild(messageDiv);
            });
            chatsContent.appendChild(chatContainer);
        });
    }

    // --- Friends Tab Functions (NEW) ---
    function renderFriendsList(user) {
        const myFriendsList = $('myFriendsList');
        myFriendsList.innerHTML = '';
        if (!user || !user.friends || user.friends.length === 0) {
            myFriendsList.innerHTML = `<li>${LANG[currentLang].noFriendsYet}</li>`;
            return;
        }
        user.friends.forEach(friendUsername => {
            const li = document.createElement('li');
            li.textContent = sanitize(friendUsername);
            myFriendsList.appendChild(li);
        });
    }

    function renderFriendSearchResults(results) {
        const searchResultsDiv = $('friendSearchResults');
        searchResultsDiv.innerHTML = '';
        if (results.length === 0) {
            searchResultsDiv.innerHTML = `<p>${LANG[currentLang].noSearchResults}</p>`;
            return;
        }
        results.forEach(foundUser => {
            const currentUser = getCurrentUser();
            const div = document.createElement('div');
            div.classList.add('user-card');
            div.innerHTML = `
                <span>${sanitize(foundUser.username)}</span>
                <button class="add-friend-btn" data-username="${sanitize(foundUser.username)}">${LANG[currentLang].addFriend}</button>
            `;
            // Disable button if it's the current user or already a friend
            if (foundUser.username === currentUser.username || currentUser.friends.includes(foundUser.username)) {
                div.querySelector('.add-friend-btn').disabled = true;
                if (foundUser.username === currentUser.username) {
                     div.querySelector('.add-friend-btn').textContent = LANG[currentLang].cannotAddSelf;
                } else if (currentUser.friends.includes(foundUser.username)) {
                     div.querySelector('.add-friend-btn').textContent = LANG[currentLang].alreadyFriends;
                }
            }
            searchResultsDiv.appendChild(div);
        });
    }


    // --- Selected avatar for signup ---
    let selectedAvatarId = null;

    // --- Init app ---
    function init() {
        // Ensure user data structure is up-to-date and apply resets
        getUsers(); // This call also updates old user objects and adds sample users
        handleRankingResets(); // Apply any necessary XP resets based on Kiritimati time

        // Fill avatars
        renderAvatars();

        // On avatar click
        $('avatarsContainer').addEventListener('click', e => {
            let target = e.target;
            while(target && !target.classList.contains('avatar')) {
                target = target.parentElement;
            }
            if(target) {
                // Remove previous selection
                document.querySelectorAll('.avatar.selected').forEach(el => el.classList.remove('selected'));
                target.classList.add('selected');
                selectedAvatarId = target.dataset.avatarId;
            }
        });
        // Also keyboard select avatar
        $('avatarsContainer').addEventListener('keydown', e => {
            if(e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                e.target.click();
            }
        });

        // Show login form initially or profile if logged in
        const currentUser = getCurrentUser();
        if(currentUser) {
            showSection($('profileSection'));
            renderProfile(currentUser);
            renderRankingTable('overall'); // Render default overall ranking
            // Activate default tab, e.g., games
            activateTab('gamesTab');
        } else {
            showSection($('loginSection'));
        }

        // Language selection
        const langSelector = $('languageSelector');
        currentLang = langSelector.value;
        translateUI(currentLang);
        langSelector.addEventListener('change', () => {
            currentLang = langSelector.value;
            translateUI(currentLang);
            // Re-render things that depend on dynamic text after language change
            const user = getCurrentUser();
            if (user) {
                renderProfile(user); // Profile header XP ranking place
                const activeRankingButton = $('rankingTypeButtons').querySelector('.active');
                if (activeRankingButton) {
                    renderRankingTable(activeRankingButton.dataset.rankingType);
                }
                renderPosts();
                renderFriendsList(user);
            }
        });

        // Navigation tabs for profile section
        $('tabs').addEventListener('click', e => {
            if(e.target.tagName !== 'BUTTON') return;
            const tabButton = e.target; // Renamed to avoid confusion with data-tab ID

            // Handle "Check this" button click (special case)
            if (tabButton.id === 'checkThisBtn') {
                const currentUser = getCurrentUser();
                if (currentUser && currentUser.username === 'guest') {
                    showSection($('allChatsSection'));
                    renderAllChats();
                }
                return;
            }

            // Exclude logout button from tab activation logic
            if (tabButton.id === 'btnLogout') {
                return;
            }

            // Deactivate all tab buttons and hide all tab contents
            $('tabs').querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            document.querySelectorAll('.tabContent').forEach(content => hide(content));

            // Activate clicked tab button and show its content
            tabButton.classList.add('active');
            tabButton.setAttribute('aria-selected', 'true');
            const targetContentId = tabButton.dataset.tab; // Get the ID of the content div
            if(targetContentId) {
                show($(targetContentId));
                if (targetContentId === 'rankingTab') {
                    handleRankingResets(); // Re-check for resets when entering ranking tab
                    // Default to overall ranking when ranking tab is opened
                    $('overallRankingBtn').click(); // Simulate click on overall ranking button
                }
                if (targetContentId === 'postsTab') {
                    renderPosts();
                }
                if (targetContentId === 'friendsTab') {
                    renderFriendsList(getCurrentUser());
                    $('friendSearchResults').innerHTML = '';
                    $('friendSearchInput').value = '';
                }
            }
        });

        // Nav buttons in header (simulate switching main content to profile tabs)
        $('navGames').addEventListener('click', () => {
            const currentUser = getCurrentUser();
            if (currentUser) {
                showSection($('profileSection'));
                activateTab('gamesTab');
            } else {
                showSection($('loginSection'));
            }
        });
        $('navMarketplace').addEventListener('click', () => {
            const currentUser = getCurrentUser();
            if (currentUser) {
                showSection($('profileSection'));
                activateTab('marketplaceTab');
            } else {
                showSection($('loginSection'));
            }
        });
        $('navBuild').addEventListener('click', () => {
            const currentUser = getCurrentUser();
            if (currentUser) {
                showSection($('profileSection'));
                activateTab('buildTab');
            } else {
                showSection($('loginSection'));
            }
        });
        $('navNews').addEventListener('click', () => {
            const currentUser = getCurrentUser();
            if (currentUser) {
                showSection($('profileSection'));
                activateTab('newsTab');
            } else {
                showSection($('loginSection'));
            }
        });
        $('navRanking').addEventListener('click', () => {
            const currentUser = getCurrentUser();
            if (currentUser) {
                showSection($('profileSection'));
                activateTab('rankingTab');
            } else {
                showSection($('loginSection'));
            }
        });


        // Activate tab helper
        function activateTab(tabId) { // Changed parameter name
            // Deactivate all tab buttons and hide all tab contents
            $('tabs').querySelectorAll('button').forEach(btn => {
                if (btn.id !== 'checkThisBtn' && btn.id !== 'btnLogout') {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                }
            });
            document.querySelectorAll('.tabContent').forEach(content => hide(content));

            // Activate the specified tab button and show its content
            const targetButton = $(`${tabId}Button`); // Assume buttons have ID like "gamesTabButton"
            if (targetButton) {
                targetButton.classList.add('active');
                targetButton.setAttribute('aria-selected', 'true');
            }
            const targetContent = $(tabId); // Target content div has ID like "gamesTab"
            if (targetContent) {
                show(targetContent);
                // Call specific render functions if needed
                if (tabId === 'rankingTab') {
                    handleRankingResets();
                    $('overallRankingBtn').click(); // Default to overall
                } else if (tabId === 'postsTab') {
                    renderPosts();
                } else if (tabId === 'friendsTab') {
                    renderFriendsList(getCurrentUser());
                    $('friendSearchResults').innerHTML = '';
                    $('friendSearchInput').value = '';
                }
            }
        }


        // Login form submission
        $('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = $('loginUsername').value.trim();
            const password = $('loginPassword').value.trim();
            const users = getUsers();
            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                setCurrentUser(user.username);
                renderProfile(user);
                showSection($('profileSection'));
                clearInputs($('loginForm'));
                $('loginError').textContent = '';
                // Activate games tab by default after login
                activateTab('gamesTab');
            } else {
                $('loginError').textContent = LANG[currentLang].loginError;
            }
        });

        // Sign Up form submission
        $('signUpForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = $('signUpUsername').value.trim();
            const email = $('signUpEmail').value.trim();
            const country = $('signUpCountry').value;
            const password = $('signUpPassword').value.trim();
            const birthdate = $('signUpBirthdate').value;

            if (!username || !password || !country || !birthdate || !selectedAvatarId) {
                $('signUpError').textContent = LANG[currentLang].signUpError;
                return;
            }

            let users = getUsers();
            if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) { // Case-insensitive check
                $('signUpError').textContent = `Username "${username}" already exists.`;
                return;
            }
            if (email && users.some(u => u.email === email)) {
                $('signUpError').textContent = `Email "${email}" is already registered.`;
                return;
            }


            const selectedAvatar = avatars.find(a => a.id === selectedAvatarId);
            const newUser = {
                username,
                password,
                email,
                country,
                birthdate,
                avatarId: selectedAvatar.id,
                avatarName: selectedAvatar.name,
                xp: 0,
                xpWeekly: 0,
                xpMonthly: 0,
                xpYearly: 0,
                gold: 0,
                friends: [],
                lastWeeklyReset: getKiritimatiDate().toISOString(),
                lastMonthlyReset: getKiritimatiDate().toISOString(),
                lastYearlyReset: getKiritimatiDate().toISOString(),
            };
            users.push(newUser);
            saveUsers(users);

            setCurrentUser(newUser.username);
            renderProfile(newUser);
            showSection($('profileSection'));
            clearInputs($('signUpForm'));
            $('signUpError').textContent = '';
            document.querySelectorAll('.avatar.selected').forEach(el => el.classList.remove('selected'));
            selectedAvatarId = null;
            activateTab('gamesTab');
        });

        // Forgot Password form submission
        $('forgotPasswordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = $('forgotPasswordEmail').value.trim();
            let users = getUsers();
            const user = users.find(u => u.email === email);

            if (user) {
                // Simulate sending email with details
                $('forgotPasswordMessage').textContent = LANG[currentLang].recoveryEmailSent
                    .replace('{username}', sanitize(user.username))
                    .replace('{password}', sanitize(user.password));
                $('forgotPasswordError').textContent = '';
            } else {
                $('forgotPasswordError').textContent = LANG[currentLang].recoveryEmailNotFound;
                $('forgotPasswordMessage').textContent = '';
            }
        });

        // Logout button
        $('btnLogout').addEventListener('click', () => {
            setCurrentUser(null);
            showSection($('loginSection'));
            clearInputs($('loginForm'));
            $('loginError').textContent = '';
        });

        // Link to signup from login
        $('toSignUp').addEventListener('click', () => {
            showSection($('signUpSection'));
            clearInputs($('loginForm'));
            $('loginError').textContent = '';
        });

        // Link to login from signup
        $('toLogin').addEventListener('click', () => {
            showSection($('loginSection'));
            clearInputs($('signUpForm'));
            $('signUpError').textContent = '';
            document.querySelectorAll('.avatar.selected').forEach(el => el.classList.remove('selected'));
            selectedAvatarId = null;
        });

        // Link to forgot password from login
        $('forgotPasswordLink').addEventListener('click', () => {
            showSection($('forgotPasswordSection'));
            clearInputs($('loginForm'));
            $('loginError').textContent = '';
        });

        // Link back to login from forgot password
        $('backToLoginFromForgot').addEventListener('click', () => {
            showSection($('loginSection'));
            clearInputs($('forgotPasswordForm'));
            $('forgotPasswordMessage').textContent = '';
            $('forgotPasswordError').textContent = '';
        });

        // Ranking type buttons (Overall, Weekly, Monthly, Yearly, Global)
        $('rankingTypeButtons').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                $('rankingTypeButtons').querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                const rankingType = e.target.dataset.rankingType;
                renderRankingTable(rankingType);
            }
        });

        // Simulate gaining XP by starting a new game
        $('startGameBtn').addEventListener('click', () => {
            let currentUser = getCurrentUser();
            if (currentUser) {
                let users = getUsers();
                let userIndex = users.findIndex(u => u.username === currentUser.username);

                if (userIndex !== -1) {
                    const xpGain = 10;
                    users[userIndex].xp += xpGain;
                    users[userIndex].xpWeekly += xpGain;
                    users[userIndex].xpMonthly += xpGain;
                    users[userIndex].xpYearly += xpGain;
                    users[userIndex].gold += 1;
                    saveUsers(users);
                    // Update currentUser in localStorage to reflect changes immediately
                    setCurrentUser(users[userIndex].username);
                    renderProfile(users[userIndex]);
                    alert(`You gained ${xpGain} XP and 1 Gold!`);
                    // If currently on ranking tab, re-render it
                    if ($('rankingTab').classList.contains('active')) {
                        const activeRankingButton = $('rankingTypeButtons').querySelector('.active');
                        renderRankingTable(activeRankingButton.dataset.rankingType);
                    }
                }
            }
        });

        // Publish Post functionality
        $('publishPostBtn').addEventListener('click', () => { // Corrected ID from submitPostBtn to publishPostBtn
            const postContent = $('postContent').value.trim();
            if (postContent === '') {
                $('postMessage').textContent = LANG[currentLang].postEmpty;
                $('postMessage').style.color = '#dc3545';
                setTimeout(() => $('postMessage').textContent = '', 3000); // Clear message after 3 seconds
                return;
            }

            const currentUser = getCurrentUser();
            if (currentUser) {
                const posts = getPosts();
                const newPost = {
                    username: currentUser.username,
                    content: postContent,
                    timestamp: new Date().toISOString()
                };
                posts.push(newPost);
                savePosts(posts);
                renderPosts();
                $('postContent').value = ''; // Clear textarea
                $('postMessage').textContent = LANG[currentLang].postPublished;
                $('postMessage').style.color = '#28a745';
                setTimeout(() => $('postMessage').textContent = '', 3000); // Clear message after 3 seconds
            } else {
                $('postMessage').textContent = 'Please login to post.';
                $('postMessage').style.color = '#dc3545';
                setTimeout(() => $('postMessage').textContent = '', 3000); // Clear message after 3 seconds
            }
        });


        // NEW: Friends Search and Add Friend
        $('searchFriendBtn').addEventListener('click', () => {
            const searchTerm = $('friendSearchInput').value.trim().toLowerCase();
            if (searchTerm.length < 2) {
                renderFriendSearchResults([]);
                return;
            }
            const users = getUsers();
            const currentUser = getCurrentUser();
            const results = users.filter(user =>
                user.username.toLowerCase().includes(searchTerm) && user.username !== currentUser.username
            );
            renderFriendSearchResults(results);
        });

        $('friendSearchResults').addEventListener('click', e => {
            if (e.target.classList.contains('add-friend-btn')) {
                const friendUsername = e.target.dataset.username;
                let users = getUsers();
                let currentUser = users.find(u => u.username === getCurrentUser().username);
                let friendUser = users.find(u => u.username === friendUsername);

                if (currentUser && friendUser && !currentUser.friends.includes(friendUsername)) {
                    currentUser.friends.push(friendUsername);
                    // Also add current user to friend's friends list for symmetry
                    if (!friendUser.friends.includes(currentUser.username)) {
                        friendUser.friends.push(currentUser.username);
                    }
                    saveUsers(users);
                    // Update current user in localStorage to reflect friends list changes
                    setCurrentUser(currentUser.username);
                    renderProfile(currentUser); // Update friend count in profile header
                    renderFriendsList(currentUser); // Update friends list
                    // Re-render search results to disable the button
                    const searchTerm = $('friendSearchInput').value.trim().toLowerCase();
                    const results = users.filter(user =>
                        user.username.toLowerCase().includes(searchTerm) && user.username !== currentUser.username
                    );
                    renderFriendSearchResults(results);

                    alert(LANG[currentLang].friendAdded.replace('{username}', sanitize(friendUsername)));
                }
            }
        });

        // NEW: Report User Modal Logic
        const reportUserModal = $('reportUserModal');
        const reportForm = $('reportForm');
        const reportUsernameTarget = $('reportUsernameTarget');
        const reportMessage = $('reportMessage');
        let targetUserForReport = null; // Stores the username of the user being reported

        // Listener for dynamic "Report" buttons (e.g., in ranking table)
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('report-user-btn')) {
                targetUserForReport = e.target.dataset.username;
                const currentUser = getCurrentUser();
                if (!currentUser) { // Ensure user is logged in to report
                    alert(LANG[currentLang].loginError); // Or redirect to login
                    return;
                }
                if (targetUserForReport === currentUser.username) {
                    alert(LANG[currentLang].reportCannotReportSelf);
                    return;
                }
                reportUsernameTarget.textContent = sanitize(targetUserForReport);
                reportMessage.textContent = ''; // Clear previous messages
                reportMessage.style.color = ''; // Reset color
                reportForm.reset(); // Clear form inputs
                show(reportUserModal);
            }
        });

        // Closing the modal
        reportUserModal.querySelector('.close-button').addEventListener('click', () => {
            hide(reportUserModal);
        });

        // Closing the modal by clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === reportUserModal) {
                hide(reportUserModal);
            }
        });

        // Handling the report form submission
        reportForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedReason = reportForm.querySelector('input[name="reportReason"]:checked');
            const comment = $('reportComment').value.trim();

            if (!selectedReason) {
                reportMessage.textContent = LANG[currentLang].reportNoReason;
                reportMessage.style.color = '#dc3545';
                return;
            }

            const reportDetails = {
                reporter: getCurrentUser().username,
                reportedUser: targetUserForReport,
                reason: selectedReason.value,
                comment: comment,
                timestamp: new Date().toISOString()
            };

            // In a real application, this data would be sent to a server.
            // For this simulation, we'll just log it and show a success message.
            console.log("User Report:", reportDetails);

            reportMessage.textContent = LANG[currentLang].reportSuccess;
            reportMessage.style.color = '#28a745';
            reportForm.reset(); // Clear form
            targetUserForReport = null; // Clear reported user target

            setTimeout(() => {
                hide(reportUserModal);
                reportMessage.textContent = ''; // Clear success message after modal closes
                reportMessage.style.color = ''; // Reset color
            }, 2000); // Close modal after 2 seconds
        });

    } // End of init()

    // Initialize the app when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
